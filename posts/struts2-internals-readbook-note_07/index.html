<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <title>Struts2 运行流程分析之doFilter - Dean&#39;s notes</title>
  <meta property="og:title" content="Struts2 运行流程分析之doFilter - Dean&#39;s notes" />
  <meta name="twitter:title" content="Struts2 运行流程分析之doFilter - Dean&#39;s notes" />
  <meta name="description" content="注意: 本文基于Struts2.2.1版本进行的代码分析
 首先先大致看一下StrutsPrepareAndExecuteFilter.java的doFilter的实现
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45  public void doFilter(ServletRequest req, ServletResponse res, FilterChain chain) throws IOException, ServletException { HttpServletRequest request = (HttpServletRequest) req; HttpServletResponse response = (HttpServletResponse) res; try { // 设置request/response编码  prepare.">
  <meta property="og:description" content="注意: 本文基于Struts2.2.1版本进行的代码分析
 首先先大致看一下StrutsPrepareAndExecuteFilter.java的doFilter的实现
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45  public void doFilter(ServletRequest req, ServletResponse res, FilterChain chain) throws IOException, ServletException { HttpServletRequest request = (HttpServletRequest) req; HttpServletResponse response = (HttpServletResponse) res; try { // 设置request/response编码  prepare.">
  <meta name="twitter:description" content="注意: 本文基于Struts2.2.1版本进行的代码分析
 首先先大致看一下StrutsPrepareAndExecuteFilter.java的doFilter的实现
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 …">
  <meta name="author" content="Dean"/>
  <meta property="og:site_name" content="Dean&#39;s notes" />
  <meta property="og:url" content="https://dean2021.github.io/posts/struts2-internals-readbook-note_07/" />
  <meta property="og:type" content="article" />
  <meta name="twitter:card" content="summary" />
  <meta name="generator" content="Hugo 0.52" />

  <link rel="stylesheet" href="/css/style.css" media="all" />
  <link rel="stylesheet" href="/css/syntax.css" media="all" />
  <link rel="stylesheet" href="/css/custom.css" media="all" />

  <script src="/js/script.js"></script>
  <script src="/js/custom.js"></script>
  <script defer src="/js/fontawesome.js"></script>
</head>

<body>

<header class="site-header">
  <nav class="site-navi">
    <h1 class="site-title"><a href="/">Dean&#39;s notes</a></h1>
    <ul class="site-navi-items">
      <li class="site-navi-item-home"><a href="/" title="Home">Home</a></li>
      <li class="site-navi-item-categories"><a href="/categories/" title="Categories">Categories</a></li>
      <li class="site-navi-item-tags"><a href="/tags/" title="Tags">Tags</a></li>
      <li class="site-navi-item-archives"><a href="/archives/" title="Archives">Archives</a></li>
      <li class="site-navi-item-books"><a href="/books/" title="Books">Books</a></li>
      <li class="site-navi-item-link"><a href="/link/" title="Links">Links</a></li>
      <li class="site-navi-item-about"><a href="/about/" title="About">About</a></li>

       <li class="site-navi-item-plan"><a href="/posts/plan/" title="plan">Plan</a></li>
    </ul>
  </nav>
</header>
<hr class="site-header-bottom">

  <div class="main" role="main">
    <article class="article">
      
      
      <h1 class="article-title">Struts2 运行流程分析之doFilter</h1>
      
      <hr class="article-title-bottom">
      <ul class="article-meta">
        <li class="article-meta-date"><time>December 12, 2018</time></li>
        <li class="article-meta-categories">
          <a href="/categories/java/">
            <i class="fas fa-folder"></i>
            java
          </a>&nbsp;
        </li>
        <li class="article-meta-categories">
          <a href="/categories/struts2-%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95/">
            <i class="fas fa-folder"></i>
            Struts2 技术内幕
          </a>&nbsp;
        </li>
        <li class="article-meta-tags">
          <a href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">
            <i class="fas fa-tag"></i>
            读书笔记
          </a>&nbsp;
        </li>
      </ul>
      

      

<blockquote>
<p>注意: 本文基于Struts2.2.1版本进行的代码分析</p>
</blockquote>

<p>首先先大致看一下StrutsPrepareAndExecuteFilter.java的doFilter的实现</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="o">(</span><span class="n">ServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="n">ServletResponse</span> <span class="n">res</span><span class="o">,</span> <span class="n">FilterChain</span> <span class="n">chain</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ServletException</span> <span class="o">{</span>

        <span class="n">HttpServletRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="o">(</span><span class="n">HttpServletRequest</span><span class="o">)</span> <span class="n">req</span><span class="o">;</span>
        <span class="n">HttpServletResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="o">(</span><span class="n">HttpServletResponse</span><span class="o">)</span> <span class="n">res</span><span class="o">;</span>

        <span class="k">try</span> <span class="o">{</span>

        	<span class="c1">// 设置request/response编码
</span><span class="c1"></span>            <span class="n">prepare</span><span class="o">.</span><span class="na">setEncodingAndLocale</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>

            <span class="c1">// 设置Action上下文
</span><span class="c1"></span>            <span class="n">prepare</span><span class="o">.</span><span class="na">createActionContext</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>

            <span class="c1">// 将当前Dispatcher加入线程管理,用于解决线程安全问题
</span><span class="c1"></span>            <span class="n">prepare</span><span class="o">.</span><span class="na">assignDispatcherToThread</span><span class="o">();</span>


            <span class="c1">// 排除拦截路径，具体在&lt;constant name=&#34;struts.action.excludePattern&#34; value=&#34;.*validcode.*,.*tohtml.*&#34;/&gt;中设置
</span><span class="c1"></span>			<span class="k">if</span> <span class="o">(</span> <span class="n">excludedPatterns</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">prepare</span><span class="o">.</span><span class="na">isUrlExcluded</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">excludedPatterns</span><span class="o">))</span> <span class="o">{</span>
				<span class="n">chain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
			<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>

				<span class="c1">// 对request进行封装
</span><span class="c1"></span>				<span class="n">request</span> <span class="o">=</span> <span class="n">prepare</span><span class="o">.</span><span class="na">wrapRequest</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>

				<span class="c1">// 根据Request的url获取映射的Action
</span><span class="c1"></span>				<span class="n">ActionMapping</span> <span class="n">mapping</span> <span class="o">=</span> <span class="n">prepare</span><span class="o">.</span><span class="na">findActionMapping</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>

				<span class="c1">// 找不到映射就认为是静态文件,继续下一个filter
</span><span class="c1"></span>				<span class="k">if</span> <span class="o">(</span><span class="n">mapping</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>

					<span class="kt">boolean</span> <span class="n">handled</span> <span class="o">=</span> <span class="n">execute</span><span class="o">.</span><span class="na">executeStaticResourceRequest</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
					<span class="k">if</span> <span class="o">(!</span><span class="n">handled</span><span class="o">)</span> <span class="o">{</span>
						<span class="n">chain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
					<span class="o">}</span>
				<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>

					<span class="c1">// 执行action
</span><span class="c1"></span>					<span class="n">execute</span><span class="o">.</span><span class="na">executeAction</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">mapping</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">prepare</span><span class="o">.</span><span class="na">cleanupRequest</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>上面对dofilter进行了简单分析,下面我们进行详细分析,先整理出几个点：</p>

<ol>
<li>设置request/response编码</li>
<li>设置Action上下文</li>
<li>Dispatcher加入线程管理</li>
<li>排除除拦截路径</li>
<li>对request进行封装</li>
<li>根据request获取action映射</li>
<li>执行Action</li>
</ol>

<h3 id="0x01-设置request-response编码">0x01 设置request/response编码</h3>

<p>首先看一下 prepare.setEncodingAndLocale(request, response); 的代码实现:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setEncodingAndLocale</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">dispatcher</span><span class="o">.</span><span class="na">prepare</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
    <span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>其实还是调用dispatcher对象, 我们继续看prepare的实现:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">prepare</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>


        <span class="n">String</span> <span class="n">encoding</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="c1">// 搜索代码defaultEncoding并没有被初始化设置
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">defaultEncoding</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">encoding</span> <span class="o">=</span> <span class="n">defaultEncoding</span><span class="o">;</span>
        <span class="o">}</span>


        <span class="n">Locale</span> <span class="n">locale</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

      
        <span class="k">if</span> <span class="o">(</span><span class="n">defaultLocale</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">locale</span> <span class="o">=</span> <span class="n">LocalizedTextUtil</span><span class="o">.</span><span class="na">localeFromString</span><span class="o">(</span><span class="n">defaultLocale</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getLocale</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">encoding</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>

            	<span class="c1">// 设置编码
</span><span class="c1"></span>                <span class="n">request</span><span class="o">.</span><span class="na">setCharacterEncoding</span><span class="o">(</span><span class="n">encoding</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">LOG</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&#34;Error setting character encoding to &#39;&#34;</span> <span class="o">+</span> <span class="n">encoding</span> <span class="o">+</span> <span class="s">&#34;&#39; - ignoring.&#34;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        
        <span class="c1">// 设置response编码
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">locale</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">response</span><span class="o">.</span><span class="na">setLocale</span><span class="o">(</span><span class="n">locale</span><span class="o">);</span>
        <span class="o">}</span>


        <span class="c1">// 该变量是根据struts.dispatcher.parametersWorkaround进行设置
</span><span class="c1"></span>        <span class="c1">// 对于某些Java EE服务器，不支持HttpServletRequest调用getParameterMap()方法，此时可以设置该属性值为true来解决该问题。
</span><span class="c1"></span>        <span class="c1">// 该属性的默认值是false。对于WebLogic、Orion和OC4J服务器，通常应该设置该属性为true。
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">paramsWorkaroundEnabled</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&#34;foo&#34;</span><span class="o">);</span> <span class="c1">// simply read any parameter (existing or not) to &#34;prime&#34; the request
</span><span class="c1"></span>        <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="0x02-设置action上下文">0x02 设置Action上下文</h3>

<p>prepare.createActionContext(request, response); 代码实现:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">    <span class="cm">/**
</span><span class="cm">     *
</span><span class="cm">     * 创建action的context和初始化本地线程
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">ActionContext</span> <span class="nf">createActionContext</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ActionContext</span> <span class="n">ctx</span><span class="o">;</span>

        <span class="c1">// 这个计数器是来干什么的？？？
</span><span class="c1"></span>        <span class="n">Integer</span> <span class="n">counter</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>

        <span class="c1">// 计数器累加
</span><span class="c1"></span>        <span class="n">Integer</span> <span class="n">oldCounter</span> <span class="o">=</span> <span class="o">(</span><span class="n">Integer</span><span class="o">)</span> <span class="n">request</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">CLEANUP_RECURSION_COUNTER</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">oldCounter</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">counter</span> <span class="o">=</span> <span class="n">oldCounter</span> <span class="o">+</span> <span class="n">1</span><span class="o">;</span>
        <span class="o">}</span>
        


        <span class="n">ActionContext</span> <span class="n">oldContext</span> <span class="o">=</span> <span class="n">ActionContext</span><span class="o">.</span><span class="na">getContext</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">oldContext</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// detected existing context, so we are probably in a forward
</span><span class="c1"></span>            <span class="n">ctx</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ActionContext</span><span class="o">(</span><span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;(</span><span class="n">oldContext</span><span class="o">.</span><span class="na">getContextMap</span><span class="o">()));</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>

            <span class="c1">// 创建ValueStack对象,关于该对象之前我们分析过, 
</span><span class="c1"></span>            <span class="c1">// ValueStack是XWork对OGNL的计算进行扩展的一个特殊的数据结构， 主要是对OGNL三要素中的Root对象进行扩展.
</span><span class="c1"></span>            <span class="n">ValueStack</span> <span class="n">stack</span> <span class="o">=</span> <span class="n">dispatcher</span><span class="o">.</span><span class="na">getContainer</span><span class="o">().</span><span class="na">getInstance</span><span class="o">(</span><span class="n">ValueStackFactory</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">createValueStack</span><span class="o">();</span>

            <span class="c1">// 首先看到的createContextMap是将Request对象转换成map上下文对象对象，具体我们下方分析.
</span><span class="c1"></span>            <span class="c1">// 并将这个context放进stack内，也就是放到root对象内
</span><span class="c1"></span>            <span class="n">stack</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">putAll</span><span class="o">(</span><span class="n">dispatcher</span><span class="o">.</span><span class="na">createContextMap</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">servletContext</span><span class="o">));</span>

            <span class="c1">//  初始化个Action上下文对象
</span><span class="c1"></span>            <span class="n">ctx</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ActionContext</span><span class="o">(</span><span class="n">stack</span><span class="o">.</span><span class="na">getContext</span><span class="o">());</span>
        <span class="o">}</span>


        <span class="c1">// 存放计数器        
</span><span class="c1"></span>        <span class="n">request</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="n">CLEANUP_RECURSION_COUNTER</span><span class="o">,</span> <span class="n">counter</span><span class="o">);</span>

        <span class="c1">// 设置当前线程的操作上下文
</span><span class="c1"></span>        <span class="n">ActionContext</span><span class="o">.</span><span class="na">setContext</span><span class="o">(</span><span class="n">ctx</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">ctx</span><span class="o">;</span>
    <span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>上面我们说到了createContextMap，我们看一下代码实现:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="cm">/**
</span><span class="cm"> * Create a context map containing all the wrapped request objects 
</span><span class="cm"> *
</span><span class="cm"> * @param request The servlet request
</span><span class="cm"> * @param response The servlet response
</span><span class="cm"> * @param mapping The action mapping
</span><span class="cm"> * @param context The servlet context
</span><span class="cm"> * @return A map of context objects
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">createContextMap</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span>
    <span class="n">ActionMapping</span> <span class="n">mapping</span><span class="o">,</span> <span class="n">ServletContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>

    <span class="c1">// 下方注释写的非常清晰，也就是对reqeust对象进行map封装（包括request的参数、session、等等）最后创建个上下文。
</span><span class="c1"></span>

    <span class="c1">// request map wrapping the http request objects
</span><span class="c1"></span>    <span class="n">Map</span> <span class="n">requestMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RequestMap</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>


    <span class="c1">// 下面注释写的都非常清晰，没有什么特殊关注点
</span><span class="c1"></span>
    <span class="c1">// parameters map wrapping the http parameters.  ActionMapping parameters are now handled and applied separately
</span><span class="c1"></span>    <span class="n">Map</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getParameterMap</span><span class="o">());</span>

    <span class="c1">// session map wrapping the http session
</span><span class="c1"></span>    <span class="n">Map</span> <span class="n">session</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SessionMap</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>

    <span class="c1">// application map wrapping the ServletContext
</span><span class="c1"></span>    <span class="n">Map</span> <span class="n">application</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ApplicationMap</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>

    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">extraContext</span> <span class="o">=</span> <span class="n">createContextMap</span><span class="o">(</span><span class="n">requestMap</span><span class="o">,</span> <span class="n">params</span><span class="o">,</span> <span class="n">session</span><span class="o">,</span> <span class="n">application</span><span class="o">,</span> <span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">context</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">mapping</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">extraContext</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">ServletActionContext</span><span class="o">.</span><span class="na">ACTION_MAPPING</span><span class="o">,</span> <span class="n">mapping</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">extraContext</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
</span><span class="cm"> * Merge all application and servlet attributes into a single &lt;tt&gt;HashMap&lt;/tt&gt; to represent the entire
</span><span class="cm"> * &lt;tt&gt;Action&lt;/tt&gt; context.
</span><span class="cm"> *
</span><span class="cm"> * @param requestMap     a Map of all request attributes.
</span><span class="cm"> * @param parameterMap   a Map of all request parameters.
</span><span class="cm"> * @param sessionMap     a Map of all session attributes.
</span><span class="cm"> * @param applicationMap a Map of all servlet context attributes.
</span><span class="cm"> * @param request        the HttpServletRequest object.
</span><span class="cm"> * @param response       the HttpServletResponse object.
</span><span class="cm"> * @param servletContext the ServletContextmapping object.
</span><span class="cm"> * @return a HashMap representing the &lt;tt&gt;Action&lt;/tt&gt; context.
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">createContextMap</span><span class="o">(</span><span class="n">Map</span> <span class="n">requestMap</span><span class="o">,</span>
                                <span class="n">Map</span> <span class="n">parameterMap</span><span class="o">,</span>
                                <span class="n">Map</span> <span class="n">sessionMap</span><span class="o">,</span>
                                <span class="n">Map</span> <span class="n">applicationMap</span><span class="o">,</span>
                                <span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span>
                                <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span>
                                <span class="n">ServletContext</span> <span class="n">servletContext</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">extraContext</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;();</span>
    <span class="n">extraContext</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">ActionContext</span><span class="o">.</span><span class="na">PARAMETERS</span><span class="o">,</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">(</span><span class="n">parameterMap</span><span class="o">));</span>
    <span class="n">extraContext</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">ActionContext</span><span class="o">.</span><span class="na">SESSION</span><span class="o">,</span> <span class="n">sessionMap</span><span class="o">);</span>
    <span class="n">extraContext</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">ActionContext</span><span class="o">.</span><span class="na">APPLICATION</span><span class="o">,</span> <span class="n">applicationMap</span><span class="o">);</span>

    <span class="n">Locale</span> <span class="n">locale</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">defaultLocale</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">locale</span> <span class="o">=</span> <span class="n">LocalizedTextUtil</span><span class="o">.</span><span class="na">localeFromString</span><span class="o">(</span><span class="n">defaultLocale</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getLocale</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">locale</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getLocale</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="n">extraContext</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">ActionContext</span><span class="o">.</span><span class="na">LOCALE</span><span class="o">,</span> <span class="n">locale</span><span class="o">);</span>
    <span class="c1">//extraContext.put(ActionContext.DEV_MODE, Boolean.valueOf(devMode));
</span><span class="c1"></span>
    <span class="n">extraContext</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">StrutsStatics</span><span class="o">.</span><span class="na">HTTP_REQUEST</span><span class="o">,</span> <span class="n">request</span><span class="o">);</span>
    <span class="n">extraContext</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">StrutsStatics</span><span class="o">.</span><span class="na">HTTP_RESPONSE</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
    <span class="n">extraContext</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">StrutsStatics</span><span class="o">.</span><span class="na">SERVLET_CONTEXT</span><span class="o">,</span> <span class="n">servletContext</span><span class="o">);</span>

    <span class="c1">// helpers to get access to request/session/application scope
</span><span class="c1"></span>    <span class="n">extraContext</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;request&#34;</span><span class="o">,</span> <span class="n">requestMap</span><span class="o">);</span>
    <span class="n">extraContext</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;session&#34;</span><span class="o">,</span> <span class="n">sessionMap</span><span class="o">);</span>
    <span class="n">extraContext</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;application&#34;</span><span class="o">,</span> <span class="n">applicationMap</span><span class="o">);</span>
    <span class="n">extraContext</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;parameters&#34;</span><span class="o">,</span> <span class="n">parameterMap</span><span class="o">);</span>

    <span class="n">AttributeMap</span> <span class="n">attrMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AttributeMap</span><span class="o">(</span><span class="n">extraContext</span><span class="o">);</span>
    <span class="n">extraContext</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;attr&#34;</span><span class="o">,</span> <span class="n">attrMap</span><span class="o">);</span>

    <span class="k">return</span> <span class="n">extraContext</span><span class="o">;</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>代码很直观，我们在Struts2的模板里用到的session对象就是在这里初始化的，例如</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-html" data-lang="html"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-html" data-lang="html"><span class="p">&lt;</span><span class="nt">s:property</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;#session.user.name&#34;</span><span class="p">&gt;</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="0x03-dispatcher加入线程管理">0x03 Dispatcher加入线程管理</h3>

<p>prepare.assignDispatcherToThread(); 代码实现:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="cm">/**
</span><span class="cm"> * 将调度程序分配给调度程序线程本地
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">assignDispatcherToThread</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">Dispatcher</span><span class="o">.</span><span class="na">setInstance</span><span class="o">(</span><span class="n">dispatcher</span><span class="o">);</span>
<span class="o">}</span>





<span class="c1">// Dispatcher.java
</span><span class="c1"></span>
<span class="cm">/**
</span><span class="cm"> * Provide a thread local instance.
</span><span class="cm"> */</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">Dispatcher</span><span class="o">&gt;</span> <span class="n">instance</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">Dispatcher</span><span class="o">&gt;();</span>

<span class="cm">/**
</span><span class="cm"> * Store the dispatcher instance for this thread.
</span><span class="cm"> *
</span><span class="cm"> * @param instance The instance
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">setInstance</span><span class="o">(</span><span class="n">Dispatcher</span> <span class="n">instance</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Dispatcher</span><span class="o">.</span><span class="na">instance</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">instance</span><span class="o">);</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="0x04-排除除拦截路径">0x04 排除除拦截路径</h3>

<p>prepare.isUrlExcluded(request, excludedPatterns) 实现代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">    <span class="cm">/**
</span><span class="cm">     * Check whether the request matches a list of exclude patterns.
</span><span class="cm">     *
</span><span class="cm">     * @param request          The request to check patterns against
</span><span class="cm">     * @param excludedPatterns list of patterns for exclusion
</span><span class="cm">     *
</span><span class="cm">     * @return &lt;tt&gt;true&lt;/tt&gt; if the request URI matches one of the given patterns
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isUrlExcluded</span><span class="o">(</span> <span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Pattern</span><span class="o">&gt;</span> <span class="n">excludedPatterns</span> <span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">excludedPatterns</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">getUri</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
            <span class="k">for</span> <span class="o">(</span> <span class="n">Pattern</span> <span class="n">pattern</span> <span class="o">:</span> <span class="n">excludedPatterns</span> <span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">pattern</span><span class="o">.</span><span class="na">matcher</span><span class="o">(</span><span class="n">uri</span><span class="o">).</span><span class="na">matches</span><span class="o">())</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>也就是个正则match, 我们看一下excludedPatterns是在哪里初始化的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StrutsPrepareAndExecuteFilter</span> <span class="kd">implements</span> <span class="n">StrutsStatics</span><span class="o">,</span> <span class="n">Filter</span> <span class="o">{</span>
    <span class="c1">// protected PrepareOperations prepare;
</span><span class="c1"></span>    <span class="c1">// protected ExecuteOperations execute;
</span><span class="c1"></span>	<span class="kd">protected</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Pattern</span><span class="o">&gt;</span> <span class="n">excludedPatterns</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">FilterConfig</span> <span class="n">filterConfig</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span> <span class="o">{</span>
        <span class="n">InitOperations</span> <span class="n">init</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InitOperations</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
           <span class="c1">// FilterHostConfig config = new FilterHostConfig(filterConfig);
</span><span class="c1"></span>           <span class="c1">//  init.initLogging(config);
</span><span class="c1"></span>           <span class="c1">//  Dispatcher dispatcher = init.initDispatcher(config);
</span><span class="c1"></span>           <span class="c1">//  init.initStaticContentLoader(config, dispatcher);
</span><span class="c1"></span>
          <span class="c1">//   prepare = new PrepareOperations(filterConfig.getServletContext(), dispatcher);
</span><span class="c1"></span>          <span class="c1">//   execute = new ExecuteOperations(filterConfig.getServletContext(), dispatcher);
</span><span class="c1"></span>	<span class="k">this</span><span class="o">.</span><span class="na">excludedPatterns</span> <span class="o">=</span> <span class="n">init</span><span class="o">.</span><span class="na">buildExcludedPatternsList</span><span class="o">(</span><span class="n">dispatcher</span><span class="o">);</span>

            <span class="c1">// postInit(dispatcher, filterConfig);
</span><span class="c1"></span>        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
           <span class="c1">//  init.cleanup();
</span><span class="c1"></span>        <span class="o">}</span>

    <span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>init.buildExcludedPatternsList(dispatcher);的实现代码:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="cm">/**
</span><span class="cm"> * Extract a list of patterns to exclude from request filtering
</span><span class="cm"> *
</span><span class="cm"> * @param dispatcher The dispatcher to check for exclude pattern configuration
</span><span class="cm"> *
</span><span class="cm"> * @return a List of Patterns for request to exclude if apply, or &lt;tt&gt;null&lt;/tt&gt;
</span><span class="cm"> *
</span><span class="cm"> * @see org.apache.struts2.StrutsConstants#STRUTS_ACTION_EXCLUDE_PATTERN
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Pattern</span><span class="o">&gt;</span> <span class="nf">buildExcludedPatternsList</span><span class="o">(</span> <span class="n">Dispatcher</span> <span class="n">dispatcher</span> <span class="o">)</span> <span class="o">{</span>

	<span class="c1">// 设置排除拦截路径
</span><span class="c1"></span>    <span class="k">return</span> <span class="n">buildExcludedPatternsList</span><span class="o">(</span><span class="n">dispatcher</span><span class="o">.</span><span class="na">getContainer</span><span class="o">().</span><span class="na">getInstance</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">StrutsConstants</span><span class="o">.</span><span class="na">STRUTS_ACTION_EXCLUDE_PATTERN</span><span class="o">));</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Pattern</span><span class="o">&gt;</span> <span class="nf">buildExcludedPatternsList</span><span class="o">(</span> <span class="n">String</span> <span class="n">patterns</span> <span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">patterns</span> <span class="o">&amp;&amp;</span> <span class="n">patterns</span><span class="o">.</span><span class="na">trim</span><span class="o">().</span><span class="na">length</span><span class="o">()</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Pattern</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Pattern</span><span class="o">&gt;();</span>
        <span class="n">String</span><span class="o">[]</span> <span class="n">tokens</span> <span class="o">=</span> <span class="n">patterns</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&#34;,&#34;</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span> <span class="n">String</span> <span class="n">token</span> <span class="o">:</span> <span class="n">tokens</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">Pattern</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="n">token</span><span class="o">.</span><span class="na">trim</span><span class="o">()));</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">Collections</span><span class="o">.</span><span class="na">unmodifiableList</span><span class="o">(</span><span class="n">list</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>看到是通过StrutsConstants.STRUTS_ACTION_EXCLUDE_PATTERN也就是struts.action.excludePattern配置的，如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;constant</span> <span class="na">name=</span><span class="s">&#34;struts.action.excludePattern&#34;</span> <span class="na">value=</span><span class="s">&#34;/res/.*,/css/.*,/images/.*,/js/.*,/services/.*&#34;</span> <span class="nt">/&gt;</span>  </code></pre></td></tr></table>
</div>
</div>
<h3 id="0x05-对request进行封装">0x05 对request进行封装</h3>

<p>request = prepare.wrapRequest(request); 代码实现:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">    <span class="cm">/**
</span><span class="cm">     * Wraps the request with the Struts wrapper that handles multipart requests better
</span><span class="cm">     * @return The new request, if there is one
</span><span class="cm">     * @throws ServletException
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">HttpServletRequest</span> <span class="nf">wrapRequest</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">oldRequest</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span> <span class="o">{</span>
        <span class="n">HttpServletRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="n">oldRequest</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// Wrap request first, just in case it is multipart/form-data
</span><span class="c1"></span>            <span class="c1">// parameters might not be accessible through before encoding (ww-1278)
</span><span class="c1"></span>            <span class="n">request</span> <span class="o">=</span> <span class="n">dispatcher</span><span class="o">.</span><span class="na">wrapRequest</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">servletContext</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&#34;Could not wrap servlet request with MultipartRequestWrapper!&#34;</span><span class="o">;</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">ServletException</span><span class="o">(</span><span class="n">message</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">request</span><span class="o">;</span>
    <span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>看一下  request = dispatcher.wrapRequest(request, servletContext); 的实现：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="cm">/**
</span><span class="cm"> * Wrap and return the given request or return the original request object.
</span><span class="cm"> * &lt;/p&gt;
</span><span class="cm"> * This method transparently handles multipart data as a wrapped class around the given request.
</span><span class="cm"> * Override this method to handle multipart requests in a special way or to handle other types of requests.
</span><span class="cm"> * Note, {@link org.apache.struts2.dispatcher.multipart.MultiPartRequestWrapper} is
</span><span class="cm"> * flexible - look first to that object before overriding this method to handle multipart data.
</span><span class="cm"> *
</span><span class="cm"> * @param request the HttpServletRequest object.
</span><span class="cm"> * @param servletContext Our ServletContext object
</span><span class="cm"> * @return a wrapped request or original request.
</span><span class="cm"> * @see org.apache.struts2.dispatcher.multipart.MultiPartRequestWrapper
</span><span class="cm"> * @throws java.io.IOException on any error.
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="n">HttpServletRequest</span> <span class="nf">wrapRequest</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">ServletContext</span> <span class="n">servletContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="c1">// don&#39;t wrap more than once
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">request</span> <span class="k">instanceof</span> <span class="n">StrutsRequestWrapper</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">request</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">String</span> <span class="n">content_type</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getContentType</span><span class="o">();</span>



    <span class="c1">// 如果request的header中content-type的value包含multipart/form-data
</span><span class="c1"></span>    <span class="c1">// 封装成MultiPartRequestWrapper对象
</span><span class="c1"></span>    <span class="c1">// 这部分代码太经典，s2-045安全漏洞就是从这里开始的
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">content_type</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">content_type</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="s">&#34;multipart/form-data&#34;</span><span class="o">)</span> <span class="o">!=</span> <span class="o">-</span><span class="n">1</span><span class="o">)</span> <span class="o">{</span>

        <span class="n">MultiPartRequest</span> <span class="n">mpr</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>


        <span class="c1">//check for alternate implementations of MultiPartRequest
</span><span class="c1"></span>        <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">multiNames</span> <span class="o">=</span> <span class="n">getContainer</span><span class="o">().</span><span class="na">getInstanceNames</span><span class="o">(</span><span class="n">MultiPartRequest</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">multiNames</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">multiName</span> <span class="o">:</span> <span class="n">multiNames</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">multiName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">multipartHandlerName</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">mpr</span> <span class="o">=</span> <span class="n">getContainer</span><span class="o">().</span><span class="na">getInstance</span><span class="o">(</span><span class="n">MultiPartRequest</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">multiName</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mpr</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">mpr</span> <span class="o">=</span> <span class="n">getContainer</span><span class="o">().</span><span class="na">getInstance</span><span class="o">(</span><span class="n">MultiPartRequest</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MultiPartRequestWrapper</span><span class="o">(</span><span class="n">mpr</span><span class="o">,</span> <span class="n">request</span><span class="o">,</span> <span class="n">getSaveDir</span><span class="o">(</span><span class="n">servletContext</span><span class="o">));</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>

    	<span class="c1">// 封装成StrutsRequestWrapper
</span><span class="c1"></span>        <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StrutsRequestWrapper</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="n">request</span><span class="o">;</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>上面代码我们拆成两个部分进行分析:</p>

<h4 id="1-封装成multipartrequestwrapper">1. 封装成MultiPartRequestWrapper</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="k">if</span> <span class="o">(</span><span class="n">content_type</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">content_type</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="s">&#34;multipart/form-data&#34;</span><span class="o">)</span> <span class="o">!=</span> <span class="o">-</span><span class="n">1</span><span class="o">)</span> <span class="o">{</span>

    <span class="n">MultiPartRequest</span> <span class="n">mpr</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

     
    <span class="c1">//check for alternate implementations of MultiPartRequest
</span><span class="c1"></span>    <span class="c1">// 获取Struts-default.xml里的配置，也就是
</span><span class="c1"></span>    <span class="c1">// &lt;bean type=&#34;org.apache.struts2.dispatcher.multipart.MultiPartRequest&#34; name=&#34;struts&#34; class=&#34;org.apache.struts2.dispatcher.multipart.JakartaMultiPartRequest&#34; scope=&#34;default&#34;/&gt;
</span><span class="c1"></span>    <span class="c1">// &lt;bean type=&#34;org.apache.struts2.dispatcher.multipart.MultiPartRequest&#34; name=&#34;jakarta&#34; class=&#34;org.apache.struts2.dispatcher.multipart.JakartaMultiPartRequest&#34; scope=&#34;default&#34; /&gt;
</span><span class="c1"></span>    <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">multiNames</span> <span class="o">=</span> <span class="n">getContainer</span><span class="o">().</span><span class="na">getInstanceNames</span><span class="o">(</span><span class="n">MultiPartRequest</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">multiNames</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">multiName</span> <span class="o">:</span> <span class="n">multiNames</span><span class="o">)</span> <span class="o">{</span>

        	<span class="c1">// 根据multipartHandlerName配置的multipart Name决定采用那个MultiPartRequest类的实现类
</span><span class="c1"></span>        	<span class="c1">// 通过阅读代码，我们知道multipartHandlerName是由  &lt;constant name=&#34;struts.multipart.handler&#34; value=&#34;jakarta&#34; /&gt;
</span><span class="c1"></span>        	<span class="c1">// 也就是默认是jakarta，实现类是org.apache.struts2.dispatcher.multipart.JakartaMultiPartRequest, 再次怀念一下s2-045神洞
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">multiName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">multipartHandlerName</span><span class="o">))</span> <span class="o">{</span>

            	<span class="c1">// 获取org.apache.struts2.dispatcher.multipart.JakartaMultiPartRequest类的实例化
</span><span class="c1"></span>                <span class="n">mpr</span> <span class="o">=</span> <span class="n">getContainer</span><span class="o">().</span><span class="na">getInstance</span><span class="o">(</span><span class="n">MultiPartRequest</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">multiName</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mpr</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">)</span> <span class="o">{</span>
        <span class="n">mpr</span> <span class="o">=</span> <span class="n">getContainer</span><span class="o">().</span><span class="na">getInstance</span><span class="o">(</span><span class="n">MultiPartRequest</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>


    <span class="c1">// 这里的第三个参数是文件保存目录
</span><span class="c1"></span>    <span class="c1">// 下方我们看一下MultiPartRequestWrapper的大致实现
</span><span class="c1"></span>    <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MultiPartRequestWrapper</span><span class="o">(</span><span class="n">mpr</span><span class="o">,</span> <span class="n">request</span><span class="o">,</span> <span class="n">getSaveDir</span><span class="o">(</span><span class="n">servletContext</span><span class="o">));</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>

	<span class="o">....</span>
<span class="o">}</span>




<span class="c1">// MultiPartRequestWrapper.java 实现
</span><span class="c1"></span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MultiPartRequestWrapper</span> <span class="kd">extends</span> <span class="n">StrutsRequestWrapper</span> <span class="o">{</span>
    <span class="kd">protected</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">LOG</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">MultiPartRequestWrapper</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">errors</span><span class="o">;</span>
    <span class="n">MultiPartRequest</span> <span class="n">multi</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * Process file downloads and log any errors.
</span><span class="cm">     *
</span><span class="cm">     * @param request Our HttpServletRequest object
</span><span class="cm">     * @param saveDir Target directory for any files that we save
</span><span class="cm">     * @param multiPartRequest Our MultiPartRequest object
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="nf">MultiPartRequestWrapper</span><span class="o">(</span><span class="n">MultiPartRequest</span> <span class="n">multiPartRequest</span><span class="o">,</span> <span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">String</span> <span class="n">saveDir</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
        
        <span class="n">multi</span> <span class="o">=</span> <span class="n">multiPartRequest</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>

        	<span class="c1">// 用.JakartaMultiPartRequest类的parse方法解析reqeust对象，具体代码就不看了，也就是调用commons-fileupload组件进行上传文件
</span><span class="c1"></span>            <span class="n">multi</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">saveDir</span><span class="o">);</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">Object</span> <span class="n">o</span> <span class="o">:</span> <span class="n">multi</span><span class="o">.</span><span class="na">getErrors</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">String</span> <span class="n">error</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">o</span><span class="o">;</span>
                <span class="n">addError</span><span class="o">(</span><span class="n">error</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">addError</span><span class="o">(</span><span class="s">&#34;Cannot parse request: &#34;</span><span class="o">+</span><span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="o">}</span> 
    <span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>Content-Type为multipart/form-data的情况，我们已经分析完了，我们看一下非上传请求的正常http请求是怎么处理的吧.</p>

<h4 id="2-封装成strutsrequestwrapper">2. 封装成StrutsRequestWrapper</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="k">if</span> <span class="o">(</span><span class="n">content_type</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">content_type</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="s">&#34;multipart/form-data&#34;</span><span class="o">)</span> <span class="o">!=</span> <span class="o">-</span><span class="n">1</span><span class="o">)</span> <span class="o">{</span>

    <span class="c1">// .... 省略
</span><span class="c1"></span>  
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>

	<span class="c1">// 封装成StrutsRequestWrapper
</span><span class="c1"></span>    <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StrutsRequestWrapper</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>看一下StrutsRequestWrapper的实现:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StrutsRequestWrapper</span> <span class="kd">extends</span> <span class="n">HttpServletRequestWrapper</span> <span class="o">{</span>

    <span class="cm">/**
</span><span class="cm">     * The constructor
</span><span class="cm">     * @param req The request
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="nf">StrutsRequestWrapper</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">req</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">req</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Gets the object, looking in the value stack if not found
</span><span class="cm">     *
</span><span class="cm">     * @param s The attribute key
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getAttribute</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&#34;javax.servlet&#34;</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">// don&#39;t bother with the standard javax.servlet attributes, we can short-circuit this
</span><span class="c1"></span>            <span class="c1">// see WW-953 and the forums post linked in that issue for more info
</span><span class="c1"></span>            <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
        <span class="o">}</span>
      
        <span class="n">ActionContext</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">ActionContext</span><span class="o">.</span><span class="na">getContext</span><span class="o">();</span>
        <span class="n">Object</span> <span class="n">attribute</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">ctx</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>

        	<span class="c1">// 如果原生的getAttribute获取不到数据，则从ValueStack中获取
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">attribute</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">boolean</span> <span class="n">alreadyIn</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="n">Boolean</span> <span class="n">b</span> <span class="o">=</span> <span class="o">(</span><span class="n">Boolean</span><span class="o">)</span> <span class="n">ctx</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;__requestWrapper.getAttribute&#34;</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">b</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">alreadyIn</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="na">booleanValue</span><span class="o">();</span>
                <span class="o">}</span>
    
                <span class="c1">// note: we don&#39;t let # come through or else a request for
</span><span class="c1"></span>                <span class="c1">// #attr.foo or #request.foo could cause an endless loop
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">(!</span><span class="n">alreadyIn</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="s">&#34;#&#34;</span><span class="o">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">1</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="c1">// If not found, then try the ValueStack
</span><span class="c1"></span>                        <span class="n">ctx</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;__requestWrapper.getAttribute&#34;</span><span class="o">,</span> <span class="n">Boolean</span><span class="o">.</span><span class="na">TRUE</span><span class="o">);</span>
                        <span class="n">ValueStack</span> <span class="n">stack</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">getValueStack</span><span class="o">();</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">stack</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">attribute</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="na">findValue</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
                        <span class="o">}</span>
                    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                        <span class="n">ctx</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;__requestWrapper.getAttribute&#34;</span><span class="o">,</span> <span class="n">Boolean</span><span class="o">.</span><span class="na">FALSE</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">attribute</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>也就是对servlet的HttpServletRequestWrapper对象的实现，目的就是为了实现了getAttribute方法， 如果原生的getAttribute获取不到数据，则从ValueStack中获取。</p>

<h3 id="0x06-根据request获取action映射">0x06 根据request获取action映射</h3>

<blockquote>
<p>这种分析思路并不完美，容易让人阅读起来，思路中断，建议多看几遍</p>
</blockquote>

<p>ActionMapping mapping = prepare.findActionMapping(request, response, true); 具体实现代码:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="cm">/**
</span><span class="cm"> *   Finds and optionally creates an {@link ActionMapping}.  It first looks in the current request to see if one
</span><span class="cm"> * has already been found, otherwise, it creates it and stores it in the request.  No mapping will be created in the
</span><span class="cm"> * case of static resource requests or unidentifiable requests for other servlets, for example.
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="n">ActionMapping</span> <span class="nf">findActionMapping</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">findActionMapping</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
<span class="o">}</span>


<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">STRUTS_ACTION_MAPPING_KEY</span> <span class="o">=</span> <span class="s">&#34;struts.actionMapping&#34;</span><span class="o">;</span>


<span class="cm">/**
</span><span class="cm"> * Finds and optionally creates an {@link ActionMapping}.  if forceLookup is false, it first looks in the current request to see if one
</span><span class="cm"> * has already been found, otherwise, it creates it and stores it in the request.  No mapping will be created in the
</span><span class="cm"> * case of static resource requests or unidentifiable requests for other servlets, for example.
</span><span class="cm"> * @param forceLookup if true, the action mapping will be looked up from the ActionMapper instance, ignoring if there is one
</span><span class="cm"> * in the request or not 
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="n">ActionMapping</span> <span class="nf">findActionMapping</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">forceLookup</span><span class="o">)</span> <span class="o">{</span>

    <span class="n">ActionMapping</span> <span class="n">mapping</span> <span class="o">=</span> <span class="o">(</span><span class="n">ActionMapping</span><span class="o">)</span> <span class="n">request</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">STRUTS_ACTION_MAPPING_KEY</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mapping</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">forceLookup</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>

        	<span class="c1">// 根据reqeust获取action映射,存放到Attribute，目的是为了性能优化
</span><span class="c1"></span>        	<span class="c1">// 这里的ActionMapper.class的具体实现类是org.apache.struts2.dispatcher.mapper.DefaultActionMapper
</span><span class="c1"></span>        	<span class="c1">// 下方我们分析一下DefaultActionMapper的getMapping实现
</span><span class="c1"></span>            <span class="n">mapping</span> <span class="o">=</span> <span class="n">dispatcher</span><span class="o">.</span><span class="na">getContainer</span><span class="o">().</span><span class="na">getInstance</span><span class="o">(</span><span class="n">ActionMapper</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">getMapping</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">dispatcher</span><span class="o">.</span><span class="na">getConfigurationManager</span><span class="o">());</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mapping</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">request</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="n">STRUTS_ACTION_MAPPING_KEY</span><span class="o">,</span> <span class="n">mapping</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">dispatcher</span><span class="o">.</span><span class="na">sendError</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">servletContext</span><span class="o">,</span> <span class="n">HttpServletResponse</span><span class="o">.</span><span class="na">SC_INTERNAL_SERVER_ERROR</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="n">mapping</span><span class="o">;</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>分析一下DefaultActionMapper的getMapping实现：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="cm">/*
</span><span class="cm"> * (non-Javadoc)
</span><span class="cm"> *
</span><span class="cm"> * @see org.apache.struts2.dispatcher.mapper.ActionMapper#getMapping(javax.servlet.http.HttpServletRequest)
</span><span class="cm"> */</span>

<span class="kd">public</span> <span class="n">ActionMapping</span> <span class="nf">getMapping</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span>
                                <span class="n">ConfigurationManager</span> <span class="n">configManager</span><span class="o">)</span> <span class="o">{</span>


    <span class="n">ActionMapping</span> <span class="n">mapping</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ActionMapping</span><span class="o">();</span>


    <span class="c1">// 获取uri
</span><span class="c1"></span>    <span class="c1">// 例如我们访问的是http://localhost/index.action,那么uri就是/index.action
</span><span class="c1"></span>    <span class="n">String</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">getUri</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>

    <span class="c1">// 这段代码的意思应该是为了处理这样的uri /index;xxxxx.action
</span><span class="c1"></span>    <span class="c1">// 具体可以看tomcat的uri处理
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">indexOfSemicolon</span> <span class="o">=</span> <span class="n">uri</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="s">&#34;;&#34;</span><span class="o">);</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="o">(</span><span class="n">indexOfSemicolon</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">1</span><span class="o">)</span> <span class="o">?</span> <span class="n">uri</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">indexOfSemicolon</span><span class="o">)</span> <span class="o">:</span> <span class="n">uri</span><span class="o">;</span>

    <span class="c1">// 删除扩展,如传递的是/index.action，最后保留的是index
</span><span class="c1"></span>    <span class="n">uri</span> <span class="o">=</span> <span class="n">dropExtension</span><span class="o">(</span><span class="n">uri</span><span class="o">,</span> <span class="n">mapping</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">uri</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// 根据uri解析name和Namespace,
</span><span class="c1"></span>    <span class="n">parseNameAndNamespace</span><span class="o">(</span><span class="n">uri</span><span class="o">,</span> <span class="n">mapping</span><span class="o">,</span> <span class="n">configManager</span><span class="o">);</span>

    <span class="c1">// 这个函数实现了Struts2的DynamicMethod功能，具体下方有详细分析
</span><span class="c1"></span>    <span class="n">handleSpecialParameters</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">mapping</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">mapping</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    
    <span class="c1">// 这里实现了Struts2另外一种动态方法调用功能,具体下方有详细分析
</span><span class="c1"></span>    <span class="n">parseActionName</span><span class="o">(</span><span class="n">mapping</span><span class="o">);</span>

    <span class="k">return</span> <span class="n">mapping</span><span class="o">;</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>上方代码我们分为2个部分分析</p>

<h4 id="1-parsenameandnamespace方法分析">1. parseNameAndNamespace方法分析</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="cm">/**
</span><span class="cm"> * Parses the name and namespace from the uri
</span><span class="cm"> *
</span><span class="cm"> * @param uri     The uri
</span><span class="cm"> * @param mapping The action mapping to populate
</span><span class="cm"> */</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">parseNameAndNamespace</span><span class="o">(</span><span class="n">String</span> <span class="n">uri</span><span class="o">,</span> <span class="n">ActionMapping</span> <span class="n">mapping</span><span class="o">,</span>
                                     <span class="n">ConfigurationManager</span> <span class="n">configManager</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">namespace</span><span class="o">,</span> <span class="n">name</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">lastSlash</span> <span class="o">=</span> <span class="n">uri</span><span class="o">.</span><span class="na">lastIndexOf</span><span class="o">(</span><span class="s">&#34;/&#34;</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">lastSlash</span> <span class="o">==</span> <span class="o">-</span><span class="n">1</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="s">&#34;&#34;</span><span class="o">;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">uri</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">lastSlash</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// ww-1046, assume it is the root namespace, it will fallback to
</span><span class="c1"></span>        <span class="c1">// default
</span><span class="c1"></span>        <span class="c1">// namespace anyway if not found in root namespace.
</span><span class="c1"></span>        <span class="n">namespace</span> <span class="o">=</span> <span class="s">&#34;/&#34;</span><span class="o">;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">uri</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">lastSlash</span> <span class="o">+</span> <span class="n">1</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">alwaysSelectFullNamespace</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Simply select the namespace as everything before the last slash
</span><span class="c1"></span>        <span class="n">namespace</span> <span class="o">=</span> <span class="n">uri</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">lastSlash</span><span class="o">);</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">uri</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">lastSlash</span> <span class="o">+</span> <span class="n">1</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="c1">// Try to find the namespace in those defined, defaulting to &#34;&#34;
</span><span class="c1"></span>
        <span class="c1">// 获取配置信息
</span><span class="c1"></span>        <span class="n">Configuration</span> <span class="n">config</span> <span class="o">=</span> <span class="n">configManager</span><span class="o">.</span><span class="na">getConfiguration</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">prefix</span> <span class="o">=</span> <span class="n">uri</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">lastSlash</span><span class="o">);</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="s">&#34;&#34;</span><span class="o">;</span>
        <span class="kt">boolean</span> <span class="n">rootAvailable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="c1">// Find the longest matching namespace, defaulting to the default
</span><span class="c1"></span>        <span class="c1">// 通过配置文件，根据uri获取到的namespace，去查找配置里的namespace
</span><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="n">Object</span> <span class="n">cfg</span> <span class="o">:</span> <span class="n">config</span><span class="o">.</span><span class="na">getPackageConfigs</span><span class="o">().</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">ns</span> <span class="o">=</span> <span class="o">((</span><span class="n">PackageConfig</span><span class="o">)</span> <span class="n">cfg</span><span class="o">).</span><span class="na">getNamespace</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">ns</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">prefix</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="n">ns</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">prefix</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">==</span> <span class="n">ns</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">||</span> <span class="n">prefix</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="na">length</span><span class="o">())</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">namespace</span><span class="o">.</span><span class="na">length</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">namespace</span> <span class="o">=</span> <span class="n">ns</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="s">&#34;/&#34;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">ns</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">rootAvailable</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="c1">// 得到name
</span><span class="c1"></span>        <span class="n">name</span> <span class="o">=</span> <span class="n">uri</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">namespace</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">+</span> <span class="n">1</span><span class="o">);</span>

        <span class="c1">// Still none found, use root namespace if found
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">rootAvailable</span> <span class="o">&amp;&amp;</span> <span class="s">&#34;&#34;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">namespace</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="s">&#34;/&#34;</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(!</span><span class="n">allowSlashesInActionNames</span> <span class="o">&amp;&amp;</span> <span class="n">name</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="na">lastIndexOf</span><span class="o">(</span><span class="sc">&#39;/&#39;</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">pos</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">1</span> <span class="o">&amp;&amp;</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="n">name</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">-</span> <span class="n">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">pos</span> <span class="o">+</span> <span class="n">1</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="n">mapping</span><span class="o">.</span><span class="na">setNamespace</span><span class="o">(</span><span class="n">namespace</span><span class="o">);</span>
    <span class="n">mapping</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>这里我们不得不贴上我们的应用Struts.xml配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34; ?&gt;</span>
<span class="cp">&lt;!DOCTYPE struts PUBLIC
</span><span class="cp">        &#34;-//Apache Software Foundation//DTD Struts Configuration 2.5//EN&#34;
</span><span class="cp">        &#34;http://struts.apache.org/dtds/struts-2.5.dtd&#34;&gt;</span>

<span class="nt">&lt;struts&gt;</span>

    <span class="nt">&lt;constant</span> <span class="na">name=</span><span class="s">&#34;struts.enable.DynamicMethodInvocation&#34;</span> <span class="na">value=</span><span class="s">&#34;true&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;constant</span> <span class="na">name=</span><span class="s">&#34;struts.devMode&#34;</span> <span class="na">value=</span><span class="s">&#34;true&#34;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;package</span> <span class="na">name=</span><span class="s">&#34;myPackage&#34;</span> <span class="na">extends=</span><span class="s">&#34;struts-default&#34;</span><span class="nt">&gt;</span>

        <span class="nt">&lt;default-action-ref</span> <span class="na">name=</span><span class="s">&#34;index&#34;</span> <span class="nt">/&gt;</span>

        <span class="nt">&lt;action</span> <span class="na">name=</span><span class="s">&#34;index&#34;</span> <span class="na">class=</span><span class="s">&#34;com.jd.IndexAction&#34;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;result&gt;</span>/WEB-INF/jsp/index.jsp<span class="nt">&lt;/result&gt;</span>
        <span class="nt">&lt;/action&gt;</span>

    <span class="nt">&lt;/package&gt;</span>

<span class="nt">&lt;/struts&gt;</span></code></pre></td></tr></table>
</div>
</div>
<p>所以当我们访问/index.action的时候，parseNameAndNamespace方法处理过后的name是&rdquo;index&rdquo;，而namespace是”/“.</p>

<h4 id="2-handlespecialparameters方法分析">2. handleSpecialParameters方法分析</h4>

<p>handleSpecialParameters(request, mapping);  代码实现:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="cm">/**
</span><span class="cm"> * Special parameters, as described in the class-level comment, are searched
</span><span class="cm"> * for and handled.
</span><span class="cm"> * 
</span><span class="cm"> *
</span><span class="cm"> * 搜索和处理特殊参数，如 class-level 注释中所述
</span><span class="cm"> *
</span><span class="cm"> * @param request The request
</span><span class="cm"> * @param mapping The action mapping
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleSpecialParameters</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span>
                                    <span class="n">ActionMapping</span> <span class="n">mapping</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// handle special parameter prefixes.
</span><span class="c1"></span>    <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">uniqueParameters</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
    <span class="n">Map</span> <span class="n">parameterMap</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameterMap</span><span class="o">();</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">Iterator</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">parameterMap</span><span class="o">.</span><span class="na">keySet</span><span class="o">().</span><span class="na">iterator</span><span class="o">();</span> <span class="n">iterator</span>
            <span class="o">.</span><span class="na">hasNext</span><span class="o">();)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">iterator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>

        <span class="c1">// Strip off the image button location info, if found
</span><span class="c1"></span>        <span class="c1">// 翻译：剥离图像按钮位置信息（如果找到）
</span><span class="c1"></span>        <span class="c1">// 懵逼了，这是什么鬼？ 可能是兼容某个struts2的image标签库的吧。。我猜的，总之也不是关键代码，不会造成什么影响
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="s">&#34;.x&#34;</span><span class="o">)</span> <span class="o">||</span> <span class="n">key</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="s">&#34;.y&#34;</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">key</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">-</span> <span class="n">2</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// Ensure a parameter doesn&#39;t get processed twice
</span><span class="c1"></span>        <span class="c1">// 参数去重
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(!</span><span class="n">uniqueParameters</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">key</span><span class="o">))</span> <span class="o">{</span>

        	<span class="c1">// 这是是个骚操作，我们单独分析
</span><span class="c1"></span>            <span class="n">ParameterAction</span> <span class="n">parameterAction</span> <span class="o">=</span> <span class="o">(</span><span class="n">ParameterAction</span><span class="o">)</span> <span class="n">prefixTrie</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">parameterAction</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">parameterAction</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">mapping</span><span class="o">);</span>
                <span class="n">uniqueParameters</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>上面这个函数中有一段特殊代码，如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">ParameterAction</span> <span class="n">parameterAction</span> <span class="o">=</span> <span class="o">(</span><span class="n">ParameterAction</span><span class="o">)</span> <span class="n">prefixTrie</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
<span class="k">if</span> <span class="o">(</span><span class="n">parameterAction</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">parameterAction</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">mapping</span><span class="o">);</span>
    <span class="n">uniqueParameters</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
    <span class="k">break</span><span class="o">;</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>首先我们看一下这个prefixTrie是什么鬼?</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DefaultActionMapper</span> <span class="kd">implements</span> <span class="n">ActionMapper</span> <span class="o">{</span>

    <span class="kd">protected</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">METHOD_PREFIX</span> <span class="o">=</span> <span class="s">&#34;method:&#34;</span><span class="o">;</span>

    <span class="kd">protected</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">ACTION_PREFIX</span> <span class="o">=</span> <span class="s">&#34;action:&#34;</span><span class="o">;</span>

    <span class="kd">protected</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">REDIRECT_PREFIX</span> <span class="o">=</span> <span class="s">&#34;redirect:&#34;</span><span class="o">;</span>

    <span class="kd">protected</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">REDIRECT_ACTION_PREFIX</span> <span class="o">=</span> <span class="s">&#34;redirectAction:&#34;</span><span class="o">;</span>

    <span class="kd">protected</span> <span class="kt">boolean</span> <span class="n">allowDynamicMethodCalls</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>

    <span class="kd">protected</span> <span class="kt">boolean</span> <span class="n">allowSlashesInActionNames</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

    <span class="kd">protected</span> <span class="kt">boolean</span> <span class="n">alwaysSelectFullNamespace</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

    <span class="kd">protected</span> <span class="n">PrefixTrie</span> <span class="n">prefixTrie</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

     <span class="kd">public</span> <span class="nf">DefaultActionMapper</span><span class="o">()</span> <span class="o">{</span>


        <span class="c1">// 初始化prefixTrie
</span><span class="c1"></span>        <span class="c1">// 注意这里的key， 分别为method:、action:、redirect：
</span><span class="c1"></span>        <span class="c1">// 以及这些key对应的ParameterAction对象的实现
</span><span class="c1"></span>        <span class="c1">// 这里的allowDynamicMethodCalls变量是由配置文件中struts.enable.DynamicMethodInvocation设置，默认开启
</span><span class="c1"></span>        <span class="n">prefixTrie</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PrefixTrie</span><span class="o">()</span> <span class="o">{</span>
            <span class="o">{</span>
                <span class="n">put</span><span class="o">(</span><span class="n">METHOD_PREFIX</span><span class="o">,</span> <span class="k">new</span> <span class="n">ParameterAction</span><span class="o">()</span> <span class="o">{</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">ActionMapping</span> <span class="n">mapping</span><span class="o">)</span> <span class="o">{</span>

                    	<span class="c1">// 设置Action映射的方法为method:后的value
</span><span class="c1"></span>                    	<span class="c1">// 访问http://localhost/index.action?method:add,则
</span><span class="c1"></span>                    	<span class="c1">// 调用indexAction的add方法
</span><span class="c1"></span>                        <span class="k">if</span> <span class="o">(</span><span class="n">allowDynamicMethodCalls</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">mapping</span><span class="o">.</span><span class="na">setMethod</span><span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span>
                                    <span class="n">METHOD_PREFIX</span><span class="o">.</span><span class="na">length</span><span class="o">()));</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">});</span>

                <span class="n">put</span><span class="o">(</span><span class="n">ACTION_PREFIX</span><span class="o">,</span> <span class="k">new</span> <span class="n">ParameterAction</span><span class="o">()</span> <span class="o">{</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">ActionMapping</span> <span class="n">mapping</span><span class="o">)</span> <span class="o">{</span>

                    	<span class="c1">// 这里和method有所不同
</span><span class="c1"></span>                    	<span class="c1">// 访问http://localhost/index.action?action:user!add , 则
</span><span class="c1"></span>                    	<span class="c1">// 调用userAction的add方法
</span><span class="c1"></span>                        <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">ACTION_PREFIX</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">allowDynamicMethodCalls</span><span class="o">)</span> <span class="o">{</span>
                            <span class="kt">int</span> <span class="n">bang</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="sc">&#39;!&#39;</span><span class="o">);</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">bang</span> <span class="o">!=</span> <span class="o">-</span><span class="n">1</span><span class="o">)</span> <span class="o">{</span>
                                <span class="n">String</span> <span class="n">method</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">bang</span> <span class="o">+</span> <span class="n">1</span><span class="o">);</span>
                                <span class="n">mapping</span><span class="o">.</span><span class="na">setMethod</span><span class="o">(</span><span class="n">method</span><span class="o">);</span>
                                <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">bang</span><span class="o">);</span>
                            <span class="o">}</span>
                        <span class="o">}</span>
                        <span class="n">mapping</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">});</span>

                <span class="n">put</span><span class="o">(</span><span class="n">REDIRECT_PREFIX</span><span class="o">,</span> <span class="k">new</span> <span class="n">ParameterAction</span><span class="o">()</span> <span class="o">{</span>

                    <span class="c1">// 这里不是方法的调用
</span><span class="c1"></span>                    <span class="c1">// 访问 http://localhost/index.action?redirect:user , 则
</span><span class="c1"></span>                    <span class="c1">// 重定向到user.jsp
</span><span class="c1"></span>                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">ActionMapping</span> <span class="n">mapping</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">ServletRedirectResult</span> <span class="n">redirect</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServletRedirectResult</span><span class="o">();</span>
                        <span class="n">container</span><span class="o">.</span><span class="na">inject</span><span class="o">(</span><span class="n">redirect</span><span class="o">);</span>
                        <span class="n">redirect</span><span class="o">.</span><span class="na">setLocation</span><span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">REDIRECT_PREFIX</span>
                                <span class="o">.</span><span class="na">length</span><span class="o">()));</span>
                        <span class="n">mapping</span><span class="o">.</span><span class="na">setResult</span><span class="o">(</span><span class="n">redirect</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">});</span>

                <span class="n">put</span><span class="o">(</span><span class="n">REDIRECT_ACTION_PREFIX</span><span class="o">,</span> <span class="k">new</span> <span class="n">ParameterAction</span><span class="o">()</span> <span class="o">{</span>

                    <span class="c1">// 这里的redirectAction: 和 redirect: 的区别是带不带后缀
</span><span class="c1"></span>                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">ActionMapping</span> <span class="n">mapping</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">String</span> <span class="n">location</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">REDIRECT_ACTION_PREFIX</span>
                                <span class="o">.</span><span class="na">length</span><span class="o">());</span>
                        <span class="n">ServletRedirectResult</span> <span class="n">redirect</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServletRedirectResult</span><span class="o">();</span>
                        <span class="n">container</span><span class="o">.</span><span class="na">inject</span><span class="o">(</span><span class="n">redirect</span><span class="o">);</span>
                        <span class="n">String</span> <span class="n">extension</span> <span class="o">=</span> <span class="n">getDefaultExtension</span><span class="o">();</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">extension</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">extension</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">location</span> <span class="o">+=</span> <span class="s">&#34;.&#34;</span> <span class="o">+</span> <span class="n">extension</span><span class="o">;</span>
                        <span class="o">}</span>
                        <span class="n">redirect</span><span class="o">.</span><span class="na">setLocation</span><span class="o">(</span><span class="n">location</span><span class="o">);</span>
                        <span class="n">mapping</span><span class="o">.</span><span class="na">setResult</span><span class="o">(</span><span class="n">redirect</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">});</span>
            <span class="o">}</span>
        <span class="o">};</span>
    <span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>额&hellip;这是Struts2的奇葩设计，”动态方法调用“功能，通过struts.enable.DynamicMethodInvocation设置为true大概该功能, 这里简单介绍一下，具体功能使用google一下：</p>

<p>也就是当我们访问<a href="http://localhost/index.action?method:foo的时候，就会调用index这个Action中的foo方法，">http://localhost/index.action?method:foo的时候，就会调用index这个Action中的foo方法，</a> 具体阅读上方代码注释.</p>

<p>话说s2-16漏洞问题就是出在redirect:这个重定向功能， 具体参考[1]</p>

<blockquote>
<p>TIPS: 这里的PrefixTrie值得研究一下，里面涉及到了Trie树的实现，具体参考[2]</p>
</blockquote>

<h4 id="3-parseactionname方法分析">3. parseActionName方法分析</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">protected</span> <span class="n">ActionMapping</span> <span class="nf">parseActionName</span><span class="o">(</span><span class="n">ActionMapping</span> <span class="n">mapping</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mapping</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">mapping</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">allowDynamicMethodCalls</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// handle &#34;name!method&#34; convention.
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">exclamation</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="na">lastIndexOf</span><span class="o">(</span><span class="s">&#34;!&#34;</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">exclamation</span> <span class="o">!=</span> <span class="o">-</span><span class="n">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mapping</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">name</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">exclamation</span><span class="o">));</span>
            <span class="n">mapping</span><span class="o">.</span><span class="na">setMethod</span><span class="o">(</span><span class="n">name</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">exclamation</span> <span class="o">+</span> <span class="n">1</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">mapping</span><span class="o">;</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>从代码中可以看得到，也是一种Dynamic Method的调用方式，例如我们访问：<a href="http://locahost/index!add.action">http://locahost/index!add.action</a> ， 则调用了indexAction的add方法.</p>

<blockquote>
<p>TIPS: 实在受不了为毛一个Dynamic Method功能用各种花样方式实现？？？</p>
</blockquote>

<p>好了，我们已经分析完prepare.findActionMapping(request, response, true)的实现了，成功得到Action的映射关系了，下面开始最后一个环节，执行Action</p>

<h3 id="0x07-执行action">0x07 执行Action</h3>

<p>execute.executeAction(request, response, mapping); 的代码实现</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="cm">/**
</span><span class="cm"> * Contains execution operations for filters
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExecuteOperations</span> <span class="o">{</span>

	<span class="cm">/**
</span><span class="cm">	 * Executes an action
</span><span class="cm">	 * @throws ServletException
</span><span class="cm">	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">executeAction</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">ActionMapping</span> <span class="n">mapping</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span> <span class="o">{</span>
	    <span class="n">dispatcher</span><span class="o">.</span><span class="na">serviceAction</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">servletContext</span><span class="o">,</span> <span class="n">mapping</span><span class="o">);</span>
	<span class="o">}</span>





<span class="c1">// Dispatcher.java
</span><span class="c1"></span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Dispatcher</span> <span class="o">{</span>

    <span class="cm">/**
</span><span class="cm">     * Load Action class for mapping and invoke the appropriate Action method, or go directly to the Result.
</span><span class="cm">     * &lt;p/&gt;
</span><span class="cm">     * This method first creates the action context from the given parameters,
</span><span class="cm">     * and then loads an &lt;tt&gt;ActionProxy&lt;/tt&gt; from the given action name and namespace.
</span><span class="cm">     * After that, the Action method is executed and output channels through the response object.
</span><span class="cm">     * Actions not found are sent back to the user via the {@link Dispatcher#sendError} method,
</span><span class="cm">     * using the 404 return code.
</span><span class="cm">     * All other errors are reported by throwing a ServletException.
</span><span class="cm">     *
</span><span class="cm">     * @param request  the HttpServletRequest object
</span><span class="cm">     * @param response the HttpServletResponse object
</span><span class="cm">     * @param mapping  the action mapping object
</span><span class="cm">     * @throws ServletException when an unknown error occurs (not a 404, but typically something that
</span><span class="cm">     *                          would end up as a 5xx by the servlet container)
</span><span class="cm">     * @param context Our ServletContext object
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">serviceAction</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">ServletContext</span> <span class="n">context</span><span class="o">,</span>
                              <span class="n">ActionMapping</span> <span class="n">mapping</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span> <span class="o">{</span>



        <span class="c1">// 上方分析过这个createContextMap，当时的mapping为空，现在已经拿到mapping，重新设置一下上下文
</span><span class="c1"></span>        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">extraContext</span> <span class="o">=</span> <span class="n">createContextMap</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">mapping</span><span class="o">,</span> <span class="n">context</span><span class="o">);</span>

        <span class="c1">// If there was a previous value stack, then create a new copy and pass it in to be used by the new Action
</span><span class="c1"></span>        <span class="n">ValueStack</span> <span class="n">stack</span> <span class="o">=</span> <span class="o">(</span><span class="n">ValueStack</span><span class="o">)</span> <span class="n">request</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">ServletActionContext</span><span class="o">.</span><span class="na">STRUTS_VALUESTACK_KEY</span><span class="o">);</span>
        <span class="kt">boolean</span> <span class="n">nullStack</span> <span class="o">=</span> <span class="n">stack</span> <span class="o">==</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">nullStack</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ActionContext</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">ActionContext</span><span class="o">.</span><span class="na">getContext</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">ctx</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">stack</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">getValueStack</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">stack</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>

        	<span class="c1">// 这里使用了OgnlValueStackFactory对象，该对象实例化了OgnlValueStack对象，并对OgnlValueStack对象进行初始化
</span><span class="c1"></span>        	<span class="c1">// 之前我们对OgnlValueStack做过分析，OgnlValueStack其实就是对ValueStack接口的具体实现，用来对root对象进行ognl计算使用
</span><span class="c1"></span>        	<span class="c1">// 具体可以翻看之前的文章 http://dean.csoio.com/posts/struts2-internals-readbook-note_06/
</span><span class="c1"></span>            <span class="n">extraContext</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">ActionContext</span><span class="o">.</span><span class="na">VALUE_STACK</span><span class="o">,</span> <span class="n">valueStackFactory</span><span class="o">.</span><span class="na">createValueStack</span><span class="o">(</span><span class="n">stack</span><span class="o">));</span>
        <span class="o">}</span>


        <span class="n">String</span> <span class="n">timerKey</span> <span class="o">=</span> <span class="s">&#34;Handling request from Dispatcher&#34;</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>

            <span class="n">UtilTimerStack</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="n">timerKey</span><span class="o">);</span>

            <span class="n">String</span> <span class="n">namespace</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="na">getNamespace</span><span class="o">();</span>
            <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
            <span class="n">String</span> <span class="n">method</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="na">getMethod</span><span class="o">();</span>

            <span class="n">Configuration</span> <span class="n">config</span> <span class="o">=</span> <span class="n">configurationManager</span><span class="o">.</span><span class="na">getConfiguration</span><span class="o">();</span>

            <span class="c1">// 这里的ActionProxyFactory的实现类是org.apache.struts2.impl.StrutsActionProxyFactory&#34;
</span><span class="c1"></span>            <span class="c1">// StrutsActionProxyFactory的createActionProxy方法我们下方会做具体分析， 这里就认为返回了一个ActionProxy类，
</span><span class="c1"></span>            <span class="c1">// 具体实现类是org.apache.struts2.impl.StrutsActionProxyFactory
</span><span class="c1"></span>            <span class="n">ActionProxy</span> <span class="n">proxy</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">getContainer</span><span class="o">().</span><span class="na">getInstance</span><span class="o">(</span><span class="n">ActionProxyFactory</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">createActionProxy</span><span class="o">(</span>
                    <span class="n">namespace</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">method</span><span class="o">,</span> <span class="n">extraContext</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>

            
            <span class="n">request</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="n">ServletActionContext</span><span class="o">.</span><span class="na">STRUTS_VALUESTACK_KEY</span><span class="o">,</span> <span class="n">proxy</span><span class="o">.</span><span class="na">getInvocation</span><span class="o">().</span><span class="na">getStack</span><span class="o">());</span>



            <span class="c1">// 这里代码太关键，下方我们作为第二部分单独分析.
</span><span class="c1"></span>            <span class="c1">// if the ActionMapping says to go straight to a result, do it!
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">mapping</span><span class="o">.</span><span class="na">getResult</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Result</span> <span class="n">result</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="na">getResult</span><span class="o">();</span>
                <span class="n">result</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">proxy</span><span class="o">.</span><span class="na">getInvocation</span><span class="o">());</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>

            	<span class="c1">// 调用org.apache.struts2.impl.StrutsActionProxyFactory的execute方法执行
</span><span class="c1"></span>                <span class="n">proxy</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span>
            <span class="o">}</span>

            <span class="c1">// If there was a previous value stack then set it back onto the request
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(!</span><span class="n">nullStack</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">request</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="n">ServletActionContext</span><span class="o">.</span><span class="na">STRUTS_VALUESTACK_KEY</span><span class="o">,</span> <span class="n">stack</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ConfigurationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        	<span class="c1">// WW-2874 Only log error if in devMode
</span><span class="c1"></span>        	<span class="k">if</span><span class="o">(</span><span class="n">devMode</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">String</span> <span class="n">reqStr</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getRequestURI</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getQueryString</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">reqStr</span> <span class="o">=</span> <span class="n">reqStr</span> <span class="o">+</span> <span class="s">&#34;?&#34;</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="na">getQueryString</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="n">LOG</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&#34;Could not find action or result\n&#34;</span> <span class="o">+</span> <span class="n">reqStr</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        	<span class="k">else</span> <span class="o">{</span>
        		<span class="n">LOG</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&#34;Could not find action or result&#34;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        	<span class="o">}</span>
            <span class="n">sendError</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">context</span><span class="o">,</span> <span class="n">HttpServletResponse</span><span class="o">.</span><span class="na">SC_NOT_FOUND</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">sendError</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">context</span><span class="o">,</span> <span class="n">HttpServletResponse</span><span class="o">.</span><span class="na">SC_INTERNAL_SERVER_ERROR</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">UtilTimerStack</span><span class="o">.</span><span class="na">pop</span><span class="o">(</span><span class="n">timerKey</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>上方我们做了简单分析，其中有多个疑惑，下方我们逐个详细分析.</p>

<h4 id="1-strutsactionproxyfactory类的createactionproxy方法分析">1.  StrutsActionProxyFactory类的createActionProxy方法分析</h4>

<p>首先我们看一下createActionProxy方法的调用:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"> <span class="n">ActionProxy</span> <span class="n">proxy</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">getContainer</span><span class="o">().</span><span class="na">getInstance</span><span class="o">(</span><span class="n">ActionProxyFactory</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">createActionProxy</span><span class="o">(</span>
                    <span class="n">namespace</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">method</span><span class="o">,</span> <span class="n">extraContext</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span></code></pre></td></tr></table>
</div>
</div>
<p>通过调用可以看到这个createActionProxy方法并未在StrutsActionProxyFactory中实现，而是在其父类DefaultActionProxyFactory中实现，我们看一下DefaultActionProxyFactory类的createActionProxy方法实现代码:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// DefaultActionProxyFactory.java
</span><span class="c1"></span>
<span class="kd">public</span> <span class="n">ActionProxy</span> <span class="nf">createActionProxy</span><span class="o">(</span><span class="n">String</span> <span class="n">namespace</span><span class="o">,</span> <span class="n">String</span> <span class="n">actionName</span><span class="o">,</span> <span class="n">String</span> <span class="n">methodName</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">extraContext</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">executeResult</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">cleanupContext</span><span class="o">)</span> <span class="o">{</span>
    

    <span class="c1">// 将实例化的Action调用器存入容器
</span><span class="c1"></span>    <span class="n">ActionInvocation</span> <span class="n">inv</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultActionInvocation</span><span class="o">(</span><span class="n">extraContext</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
    <span class="n">container</span><span class="o">.</span><span class="na">inject</span><span class="o">(</span><span class="n">inv</span><span class="o">);</span>

    <span class="c1">// 这里调用的是StrutsActionProxyFactory类的createActionProxy方法
</span><span class="c1"></span>    <span class="k">return</span> <span class="n">createActionProxy</span><span class="o">(</span><span class="n">inv</span><span class="o">,</span> <span class="n">namespace</span><span class="o">,</span> <span class="n">actionName</span><span class="o">,</span> <span class="n">methodName</span><span class="o">,</span> <span class="n">executeResult</span><span class="o">,</span> <span class="n">cleanupContext</span><span class="o">);</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>我们看一下 StrutsActionProxyFactory类的createActionProxy方法实现：</p>

<pre><code>
// 其实就是重写了DefaultActionProxyFactory的createActionProxy方法
public class StrutsActionProxyFactory extends DefaultActionProxyFactory {

    @Override
    public ActionProxy createActionProxy(ActionInvocation inv, String namespace, String actionName, String methodName, boolean executeResult, boolean cleanupContext) {
        

        StrutsActionProxy proxy = new StrutsActionProxy(inv, namespace, actionName, methodName, executeResult, cleanupContext);
        container.inject(proxy);

        // 预处理StrutsActionProxy对象，下方我们看一下prepare方法的具体实现
        proxy.prepare();

        // 返回预处理完成的StrutsActionProxy对象
        return proxy;
    }
}

</code></pre>

<p>StrutsActionProxy类的prepare方法的具体实现：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StrutsActionProxy</span> <span class="kd">extends</span> <span class="n">DefaultActionProxy</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="o">-</span><span class="n">2434901249671934080L</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">StrutsActionProxy</span><span class="o">(</span><span class="n">ActionInvocation</span> <span class="n">inv</span><span class="o">,</span> <span class="n">String</span> <span class="n">namespace</span><span class="o">,</span> <span class="n">String</span> <span class="n">actionName</span><span class="o">,</span> <span class="n">String</span> <span class="n">methodName</span><span class="o">,</span>
                             <span class="kt">boolean</span> <span class="n">executeResult</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">cleanupContext</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">inv</span><span class="o">,</span> <span class="n">namespace</span><span class="o">,</span> <span class="n">actionName</span><span class="o">,</span> <span class="n">methodName</span><span class="o">,</span> <span class="n">executeResult</span><span class="o">,</span> <span class="n">cleanupContext</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">execute</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">ActionContext</span> <span class="n">previous</span> <span class="o">=</span> <span class="n">ActionContext</span><span class="o">.</span><span class="na">getContext</span><span class="o">();</span>
        <span class="n">ActionContext</span><span class="o">.</span><span class="na">setContext</span><span class="o">(</span><span class="n">invocation</span><span class="o">.</span><span class="na">getInvocationContext</span><span class="o">());</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">invocation</span><span class="o">.</span><span class="na">invoke</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">cleanupContext</span><span class="o">)</span>
                <span class="n">ActionContext</span><span class="o">.</span><span class="na">setContext</span><span class="o">(</span><span class="n">previous</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">prepare</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">prepare</span><span class="o">();</span>
    <span class="o">}</span>

<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>额欧~ 其实就是调用了DefaultActionProxy父类的prepare方法预处理，我们在回去看看了DefaultActionProxy父类的prepare方法实现:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DefaultActionProxy</span> <span class="kd">implements</span> <span class="n">ActionProxy</span><span class="o">,</span> <span class="n">Serializable</span> <span class="o">{</span>
	
    <span class="kd">protected</span> <span class="nf">DefaultActionProxy</span><span class="o">(</span><span class="n">ActionInvocation</span> <span class="n">inv</span><span class="o">,</span> <span class="n">String</span> <span class="n">namespace</span><span class="o">,</span> <span class="n">String</span> <span class="n">actionName</span><span class="o">,</span> <span class="n">String</span> <span class="n">methodName</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">executeResult</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">cleanupContext</span><span class="o">)</span> <span class="o">{</span>
        
        <span class="k">this</span><span class="o">.</span><span class="na">invocation</span> <span class="o">=</span> <span class="n">inv</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">cleanupContext</span> <span class="o">=</span> <span class="n">cleanupContext</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">LOG</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Creating an DefaultActionProxy for namespace &#34;</span> <span class="o">+</span> <span class="n">namespace</span> <span class="o">+</span> <span class="s">&#34; and action name &#34;</span> <span class="o">+</span> <span class="n">actionName</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">this</span><span class="o">.</span><span class="na">actionName</span> <span class="o">=</span> <span class="n">actionName</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">namespace</span> <span class="o">=</span> <span class="n">namespace</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">executeResult</span> <span class="o">=</span> <span class="n">executeResult</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">method</span> <span class="o">=</span> <span class="n">methodName</span><span class="o">;</span>
    <span class="o">}</span>


     <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">prepare</span><span class="o">()</span>  <span class="o">{</span>
        <span class="n">String</span> <span class="n">profileKey</span> <span class="o">=</span> <span class="s">&#34;create DefaultActionProxy: &#34;</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">UtilTimerStack</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="n">profileKey</span><span class="o">);</span>


            <span class="c1">// 得到action的配置信息
</span><span class="c1"></span>            <span class="n">config</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="na">getRuntimeConfiguration</span><span class="o">().</span><span class="na">getActionConfig</span><span class="o">(</span><span class="n">namespace</span><span class="o">,</span> <span class="n">actionName</span><span class="o">);</span>
    
            <span class="k">if</span> <span class="o">(</span><span class="n">config</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">unknownHandlerManager</span><span class="o">.</span><span class="na">hasUnknownHandlers</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">config</span> <span class="o">=</span> <span class="n">unknownHandlerManager</span><span class="o">.</span><span class="na">handleUnknownAction</span><span class="o">(</span><span class="n">namespace</span><span class="o">,</span> <span class="n">actionName</span><span class="o">);</span>
            <span class="o">}</span>



            <span class="c1">// 没有配置action就抛出异常
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">config</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">String</span> <span class="n">message</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">namespace</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">namespace</span><span class="o">.</span><span class="na">trim</span><span class="o">().</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="n">LocalizedTextUtil</span><span class="o">.</span><span class="na">findDefaultText</span><span class="o">(</span><span class="n">XWorkMessages</span><span class="o">.</span><span class="na">MISSING_PACKAGE_ACTION_EXCEPTION</span><span class="o">,</span> <span class="n">Locale</span><span class="o">.</span><span class="na">getDefault</span><span class="o">(),</span> <span class="k">new</span> <span class="n">String</span><span class="o">[]{</span>
                        <span class="n">namespace</span><span class="o">,</span> <span class="n">actionName</span>
                    <span class="o">});</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="n">LocalizedTextUtil</span><span class="o">.</span><span class="na">findDefaultText</span><span class="o">(</span><span class="n">XWorkMessages</span><span class="o">.</span><span class="na">MISSING_ACTION_EXCEPTION</span><span class="o">,</span> <span class="n">Locale</span><span class="o">.</span><span class="na">getDefault</span><span class="o">(),</span> <span class="k">new</span> <span class="n">String</span><span class="o">[]{</span>
                        <span class="n">actionName</span>
                    <span class="o">});</span>
                <span class="o">}</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">ConfigurationException</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
            <span class="o">}</span>
           

            <span class="c1">// 这里比较有意思，如果访问的action没有指定method，那么就调用action的execute方法
</span><span class="c1"></span>            <span class="c1">// this.method = &#34;execute&#34;;
</span><span class="c1"></span>            <span class="n">resolveMethod</span><span class="o">();</span>
            
            <span class="k">if</span> <span class="o">(!</span><span class="n">config</span><span class="o">.</span><span class="na">isAllowedMethod</span><span class="o">(</span><span class="n">method</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">ConfigurationException</span><span class="o">(</span><span class="s">&#34;Invalid method: &#34;</span><span class="o">+</span><span class="n">method</span><span class="o">+</span><span class="s">&#34; for action &#34;</span><span class="o">+</span><span class="n">actionName</span><span class="o">);</span>
            <span class="o">}</span>


            <span class="c1">// 这里的invocation就是DefaultActionInvocation对象，调用DefaultActionInvocation的init方法
</span><span class="c1"></span>            <span class="c1">// 这里init做了太多的事情，里面最关键的是初始化了Struts2拦截器。
</span><span class="c1"></span>            <span class="c1">// 具体下方会贴出代码，简单看一下就行，就是个action执行前的初始化
</span><span class="c1"></span>            <span class="n">invocation</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>

        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">UtilTimerStack</span><span class="o">.</span><span class="na">pop</span><span class="o">(</span><span class="n">profileKey</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>DefaultActionInvocation对象的init方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">ActionProxy</span> <span class="n">proxy</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">proxy</span> <span class="o">=</span> <span class="n">proxy</span><span class="o">;</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">contextMap</span> <span class="o">=</span> <span class="n">createContextMap</span><span class="o">();</span>

        <span class="c1">// Setting this so that other classes, like object factories, can use the ActionProxy and other
</span><span class="c1"></span>        <span class="c1">// contextual information to operate
</span><span class="c1"></span>        <span class="n">ActionContext</span> <span class="n">actionContext</span> <span class="o">=</span> <span class="n">ActionContext</span><span class="o">.</span><span class="na">getContext</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">actionContext</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">actionContext</span><span class="o">.</span><span class="na">setActionInvocation</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">createAction</span><span class="o">(</span><span class="n">contextMap</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">pushAction</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">stack</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="n">action</span><span class="o">);</span>
            <span class="n">contextMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;action&#34;</span><span class="o">,</span> <span class="n">action</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">invocationContext</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ActionContext</span><span class="o">(</span><span class="n">contextMap</span><span class="o">);</span>

        <span class="c1">// 设置要调用的ActionName
</span><span class="c1"></span>        <span class="n">invocationContext</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">proxy</span><span class="o">.</span><span class="na">getActionName</span><span class="o">());</span>

        <span class="c1">// get a new List so we don&#39;t get problems with the iterator if someone changes the list
</span><span class="c1"></span>        <span class="c1">// 初始化拦截器列表
</span><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">InterceptorMapping</span><span class="o">&gt;</span> <span class="n">interceptorList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">InterceptorMapping</span><span class="o">&gt;(</span><span class="n">proxy</span><span class="o">.</span><span class="na">getConfig</span><span class="o">().</span><span class="na">getInterceptors</span><span class="o">());</span>
        <span class="n">interceptors</span> <span class="o">=</span> <span class="n">interceptorList</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
    <span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>Action代理类实例化已分析完成, 我们回去继续看Dispatcher的serviceAction的实现.</p>

<h4 id="2-action的执行">2. Action的执行</h4>

<p>我们在回顾一下serviceAction的代码实现:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// Dispatcher.java
</span><span class="c1"></span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Dispatcher</span> <span class="o">{</span>


    <span class="c1">// ... 省略n行代码
</span><span class="c1"></span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">serviceAction</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">ServletContext</span> <span class="n">context</span><span class="o">,</span>
                              <span class="n">ActionMapping</span> <span class="n">mapping</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span> <span class="o">{</span>

        <span class="c1">// ... 省略n行代码
</span><span class="c1"></span>        
        <span class="k">try</span> <span class="o">{</span>

            <span class="c1">// ... 省略n行代码
</span><span class="c1"></span>    
            <span class="n">ActionProxy</span> <span class="n">proxy</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">getContainer</span><span class="o">().</span><span class="na">getInstance</span><span class="o">(</span><span class="n">ActionProxyFactory</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">createActionProxy</span><span class="o">(</span>
                    <span class="n">namespace</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">method</span><span class="o">,</span> <span class="n">extraContext</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>


            <span class="c1">// ... 省略n行代码
</span><span class="c1"></span>

            <span class="c1">// result不为空，则调用result类的execute方法执行Action
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">mapping</span><span class="o">.</span><span class="na">getResult</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Result</span> <span class="n">result</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="na">getResult</span><span class="o">();</span>
                <span class="n">result</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">proxy</span><span class="o">.</span><span class="na">getInvocation</span><span class="o">());</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>

                <span class="c1">// 调用org.apache.struts2.impl.StrutsActionProxyFactory的execute方法执行
</span><span class="c1"></span>                <span class="n">proxy</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span>
            <span class="o">}</span>


            <span class="c1">// If there was a previous value stack then set it back onto the request
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(!</span><span class="n">nullStack</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">request</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="n">ServletActionContext</span><span class="o">.</span><span class="na">STRUTS_VALUESTACK_KEY</span><span class="o">,</span> <span class="n">stack</span><span class="o">);</span>
            <span class="o">}</span>

        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ConfigurationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
          <span class="c1">// ... 省略n行代码
</span><span class="c1"></span>        <span class="o">}</span>
    <span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>如上我们拆分为2个部分分析：</p>

<h4 id="1-result-execute-proxy-getinvocation">1. result.execute(proxy.getInvocation());</h4>

<p>如果我们正常访问<a href="http://localhost/index.action，这里的result一定为空，只有我们在用Struts2动态方法调用的时候，才会设置result，下方贴上动态方法调用的部分代码,回顾一下:">http://localhost/index.action，这里的result一定为空，只有我们在用Struts2动态方法调用的时候，才会设置result，下方贴上动态方法调用的部分代码,回顾一下:</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">     <span class="n">put</span><span class="o">(</span><span class="n">REDIRECT_PREFIX</span><span class="o">,</span> <span class="k">new</span> <span class="n">ParameterAction</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">ActionMapping</span> <span class="n">mapping</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">ServletRedirectResult</span> <span class="n">redirect</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServletRedirectResult</span><span class="o">();</span>
                <span class="n">container</span><span class="o">.</span><span class="na">inject</span><span class="o">(</span><span class="n">redirect</span><span class="o">);</span>
                <span class="n">redirect</span><span class="o">.</span><span class="na">setLocation</span><span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">REDIRECT_PREFIX</span>
                        <span class="o">.</span><span class="na">length</span><span class="o">()));</span>
                <span class="n">mapping</span><span class="o">.</span><span class="na">setResult</span><span class="o">(</span><span class="n">redirect</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>

        <span class="n">put</span><span class="o">(</span><span class="n">REDIRECT_ACTION_PREFIX</span><span class="o">,</span> <span class="k">new</span> <span class="n">ParameterAction</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">ActionMapping</span> <span class="n">mapping</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">String</span> <span class="n">location</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">REDIRECT_ACTION_PREFIX</span>
                        <span class="o">.</span><span class="na">length</span><span class="o">());</span>
                <span class="n">ServletRedirectResult</span> <span class="n">redirect</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServletRedirectResult</span><span class="o">();</span>
                <span class="n">container</span><span class="o">.</span><span class="na">inject</span><span class="o">(</span><span class="n">redirect</span><span class="o">);</span>
                <span class="n">String</span> <span class="n">extension</span> <span class="o">=</span> <span class="n">getDefaultExtension</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">extension</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">extension</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">location</span> <span class="o">+=</span> <span class="s">&#34;.&#34;</span> <span class="o">+</span> <span class="n">extension</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="n">redirect</span><span class="o">.</span><span class="na">setLocation</span><span class="o">(</span><span class="n">location</span><span class="o">);</span>
                <span class="n">mapping</span><span class="o">.</span><span class="na">setResult</span><span class="o">(</span><span class="n">redirect</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span></code></pre></td></tr></table>
</div>
</div>
<p>我们看一ServletRedirectResult类的execute方法实现：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ServletRedirectResult</span> <span class="kd">extends</span> <span class="n">StrutsResultSupport</span> <span class="kd">implements</span> <span class="n">ReflectionExceptionHandler</span> <span class="o">{</span>    
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="n">ActionInvocation</span> <span class="n">invocation</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">anchor</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">anchor</span> <span class="o">=</span> <span class="n">conditionalParse</span><span class="o">(</span><span class="n">anchor</span><span class="o">,</span> <span class="n">invocation</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">super</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">invocation</span><span class="o">);</span>
    <span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>可以看到其实是调用其父类StrutsResultSupport的execute方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">StrutsResultSupport</span> <span class="kd">implements</span> <span class="n">Result</span><span class="o">,</span> <span class="n">StrutsStatics</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="n">ActionInvocation</span> <span class="n">invocation</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>

        <span class="c1">//  执行location得到string返回结果
</span><span class="c1"></span>        <span class="n">lastFinalLocation</span> <span class="o">=</span> <span class="n">conditionalParse</span><span class="o">(</span><span class="n">location</span><span class="o">,</span> <span class="n">invocation</span><span class="o">);</span>

        <span class="c1">// 调用其子类ServletRedirectResult的doExecute
</span><span class="c1"></span>        <span class="n">doExecute</span><span class="o">(</span><span class="n">lastFinalLocation</span><span class="o">,</span> <span class="n">invocation</span><span class="o">);</span>
    <span class="o">}</span>



    <span class="kd">protected</span> <span class="n">String</span> <span class="nf">conditionalParse</span><span class="o">(</span><span class="n">String</span> <span class="n">param</span><span class="o">,</span> <span class="n">ActionInvocation</span> <span class="n">invocation</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">parse</span> <span class="o">&amp;&amp;</span> <span class="n">param</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">invocation</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
   
            <span class="c1">// 执行location得到string返回结果
</span><span class="c1"></span>            <span class="c1">// 通过OGNL表达式从invocation对象的stack中进行查找location
</span><span class="c1"></span>            <span class="c1">// 这里也就是s2-016漏洞出现的原因
</span><span class="c1"></span>            <span class="c1">// 这里重写了ParsedValueEvaluator的evaluate，目的是为了对stack.findValue(localtion)返回的string进行编码
</span><span class="c1"></span>            <span class="c1">// 关于stack.findValue之前有分析过，就是调用Ognl表达式
</span><span class="c1"></span>            <span class="k">return</span> <span class="n">TextParseUtil</span><span class="o">.</span><span class="na">translateVariables</span><span class="o">(</span><span class="n">param</span><span class="o">,</span> <span class="n">invocation</span><span class="o">.</span><span class="na">getStack</span><span class="o">(),</span>
                    <span class="k">new</span> <span class="n">TextParseUtil</span><span class="o">.</span><span class="na">ParsedValueEvaluator</span><span class="o">()</span> <span class="o">{</span>
                        <span class="kd">public</span> <span class="n">Object</span> <span class="nf">evaluate</span><span class="o">(</span><span class="n">Object</span> <span class="n">parsedValue</span><span class="o">)</span> <span class="o">{</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">encode</span><span class="o">)</span> <span class="o">{</span>
                                <span class="k">if</span> <span class="o">(</span><span class="n">parsedValue</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                                    <span class="k">try</span> <span class="o">{</span>
                                        <span class="c1">// use UTF-8 as this is the recommended encoding by W3C to
</span><span class="c1"></span>                                        <span class="c1">// avoid incompatibilities.
</span><span class="c1"></span>                                        <span class="k">return</span> <span class="n">URLEncoder</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">parsedValue</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="s">&#34;UTF-8&#34;</span><span class="o">);</span>
                                    <span class="o">}</span>
                                    <span class="k">catch</span><span class="o">(</span><span class="n">UnsupportedEncodingException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                                        <span class="n">LOG</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&#34;error while trying to encode [&#34;</span><span class="o">+</span><span class="n">parsedValue</span><span class="o">+</span><span class="s">&#34;]&#34;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
                                    <span class="o">}</span>
                                <span class="o">}</span>
                            <span class="o">}</span>
                            <span class="k">return</span> <span class="n">parsedValue</span><span class="o">;</span>
                        <span class="o">}</span>
            <span class="o">});</span>

        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">param</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>


   <span class="kd">protected</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">doExecute</span><span class="o">(</span><span class="n">String</span> <span class="n">finalLocation</span><span class="o">,</span> <span class="n">ActionInvocation</span> <span class="n">invocation</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span></code></pre></td></tr></table>
</div>
</div>
<p>从上方代码我们得出执行location得到的stirng。</p>

<blockquote>
<p>TIPS : 这里之所以用ognl进行查找，我猜想可能是加强一下重定向功能，但是拿localtion作为表达式。。。呵呵哒</p>
</blockquote>

<p>我们继续看一下ServletRedirectResult类的doExecute方法对这个string都做了什么？</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"> <span class="cm">/**
</span><span class="cm">     * Redirects to the location specified by calling {@link HttpServletResponse#sendRedirect(String)}.
</span><span class="cm">     *
</span><span class="cm">     * @param finalLocation the location to redirect to.
</span><span class="cm">     * @param invocation    an encapsulation of the action execution state.
</span><span class="cm">     * @throws Exception if an error occurs when redirecting.
</span><span class="cm">     */</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doExecute</span><span class="o">(</span><span class="n">String</span> <span class="n">finalLocation</span><span class="o">,</span> <span class="n">ActionInvocation</span> <span class="n">invocation</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">ActionContext</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">invocation</span><span class="o">.</span><span class="na">getInvocationContext</span><span class="o">();</span>
        <span class="n">HttpServletRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="o">(</span><span class="n">HttpServletRequest</span><span class="o">)</span> <span class="n">ctx</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">ServletActionContext</span><span class="o">.</span><span class="na">HTTP_REQUEST</span><span class="o">);</span>
        <span class="n">HttpServletResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="o">(</span><span class="n">HttpServletResponse</span><span class="o">)</span> <span class="n">ctx</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">ServletActionContext</span><span class="o">.</span><span class="na">HTTP_RESPONSE</span><span class="o">);</span>

        <span class="c1">// 这里确定是我们重定向的不是一个外部地址
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">isPathUrl</span><span class="o">(</span><span class="n">finalLocation</span><span class="o">))</span> <span class="o">{</span>

            <span class="c1">// 加入redirect：的value前没有/, 则获取配置文件中的namespace，追加到location前方
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(!</span><span class="n">finalLocation</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&#34;/&#34;</span><span class="o">))</span> <span class="o">{</span>

                <span class="n">ActionMapping</span> <span class="n">mapping</span> <span class="o">=</span> <span class="n">actionMapper</span><span class="o">.</span><span class="na">getMapping</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">Dispatcher</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">getConfigurationManager</span><span class="o">());</span> 
                <span class="n">String</span> <span class="n">namespace</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">mapping</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">namespace</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="na">getNamespace</span><span class="o">();</span>
                <span class="o">}</span>

                <span class="k">if</span> <span class="o">((</span><span class="n">namespace</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">namespace</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(!</span><span class="s">&#34;/&#34;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">namespace</span><span class="o">)))</span> <span class="o">{</span>
                    <span class="n">finalLocation</span> <span class="o">=</span> <span class="n">namespace</span> <span class="o">+</span> <span class="s">&#34;/&#34;</span> <span class="o">+</span> <span class="n">finalLocation</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">finalLocation</span> <span class="o">=</span> <span class="s">&#34;/&#34;</span> <span class="o">+</span> <span class="n">finalLocation</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>



            <span class="c1">// if the URL&#39;s are relative to the servlet context, append the servlet context path
</span><span class="c1"></span>            <span class="c1">// 将Request的上下文路径也追加到location前方
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">prependServletContext</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getContextPath</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getContextPath</span><span class="o">().</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">finalLocation</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getContextPath</span><span class="o">()</span> <span class="o">+</span> <span class="n">finalLocation</span><span class="o">;</span>
            <span class="o">}</span>



            <span class="c1">// 获取配置文件中Result标签里param标签的配置，进行解析参数
</span><span class="c1"></span>            <span class="n">ResultConfig</span> <span class="n">resultConfig</span> <span class="o">=</span> <span class="n">invocation</span><span class="o">.</span><span class="na">getProxy</span><span class="o">().</span><span class="na">getConfig</span><span class="o">().</span><span class="na">getResults</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">invocation</span><span class="o">.</span><span class="na">getResultCode</span><span class="o">());</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">resultConfig</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">)</span> <span class="o">{</span>
                <span class="n">Map</span> <span class="n">resultConfigParams</span> <span class="o">=</span> <span class="n">resultConfig</span><span class="o">.</span><span class="na">getParams</span><span class="o">();</span>
                <span class="k">for</span> <span class="o">(</span><span class="n">Iterator</span> <span class="n">i</span> <span class="o">=</span> <span class="n">resultConfigParams</span><span class="o">.</span><span class="na">entrySet</span><span class="o">().</span><span class="na">iterator</span><span class="o">();</span> <span class="n">i</span><span class="o">.</span><span class="na">hasNext</span><span class="o">();)</span> <span class="o">{</span>
                    <span class="n">Map</span><span class="o">.</span><span class="na">Entry</span> <span class="n">e</span> <span class="o">=</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">)</span> <span class="n">i</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>

                    <span class="k">if</span> <span class="o">(!</span><span class="n">getProhibitedResultParams</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getKey</span><span class="o">()))</span> <span class="o">{</span>

                        <span class="c1">// 解析参数
</span><span class="c1"></span>
                        <span class="c1">// &lt;result name=&#34;success&#34; type=&#34;redirect&#34;&gt;  
</span><span class="c1"></span>                        <span class="c1">//       &lt;param name=&#34;location&#34;&gt;foo.jsp&lt;/param&gt;
</span><span class="c1"></span>                        <span class="c1">//       &lt;param name=&#34;parse&#34;&gt;false&lt;/param&gt;&lt;!--不解析OGNL--&gt;
</span><span class="c1"></span>                        <span class="c1">// &lt;/result&gt;
</span><span class="c1"></span>

                        <span class="c1">// 又调用conditionalParse解析
</span><span class="c1"></span>                        <span class="n">requestParameters</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getKey</span><span class="o">().</span><span class="na">toString</span><span class="o">(),</span> <span class="n">e</span><span class="o">.</span><span class="na">getValue</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="s">&#34;&#34;</span> <span class="o">:</span> <span class="n">conditionalParse</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getValue</span><span class="o">().</span><span class="na">toString</span><span class="o">(),</span> <span class="n">invocation</span><span class="o">));</span>
                        
                        <span class="n">String</span> <span class="n">potentialValue</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">getValue</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="s">&#34;&#34;</span> <span class="o">:</span> <span class="n">conditionalParse</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getValue</span><span class="o">().</span><span class="na">toString</span><span class="o">(),</span> <span class="n">invocation</span><span class="o">);</span>
                        
                        <span class="k">if</span> <span class="o">(!</span><span class="n">supressEmptyParameters</span> <span class="o">||</span> <span class="o">((</span><span class="n">potentialValue</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">potentialValue</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)))</span> <span class="o">{</span>
                            <span class="n">requestParameters</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getKey</span><span class="o">().</span><span class="na">toString</span><span class="o">(),</span> <span class="n">potentialValue</span><span class="o">);</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>


            <span class="c1">// 将localtion和参数合并
</span><span class="c1"></span>            <span class="n">StringBuilder</span> <span class="n">tmpLocation</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">(</span><span class="n">finalLocation</span><span class="o">);</span>
            <span class="n">UrlHelper</span><span class="o">.</span><span class="na">buildParametersString</span><span class="o">(</span><span class="n">requestParameters</span><span class="o">,</span> <span class="n">tmpLocation</span><span class="o">,</span> <span class="s">&#34;&amp;&#34;</span><span class="o">);</span>

            <span class="c1">// add the anchor
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">anchor</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">tmpLocation</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">&#39;#&#39;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">anchor</span><span class="o">);</span>
            <span class="o">}</span>
         
            <span class="c1">// 对要重定向的location进行编码
</span><span class="c1"></span>            <span class="n">finalLocation</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">encodeRedirectURL</span><span class="o">(</span><span class="n">tmpLocation</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">LOG</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Redirecting to finalLocation &#34;</span> <span class="o">+</span> <span class="n">finalLocation</span><span class="o">);</span>
        <span class="o">}</span>

    
        <span class="c1">// 开始重定向    
</span><span class="c1"></span>        <span class="n">sendRedirect</span><span class="o">(</span><span class="n">response</span><span class="o">,</span> <span class="n">finalLocation</span><span class="o">);</span>
    <span class="o">}</span>


     <span class="c1">// 写入response
</span><span class="c1"></span>     <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">sendRedirect</span><span class="o">(</span><span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">String</span> <span class="n">finalLocation</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">SC_FOUND</span> <span class="o">==</span> <span class="n">statusCode</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">response</span><span class="o">.</span><span class="na">sendRedirect</span><span class="o">(</span><span class="n">finalLocation</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">response</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="n">statusCode</span><span class="o">);</span>
            <span class="n">response</span><span class="o">.</span><span class="na">setHeader</span><span class="o">(</span><span class="s">&#34;Location&#34;</span><span class="o">,</span> <span class="n">finalLocation</span><span class="o">);</span>
            <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="n">finalLocation</span><span class="o">);</span>
            <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>

    <span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>result执行，分析结束.</p>

<h4 id="2-proxy-execute">2. proxy.execute();</h4>

<p>终于要大结局了，来，我们看一下 StrutsActionProxy.execute方法的实现，</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StrutsActionProxy</span> <span class="kd">extends</span> <span class="n">DefaultActionProxy</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="o">-</span><span class="n">2434901249671934080L</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">StrutsActionProxy</span><span class="o">(</span><span class="n">ActionInvocation</span> <span class="n">inv</span><span class="o">,</span> <span class="n">String</span> <span class="n">namespace</span><span class="o">,</span> <span class="n">String</span> <span class="n">actionName</span><span class="o">,</span> <span class="n">String</span> <span class="n">methodName</span><span class="o">,</span>
                             <span class="kt">boolean</span> <span class="n">executeResult</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">cleanupContext</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">inv</span><span class="o">,</span> <span class="n">namespace</span><span class="o">,</span> <span class="n">actionName</span><span class="o">,</span> <span class="n">methodName</span><span class="o">,</span> <span class="n">executeResult</span><span class="o">,</span> <span class="n">cleanupContext</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">execute</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">ActionContext</span> <span class="n">previous</span> <span class="o">=</span> <span class="n">ActionContext</span><span class="o">.</span><span class="na">getContext</span><span class="o">();</span>
        <span class="n">ActionContext</span><span class="o">.</span><span class="na">setContext</span><span class="o">(</span><span class="n">invocation</span><span class="o">.</span><span class="na">getInvocationContext</span><span class="o">());</span>
        <span class="k">try</span> <span class="o">{</span>
            
            <span class="c1">// 这里我们调用的是DefaultActionInvocation的invoke方法
</span><span class="c1"></span>            <span class="k">return</span> <span class="n">invocation</span><span class="o">.</span><span class="na">invoke</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">cleanupContext</span><span class="o">)</span>
                <span class="n">ActionContext</span><span class="o">.</span><span class="na">setContext</span><span class="o">(</span><span class="n">previous</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">prepare</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">prepare</span><span class="o">();</span>
    <span class="o">}</span>

<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>DefaultActionInvocation的invoke方法的实现：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DefaultActionInvocation</span> <span class="kd">implements</span> <span class="n">ActionInvocation</span> <span class="o">{</span>

 <span class="kd">public</span> <span class="n">String</span> <span class="nf">invoke</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">profileKey</span> <span class="o">=</span> <span class="s">&#34;invoke: &#34;</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">UtilTimerStack</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="n">profileKey</span><span class="o">);</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">executed</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="s">&#34;Action has already executed&#34;</span><span class="o">);</span>
            <span class="o">}</span>



            <span class="c1">// 遍历Struts2的拦截器，并调用每个拦截器的intercept方法，返回每个拦截器的resultCode
</span><span class="c1"></span>            <span class="c1">// 由于拦截器太多了，我们这里就不分析了
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">interceptors</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
                <span class="kd">final</span> <span class="n">InterceptorMapping</span> <span class="n">interceptor</span> <span class="o">=</span> <span class="o">(</span><span class="n">InterceptorMapping</span><span class="o">)</span> <span class="n">interceptors</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
                <span class="n">String</span> <span class="n">interceptorMsg</span> <span class="o">=</span> <span class="s">&#34;interceptor: &#34;</span> <span class="o">+</span> <span class="n">interceptor</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
                <span class="n">UtilTimerStack</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="n">interceptorMsg</span><span class="o">);</span>
                <span class="k">try</span> <span class="o">{</span>
                                <span class="n">resultCode</span> <span class="o">=</span> <span class="n">interceptor</span><span class="o">.</span><span class="na">getInterceptor</span><span class="o">().</span><span class="na">intercept</span><span class="o">(</span><span class="n">DefaultActionInvocation</span><span class="o">.</span><span class="na">this</span><span class="o">);</span>
                            <span class="o">}</span>
                <span class="k">finally</span> <span class="o">{</span>
                    <span class="n">UtilTimerStack</span><span class="o">.</span><span class="na">pop</span><span class="o">(</span><span class="n">interceptorMsg</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>



                <span class="c1">// 拦截器调用完后，才是我们用户自定义action的调用，下方我们好好分析一下这个方法
</span><span class="c1"></span>                <span class="n">resultCode</span> <span class="o">=</span> <span class="n">invokeActionOnly</span><span class="o">();</span>
            <span class="o">}</span>

             
            <span class="c1">// this is needed because the result will be executed, then control will return to the Interceptor, which will
</span><span class="c1"></span>            <span class="c1">// return above and flow through again
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(!</span><span class="n">executed</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">preResultListeners</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">for</span> <span class="o">(</span><span class="n">Object</span> <span class="n">preResultListener</span> <span class="o">:</span> <span class="n">preResultListeners</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">PreResultListener</span> <span class="n">listener</span> <span class="o">=</span> <span class="o">(</span><span class="n">PreResultListener</span><span class="o">)</span> <span class="n">preResultListener</span><span class="o">;</span>

                        <span class="n">String</span> <span class="n">_profileKey</span> <span class="o">=</span> <span class="s">&#34;preResultListener: &#34;</span><span class="o">;</span>
                        <span class="k">try</span> <span class="o">{</span>
                            <span class="n">UtilTimerStack</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="n">_profileKey</span><span class="o">);</span>
                            <span class="n">listener</span><span class="o">.</span><span class="na">beforeResult</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">resultCode</span><span class="o">);</span>
                        <span class="o">}</span>
                        <span class="k">finally</span> <span class="o">{</span>
                            <span class="n">UtilTimerStack</span><span class="o">.</span><span class="na">pop</span><span class="o">(</span><span class="n">_profileKey</span><span class="o">);</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>

                <span class="c1">// 当执行完了用户的indexAction，开始对result进行处理
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">proxy</span><span class="o">.</span><span class="na">getExecuteResult</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">executeResult</span><span class="o">();</span>
                <span class="o">}</span>

                <span class="n">executed</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="k">return</span> <span class="n">resultCode</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">finally</span> <span class="o">{</span>
            <span class="n">UtilTimerStack</span><span class="o">.</span><span class="na">pop</span><span class="o">(</span><span class="n">profileKey</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>我们看一下invokeActionOnly的实现：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span><span class="lnt">98
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">invokeActionOnly</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">invokeAction</span><span class="o">(</span><span class="n">getAction</span><span class="o">(),</span> <span class="n">proxy</span><span class="o">.</span><span class="na">getConfig</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getAction</span><span class="o">()</span> <span class="o">{</span>

        <span class="c1">// 拿到我们的indexAction对象
</span><span class="c1"></span>        <span class="k">return</span> <span class="n">action</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="kd">protected</span> <span class="n">String</span> <span class="nf">invokeAction</span><span class="o">(</span><span class="n">Object</span> <span class="n">action</span><span class="o">,</span> <span class="n">ActionConfig</span> <span class="n">actionConfig</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>

        <span class="c1">// 得到indexAction的执行方法名
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">methodName</span> <span class="o">=</span> <span class="n">proxy</span><span class="o">.</span><span class="na">getMethod</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">LOG</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Executing action method = &#34;</span> <span class="o">+</span> <span class="n">actionConfig</span><span class="o">.</span><span class="na">getMethodName</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="n">String</span> <span class="n">timerKey</span> <span class="o">=</span> <span class="s">&#34;invokeAction: &#34;</span> <span class="o">+</span> <span class="n">proxy</span><span class="o">.</span><span class="na">getActionName</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">UtilTimerStack</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="n">timerKey</span><span class="o">);</span>

            <span class="kt">boolean</span> <span class="n">methodCalled</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="n">Object</span> <span class="n">methodResult</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="n">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">try</span> <span class="o">{</span>

                <span class="c1">// 得到method对象
</span><span class="c1"></span>                <span class="n">method</span> <span class="o">=</span> <span class="n">getAction</span><span class="o">().</span><span class="na">getClass</span><span class="o">().</span><span class="na">getMethod</span><span class="o">(</span><span class="n">methodName</span><span class="o">,</span> <span class="n">EMPTY_CLASS_ARRAY</span><span class="o">);</span>

            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchMethodException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// hmm -- OK, try doXxx instead
</span><span class="c1"></span>                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">String</span> <span class="n">altMethodName</span> <span class="o">=</span> <span class="s">&#34;do&#34;</span> <span class="o">+</span> <span class="n">methodName</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">1</span><span class="o">).</span><span class="na">toUpperCase</span><span class="o">()</span> <span class="o">+</span> <span class="n">methodName</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>

                    <span class="c1">// 额。。看懂了吧？ 这又是一个风骚的操作，带有do的方法名
</span><span class="c1"></span>                    <span class="n">method</span> <span class="o">=</span> <span class="n">getAction</span><span class="o">().</span><span class="na">getClass</span><span class="o">().</span><span class="na">getMethod</span><span class="o">(</span><span class="n">altMethodName</span><span class="o">,</span> <span class="n">EMPTY_CLASS_ARRAY</span><span class="o">);</span>

                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchMethodException</span> <span class="n">e1</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// well, give the unknown handler a shot
</span><span class="c1"></span>                    <span class="k">if</span> <span class="o">(</span><span class="n">unknownHandlerManager</span><span class="o">.</span><span class="na">hasUnknownHandlers</span><span class="o">())</span> <span class="o">{</span>
                        <span class="k">try</span> <span class="o">{</span>
                            <span class="n">methodResult</span> <span class="o">=</span> <span class="n">unknownHandlerManager</span><span class="o">.</span><span class="na">handleUnknownMethod</span><span class="o">(</span><span class="n">action</span><span class="o">,</span> <span class="n">methodName</span><span class="o">);</span>
                            <span class="n">methodCalled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchMethodException</span> <span class="n">e2</span><span class="o">)</span> <span class="o">{</span>
                            <span class="c1">// throw the original one
</span><span class="c1"></span>                            <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
                        <span class="o">}</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>

            <span class="k">if</span> <span class="o">(!</span><span class="n">methodCalled</span><span class="o">)</span> <span class="o">{</span>

                <span class="c1">// 用java的反射，调用indexAction的方法,得到result结果
</span><span class="c1"></span>                <span class="n">methodResult</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">action</span><span class="o">,</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[</span><span class="n">0</span><span class="o">]);</span>
            <span class="o">}</span>

        

            <span class="c1">// 这里扩展了返回结果的类型，具体可以看struts-default.xml中的配置, 好多好多result扩展类型
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">methodResult</span> <span class="k">instanceof</span> <span class="n">Result</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">this</span><span class="o">.</span><span class="na">explicitResult</span> <span class="o">=</span> <span class="o">(</span><span class="n">Result</span><span class="o">)</span> <span class="n">methodResult</span><span class="o">;</span>

                <span class="c1">// Wire the result automatically
</span><span class="c1"></span>                <span class="n">container</span><span class="o">.</span><span class="na">inject</span><span class="o">(</span><span class="n">explicitResult</span><span class="o">);</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>

                <span class="c1">// 返回普通的string结果
</span><span class="c1"></span>                <span class="k">return</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">methodResult</span><span class="o">;</span>
            <span class="o">}</span>

        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchMethodException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;The &#34;</span> <span class="o">+</span> <span class="n">methodName</span> <span class="o">+</span> <span class="s">&#34;() is not defined in action &#34;</span> <span class="o">+</span> <span class="n">getAction</span><span class="o">().</span><span class="na">getClass</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;&#34;</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InvocationTargetException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// We try to return the source exception.
</span><span class="c1"></span>            <span class="n">Throwable</span> <span class="n">t</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">getTargetException</span><span class="o">();</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">actionEventListener</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">actionEventListener</span><span class="o">.</span><span class="na">handleException</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">getStack</span><span class="o">());</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">t</span> <span class="k">instanceof</span> <span class="n">Exception</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="o">(</span><span class="n">Exception</span><span class="o">)</span> <span class="n">t</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">UtilTimerStack</span><span class="o">.</span><span class="na">pop</span><span class="o">(</span><span class="n">timerKey</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>好了，分析完了action的执行，我们看一下结果处理，回顾一下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">    <span class="n">resultCode</span> <span class="o">=</span> <span class="n">invokeActionOnly</span><span class="o">();</span>

    
    <span class="c1">// 省略n行代码
</span><span class="c1"></span>
    <span class="k">if</span> <span class="o">(</span><span class="n">proxy</span><span class="o">.</span><span class="na">getExecuteResult</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">executeResult</span><span class="o">();</span>
    <span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>看一下executeResult的实现：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">    <span class="cm">/**
</span><span class="cm">     * Uses getResult to get the final Result and executes it
</span><span class="cm">     *
</span><span class="cm">     * @throws ConfigurationException If not result can be found with the returned code
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">executeResult</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>


        <span class="c1">// 创建ServletDispchterResult对象，
</span><span class="c1"></span>        <span class="c1">// 通过配置文件获取result配置信息，查找到location
</span><span class="c1"></span>        <span class="c1">// 设置ServletDispchterResult对象的location为配置文件获得location
</span><span class="c1"></span>        <span class="n">result</span> <span class="o">=</span> <span class="n">createResult</span><span class="o">();</span>

        <span class="n">String</span> <span class="n">timerKey</span> <span class="o">=</span> <span class="s">&#34;executeResult: &#34;</span> <span class="o">+</span> <span class="n">getResultCode</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">UtilTimerStack</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="n">timerKey</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>

                <span class="c1">// 执行result
</span><span class="c1"></span>                <span class="c1">// 最终还是调用的ServletDispchterResult的doExecute方法
</span><span class="c1"></span>                <span class="c1">// 下方我们看一下这个方法的具体实现
</span><span class="c1"></span>                <span class="n">result</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>

            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">resultCode</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">Action</span><span class="o">.</span><span class="na">NONE</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">resultCode</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">ConfigurationException</span><span class="o">(</span><span class="s">&#34;No result defined for action &#34;</span> <span class="o">+</span> <span class="n">getAction</span><span class="o">().</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span>
                        <span class="o">+</span> <span class="s">&#34; and result &#34;</span> <span class="o">+</span> <span class="n">getResultCode</span><span class="o">(),</span> <span class="n">proxy</span><span class="o">.</span><span class="na">getConfig</span><span class="o">());</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">LOG</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;No result returned for action &#34;</span> <span class="o">+</span> <span class="n">getAction</span><span class="o">().</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34; at &#34;</span> <span class="o">+</span> <span class="n">proxy</span><span class="o">.</span><span class="na">getConfig</span><span class="o">().</span><span class="na">getLocation</span><span class="o">());</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">UtilTimerStack</span><span class="o">.</span><span class="na">pop</span><span class="o">(</span><span class="n">timerKey</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>ServletDispchterResult的doExecute方法的实现：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// 加入我们的配置文件里的location是：/WEB-INF/jsp/index.jsp
</span><span class="c1"></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">doExecute</span><span class="o">(</span><span class="n">String</span> <span class="n">finalLocation</span><span class="o">,</span> <span class="n">ActionInvocation</span> <span class="n">invocation</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">LOG</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Forwarding to location &#34;</span> <span class="o">+</span> <span class="n">finalLocation</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">PageContext</span> <span class="n">pageContext</span> <span class="o">=</span> <span class="n">ServletActionContext</span><span class="o">.</span><span class="na">getPageContext</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">pageContext</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">pageContext</span><span class="o">.</span><span class="na">include</span><span class="o">(</span><span class="n">finalLocation</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">HttpServletRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="n">ServletActionContext</span><span class="o">.</span><span class="na">getRequest</span><span class="o">();</span>
            <span class="n">HttpServletResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">ServletActionContext</span><span class="o">.</span><span class="na">getResponse</span><span class="o">();</span>

            <span class="c1">// 将配置文件中的location传递给系统Servlet的getRequestDispatcher方法
</span><span class="c1"></span>            <span class="c1">// 关于Servlet的getRequestDispatcher方法，参考[3]
</span><span class="c1"></span>            <span class="c1">// 这里仅是构造dispatcher,（这是java的servlet的编程， 非struts2）
</span><span class="c1"></span>            <span class="n">RequestDispatcher</span> <span class="n">dispatcher</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getRequestDispatcher</span><span class="o">(</span><span class="n">finalLocation</span><span class="o">);</span>

            <span class="c1">//add parameters passed on the location to #parameters
</span><span class="c1"></span>            <span class="c1">// see WW-2120
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">invocation</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">finalLocation</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">finalLocation</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">0</span>
                    <span class="o">&amp;&amp;</span> <span class="n">finalLocation</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="s">&#34;?&#34;</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">String</span> <span class="n">queryString</span> <span class="o">=</span> <span class="n">finalLocation</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">finalLocation</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="s">&#34;?&#34;</span><span class="o">)</span> <span class="o">+</span> <span class="n">1</span><span class="o">);</span>
                <span class="n">Map</span> <span class="n">parameters</span> <span class="o">=</span> <span class="o">(</span><span class="n">Map</span><span class="o">)</span> <span class="n">invocation</span><span class="o">.</span><span class="na">getInvocationContext</span><span class="o">().</span><span class="na">getContextMap</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;parameters&#34;</span><span class="o">);</span>
                <span class="n">Map</span> <span class="n">queryParams</span> <span class="o">=</span> <span class="n">UrlHelper</span><span class="o">.</span><span class="na">parseQueryString</span><span class="o">(</span><span class="n">queryString</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">queryParams</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">queryParams</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span>
                    <span class="n">parameters</span><span class="o">.</span><span class="na">putAll</span><span class="o">(</span><span class="n">queryParams</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="c1">// if the view doesn&#39;t exist, let&#39;s do a 404
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">dispatcher</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">response</span><span class="o">.</span><span class="na">sendError</span><span class="o">(</span><span class="n">404</span><span class="o">,</span> <span class="s">&#34;result &#39;&#34;</span> <span class="o">+</span> <span class="n">finalLocation</span> <span class="o">+</span> <span class="s">&#34;&#39; not found&#34;</span><span class="o">);</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="c1">//if we are inside an action tag, we always need to do an include
</span><span class="c1"></span>            <span class="n">Boolean</span> <span class="n">insideActionTag</span> <span class="o">=</span> <span class="o">(</span><span class="n">Boolean</span><span class="o">)</span> <span class="n">ObjectUtils</span><span class="o">.</span><span class="na">defaultIfNull</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">StrutsStatics</span><span class="o">.</span><span class="na">STRUTS_ACTION_TAG_INVOCATION</span><span class="o">),</span> <span class="n">Boolean</span><span class="o">.</span><span class="na">FALSE</span><span class="o">);</span>

            <span class="c1">// If we&#39;re included, then include the view
</span><span class="c1"></span>            <span class="c1">// Otherwise do forward
</span><span class="c1"></span>            <span class="c1">// This allow the page to, for example, set content type
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(!</span><span class="n">insideActionTag</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">response</span><span class="o">.</span><span class="na">isCommitted</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">&#34;javax.servlet.include.servlet_path&#34;</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">request</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">&#34;struts.view_uri&#34;</span><span class="o">,</span> <span class="n">finalLocation</span><span class="o">);</span>
                <span class="n">request</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">&#34;struts.request_uri&#34;</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getRequestURI</span><span class="o">());</span>

                <span class="c1">// 转发到 /WEB-INF/jsp/index.jsp ，由jsp进行相应操作
</span><span class="c1"></span>                <span class="n">dispatcher</span><span class="o">.</span><span class="na">forward</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">dispatcher</span><span class="o">.</span><span class="na">include</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>目前我们已经分析完成Action的执行和Result处理的所有流程，最后可以看到Result结果处理使用的是Servlet的API，具体可以参考[4].</p>

<p>下一篇我们分析一下Struts2的标签库</p>

<h3 id="参考">参考</h3>

<ol>
<li><a href="https://www.jianshu.com/p/de165430e8a8">S2-016远程代码执行漏洞分析</a></li>
<li><a href="https://www.cnblogs.com/seeto/archive/2013/04/03/2998235.html?utm_source=tuicool&amp;utm_medium=referral">struts2实现的简单的Trie树</a></li>
<li><a href="https://www.cnblogs.com/w-wfy/p/6387538.html">getRequestDispatcher 和sendRedirect区别及路径问题</a></li>
<li><a href="https://www.cnblogs.com/lulipro/p/7471987.html">Servlet中关于RequestDispatcher的原理</a></li>
</ol>

    </article>




    <ul class="pager article-pager">
      <li class="pager-newer">
          <a href="/posts/luckycat/" data-toggle="tooltip" data-placement="top" title="My Lucky Cat">&lt; Newer</a>
      </li>
      <li class="pager-older">
        <a href="/posts/struts2-internals-readbook-note_05/" data-toggle="tooltip" data-placement="top" title="Struts2 运行流程分析之Dispatcher初始化">Older &gt;</a>
      </li>
    </ul>

          <div id="gitalk-container"></div>
  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
  <script>
var gitalk = new Gitalk({
  clientID: '2f61b9423ddfde01f318',
  clientSecret: 'ae6360004775eb79f1069c0ea047f2fcd0f8cfc7',
  repo: 'dean2021.github.io',
  owner: 'dean2021',
  admin: ['dean2021'],
  id: location.pathname,      
  distractionFreeMode: false  
})

gitalk.render('gitalk-container')
  </script>



  </div>


<div class="site-footer">
  <div class="copyright">&copy; Copyright 2018 Dean</div>
  <ul class="site-footer-items">
    <li class="site-footer-item-about"><a href="/about/" title="About">About</a></li>
  </ul>
  <div class="powerdby">
    Powered by <a href="https://gohugo.io/">Hugo</a>  and Dean
  </div>
</div>


</body>
</html>
