<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <title>《Struts2 技术内幕》读书笔记: XWork中的容器 - Dean&#39;s blog</title>
  <meta property="og:title" content="《Struts2 技术内幕》读书笔记: XWork中的容器 - Dean&#39;s blog" />
  <meta name="twitter:title" content="《Struts2 技术内幕》读书笔记: XWork中的容器 - Dean&#39;s blog" />
  <meta name="description" content="&ldquo;容器&rdquo;是用来解决：“在程序的运行期，应该如何创建我们需要的对象？” 和 &ldquo;当创建新对象，该对象依赖的对象也能正确被创建出来？&rdquo;
 对象的生命周期管理包含哪两个方面的内容 ？  在程序运行期，对象实例的创建和引用机制. 对象与其关联的对象的依赖关系的处理机制.">
  <meta property="og:description" content="&ldquo;容器&rdquo;是用来解决：“在程序的运行期，应该如何创建我们需要的对象？” 和 &ldquo;当创建新对象，该对象依赖的对象也能正确被创建出来？&rdquo;
 对象的生命周期管理包含哪两个方面的内容 ？  在程序运行期，对象实例的创建和引用机制. 对象与其关联的对象的依赖关系的处理机制.">
  <meta name="twitter:description" content="&ldquo;容器&rdquo;是用来解决：“在程序的运行期，应该如何创建我们需要的对象？” 和 &ldquo;当创建新对象，该对象依赖的对象也能正确被创建出来？&rdquo;
 对象的生命周期管理包含哪两个方面的内容 ？  在程序运行期，对象实例的创建和引用机制. 对象与其关联的对象的依赖关系的处理机制.">
  <meta name="author" content="Dean"/>
  <meta property="og:site_name" content="Dean&#39;s blog" />
  <meta property="og:url" content="https://dean2021.github.io/posts/struts2-internals-readbook-note_02/" />
  <meta property="og:type" content="article" />
  <meta name="twitter:card" content="summary" />
  <meta name="generator" content="Hugo 0.42.1" />

  <link rel="stylesheet" href="/css/style.css" media="all" />
  <link rel="stylesheet" href="/css/syntax.css" media="all" />
  <link rel="stylesheet" href="/css/custom.css" media="all" />

  <script src="/js/script.js"></script>
  <script src="/js/custom.js"></script>
  <script defer src="/js/fontawesome.js"></script>
</head>

<body>

<header class="site-header">
  <nav class="site-navi">
    <h1 class="site-title"><a href="/">Dean&#39;s blog</a></h1>
    <ul class="site-navi-items">
      <li class="site-navi-item-categories"><a href="/categories/" title="Categories">Categories</a></li>
      <li class="site-navi-item-tags"><a href="/tags/" title="Tags">Tags</a></li>
      <li class="site-navi-item-archives"><a href="/archives/" title="Archives">Archives</a></li>
      <li class="site-navi-item-about"><a href="/about/" title="About">About</a></li>
    </ul>
  </nav>
</header>
<hr class="site-header-bottom">

  <div class="main" role="main">
    <article class="article">
      
      
      <h1 class="article-title">《Struts2 技术内幕》读书笔记: XWork中的容器</h1>
      
      <hr class="article-title-bottom">
      <ul class="article-meta">
        <li class="article-meta-date"><time>November 23, 2018</time></li>
      </ul>
      
<aside class="toc">
  <nav id="TableOfContents">
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#对象的生命周期管理包含哪两个方面的内容">对象的生命周期管理包含哪两个方面的内容 ？</a></li>
<li><a href="#我们为什么要在面向对象语言中引入容器">我们为什么要在面向对象语言中引入容器？</a></li>
<li><a href="#什么是依赖注入">什么是依赖注入 ？</a></li>
<li><a href="#一个全局的容器设计-应遵循怎样一些原则">一个全局的容器设计 ，应遵循怎样一些原则 ？</a></li>
<li><a href="#xwork中容器所管理的是那些对象">XWork中容器所管理的是那些对象？</a></li>
<li><a href="#获取xwork容器所管理的对象实例-有哪两种方法">获取XWork容器所管理的对象实例 ，有哪两种方法 ？</a></li>
<li><a href="#xwork容器的内部到底存储了哪些内容">XWork容器的内部到底存储了哪些内容 ？</a></li>
<li><a href="#inject这个注解在xwork框架中起着什么样的作用">@Inject这个注解在Xwork框架中起着什么样的作用？</a></li>
<li><a href="#objectfactory-有哪两大重要的意义">ObjectFactory 有哪两大重要的意义？</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
</aside>
      

<blockquote>
<p>&ldquo;容器&rdquo;是用来解决：“在程序的运行期，应该如何创建我们需要的对象？” 和 &ldquo;当创建新对象，该对象依赖的对象也能正确被创建出来？&rdquo;</p>
</blockquote>

<h3 id="对象的生命周期管理包含哪两个方面的内容">对象的生命周期管理包含哪两个方面的内容 ？</h3>

<ol>
<li>在程序运行期，对象实例的创建和引用机制.</li>
<li>对象与其关联的对象的依赖关系的处理机制.</li>
</ol>

<h3 id="我们为什么要在面向对象语言中引入容器">我们为什么要在面向对象语言中引入容器？</h3>

<ol>
<li>对象频繁创建,效率大大降低.</li>
<li>对象创建逻辑与业务逻辑高度耦合.</li>
<li>程序执行效率大大降低,由于无法区分明确职责，很难针对对象实现业务逻辑进行单元测试.</li>
</ol>

<h3 id="什么是依赖注入">什么是依赖注入 ？</h3>

<blockquote>
<p>当某个角色(可能是一个Java实例，调用者)需要另一个角色(另一个Java实例，被调用者)的协助时，在 传统的程序设计过程中，通常由调用者来创建被调用者的实例,这样存在诸多问题(高耦合、职责不清晰、效率下降).
从而诞生依赖注入，依赖注入是指，通过容器来创建被调用者实例，然后注入给调用者.</p>
</blockquote>

<h3 id="一个全局的容器设计-应遵循怎样一些原则">一个全局的容器设计 ，应遵循怎样一些原则 ？</h3>

<ol>
<li>容器应该被设计成一个全局的、统一的编程元素.</li>
<li>容器应该提供简单而全面的对象操作接口.</li>
</ol>

<h3 id="xwork中容器所管理的是那些对象">XWork中容器所管理的是那些对象？</h3>

<blockquote>
<p>所有框架中配置定义中的“容器配置元素” （struts-default.xml文件中: bean、constant、Properties节点声明的对象）</p>
</blockquote>

<h3 id="获取xwork容器所管理的对象实例-有哪两种方法">获取XWork容器所管理的对象实例 ，有哪两种方法 ？</h3>

<ol>
<li>通过getInstance</li>
<li>通过getInstanceNames</li>
</ol>

<h3 id="xwork容器的内部到底存储了哪些内容">XWork容器的内部到底存储了哪些内容 ？</h3>

<blockquote>
<p>存储了bean节点type生命的对象.</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nc">ContainerImpl</span> <span class="kd">implements</span> <span class="n">Container</span> <span class="o">{</span>

  <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Key</span><span class="o">&lt;?&gt;,</span> <span class="n">InternalFactory</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">factories</span><span class="o">;</span>
  <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;,</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">factoryNamesByType</span><span class="o">;</span>

  <span class="n">ContainerImpl</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">Key</span><span class="o">&lt;?&gt;,</span> <span class="n">InternalFactory</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">factories</span><span class="o">)</span> <span class="o">{</span>


    <span class="c1">// 获取的是Struts-default.xml中的bean节点数据
</span><span class="c1"></span>    <span class="k">this</span><span class="o">.</span><span class="na">factories</span> <span class="o">=</span> <span class="n">factories</span><span class="o">;</span>

    <span class="n">Map</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;,</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;,</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;();</span>

    <span class="k">for</span> <span class="o">(</span><span class="n">Key</span><span class="o">&lt;?&gt;</span> <span class="n">key</span> <span class="o">:</span> <span class="n">factories</span><span class="o">.</span><span class="na">keySet</span><span class="o">())</span> <span class="o">{</span>

      <span class="c1">// 获取bean节点里type配置的class
</span><span class="c1"></span>      <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">names</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">getType</span><span class="o">());</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">names</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">names</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>

        <span class="c1">// 将bean标签中type映射的class存放到map中
</span><span class="c1"></span>        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">getType</span><span class="o">(),</span> <span class="n">names</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="c1">// 将bean标签中name字段存在到names中
</span><span class="c1"></span>      <span class="n">names</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
    <span class="o">}</span>



    <span class="k">for</span> <span class="o">(</span><span class="n">Entry</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;,</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">map</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">entry</span><span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="n">Collections</span><span class="o">.</span><span class="na">unmodifiableSet</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">()));</span>
    <span class="o">}</span>


    <span class="c1">// Collections.unmodifiableMap方法返回一个不可修改的Map。
</span><span class="c1"></span>    <span class="k">this</span><span class="o">.</span><span class="na">factoryNamesByType</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">unmodifiableMap</span><span class="o">(</span><span class="n">map</span><span class="o">);</span>
  <span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="inject这个注解在xwork框架中起着什么样的作用">@Inject这个注解在Xwork框架中起着什么样的作用？</h3>

<blockquote>
<p>凡是加了@Inject这个注解的属性或方法，都会被初始化到相应的注入器，并且调用Container的inject方法时实施依赖注入。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ActionSupport</span> <span class="kd">implements</span> <span class="n">Action</span><span class="o">,</span> <span class="n">Validateable</span><span class="o">,</span> <span class="n">ValidationAware</span><span class="o">,</span> <span class="n">TextProvider</span><span class="o">,</span> <span class="n">LocaleProvider</span><span class="o">,</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="c1">// ... 省略n行代码
</span><span class="c1"></span>
    <span class="nd">@Inject</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setContainer</span><span class="o">(</span><span class="n">Container</span> <span class="n">container</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">container</span> <span class="o">=</span> <span class="n">container</span><span class="o">;</span>
    <span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>@Inject具体实现</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nc">ContainerImpl</span> <span class="kd">implements</span> <span class="n">Container</span> <span class="o">{</span>
      
  <span class="c1">// ... 省略n行代码
</span><span class="c1"></span>
  <span class="cm">/**
</span><span class="cm">   * Field and method injectors.
</span><span class="cm">   */</span>
  <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Injector</span><span class="o">&gt;&gt;</span> <span class="n">injectors</span> <span class="o">=</span>
      <span class="k">new</span> <span class="n">ReferenceCache</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Injector</span><span class="o">&gt;&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Injector</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">List</span><span class="o">&lt;</span><span class="n">Injector</span><span class="o">&gt;</span> <span class="n">injectors</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Injector</span><span class="o">&gt;();</span>

          <span class="c1">// 拿class当做key,查询所有带有@Inject注解的class,添加到injectors
</span><span class="c1"></span>          <span class="n">addInjectors</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">injectors</span><span class="o">);</span>
          <span class="k">return</span> <span class="n">injectors</span><span class="o">;</span>
        <span class="o">}</span>
      <span class="o">};</span>

  <span class="c1">// ... 省略n行代码
</span><span class="c1"></span>  <span class="cm">/**
</span><span class="cm">   * Recursively adds injectors for fields and methods from the given class to
</span><span class="cm">   * the given list. Injects parent classes before sub classes.
</span><span class="cm">   */</span>
  <span class="kt">void</span> <span class="nf">addInjectors</span><span class="o">(</span><span class="n">Class</span> <span class="n">clazz</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Injector</span><span class="o">&gt;</span> <span class="n">injectors</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">clazz</span> <span class="o">==</span> <span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// Add injectors for superclass first.
</span><span class="c1"></span>    <span class="n">addInjectors</span><span class="o">(</span><span class="n">clazz</span><span class="o">.</span><span class="na">getSuperclass</span><span class="o">(),</span> <span class="n">injectors</span><span class="o">);</span>

    <span class="c1">// TODO (crazybob): Filter out overridden members.
</span><span class="c1"></span>    <span class="n">addInjectorsForFields</span><span class="o">(</span><span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredFields</span><span class="o">(),</span> <span class="kc">false</span><span class="o">,</span> <span class="n">injectors</span><span class="o">);</span>
    <span class="n">addInjectorsForMethods</span><span class="o">(</span><span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredMethods</span><span class="o">(),</span> <span class="kc">false</span><span class="o">,</span> <span class="n">injectors</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="c1">// ... 省略n行代码
</span><span class="c1"></span>
  <span class="kt">void</span> <span class="nf">addInjectorsForMethods</span><span class="o">(</span><span class="n">Method</span><span class="o">[]</span> <span class="n">methods</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">statics</span><span class="o">,</span>
      <span class="n">List</span><span class="o">&lt;</span><span class="n">Injector</span><span class="o">&gt;</span> <span class="n">injectors</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">addInjectorsForMembers</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">methods</span><span class="o">),</span> <span class="n">statics</span><span class="o">,</span> <span class="n">injectors</span><span class="o">,</span>
        <span class="k">new</span> <span class="n">InjectorFactory</span><span class="o">&lt;</span><span class="n">Method</span><span class="o">&gt;()</span> <span class="o">{</span>
          <span class="kd">public</span> <span class="n">Injector</span> <span class="nf">create</span><span class="o">(</span><span class="n">ContainerImpl</span> <span class="n">container</span><span class="o">,</span> <span class="n">Method</span> <span class="n">method</span><span class="o">,</span>
              <span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">MissingDependencyException</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">MethodInjector</span><span class="o">(</span><span class="n">container</span><span class="o">,</span> <span class="n">method</span><span class="o">,</span> <span class="n">name</span><span class="o">);</span>
          <span class="o">}</span>
        <span class="o">});</span>
  <span class="o">}</span>

  <span class="c1">// ... 省略n行代码
</span><span class="c1"></span>
  <span class="kt">void</span> <span class="nf">addInjectorsForFields</span><span class="o">(</span><span class="n">Field</span><span class="o">[]</span> <span class="n">fields</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">statics</span><span class="o">,</span>
      <span class="n">List</span><span class="o">&lt;</span><span class="n">Injector</span><span class="o">&gt;</span> <span class="n">injectors</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">addInjectorsForMembers</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">fields</span><span class="o">),</span> <span class="n">statics</span><span class="o">,</span> <span class="n">injectors</span><span class="o">,</span>
        <span class="k">new</span> <span class="n">InjectorFactory</span><span class="o">&lt;</span><span class="n">Field</span><span class="o">&gt;()</span> <span class="o">{</span>
          <span class="kd">public</span> <span class="n">Injector</span> <span class="nf">create</span><span class="o">(</span><span class="n">ContainerImpl</span> <span class="n">container</span><span class="o">,</span> <span class="n">Field</span> <span class="n">field</span><span class="o">,</span>
              <span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">MissingDependencyException</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">FieldInjector</span><span class="o">(</span><span class="n">container</span><span class="o">,</span> <span class="n">field</span><span class="o">,</span> <span class="n">name</span><span class="o">);</span>
          <span class="o">}</span>
        <span class="o">});</span>
  <span class="o">}</span>

  <span class="c1">// ... 省略n行代码
</span><span class="c1"></span>
  <span class="c1">// 核心代码
</span><span class="c1"></span>  <span class="o">&lt;</span><span class="n">M</span> <span class="kd">extends</span> <span class="n">Member</span> <span class="o">&amp;</span> <span class="n">AnnotatedElement</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="nf">addInjectorsForMembers</span><span class="o">(</span>
      <span class="n">List</span><span class="o">&lt;</span><span class="n">M</span><span class="o">&gt;</span> <span class="n">members</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">statics</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Injector</span><span class="o">&gt;</span> <span class="n">injectors</span><span class="o">,</span>
      <span class="n">InjectorFactory</span><span class="o">&lt;</span><span class="n">M</span><span class="o">&gt;</span> <span class="n">injectorFactory</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">M</span> <span class="n">member</span> <span class="o">:</span> <span class="n">members</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">isStatic</span><span class="o">(</span><span class="n">member</span><span class="o">)</span> <span class="o">==</span> <span class="n">statics</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Inject</span> <span class="n">inject</span> <span class="o">=</span> <span class="n">member</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="n">Inject</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">inject</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">try</span> <span class="o">{</span>
            <span class="n">injectors</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">injectorFactory</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">member</span><span class="o">,</span> <span class="n">inject</span><span class="o">.</span><span class="na">value</span><span class="o">()));</span>
          <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">MissingDependencyException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">inject</span><span class="o">.</span><span class="na">required</span><span class="o">())</span> <span class="o">{</span>
              <span class="k">throw</span> <span class="k">new</span> <span class="n">DependencyException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>


  <span class="c1">// ... 省略n行代码
</span><span class="c1"></span>
   <span class="c1">// 调用Container的inject方法时实施依赖注入
</span><span class="c1"></span>    <span class="kt">void</span> <span class="nf">inject</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">,</span> <span class="n">InternalContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Injector</span><span class="o">&gt;</span> <span class="n">injectors</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">injectors</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">Injector</span> <span class="n">injector</span> <span class="o">:</span> <span class="n">injectors</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">injector</span><span class="o">.</span><span class="na">inject</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">o</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="c1">// ... 省略n行代码
</span><span class="c1"></span>

  <span class="c1">// 对添加@Inject注解的方法，实施依赖注入
</span><span class="c1"></span>  <span class="kd">static</span> <span class="kd">class</span> <span class="nc">MethodInjector</span> <span class="kd">implements</span> <span class="n">Injector</span> <span class="o">{</span>

    <span class="kd">final</span> <span class="n">Method</span> <span class="n">method</span><span class="o">;</span>
    <span class="kd">final</span> <span class="n">ParameterInjector</span><span class="o">&lt;?&gt;[]</span> <span class="n">parameterInjectors</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">MethodInjector</span><span class="o">(</span><span class="n">ContainerImpl</span> <span class="n">container</span><span class="o">,</span> <span class="n">Method</span> <span class="n">method</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">MissingDependencyException</span> <span class="o">{</span>
      
      <span class="c1">// 注入的方法名
</span><span class="c1"></span>      <span class="k">this</span><span class="o">.</span><span class="na">method</span> <span class="o">=</span> <span class="n">method</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">method</span><span class="o">.</span><span class="na">isAccessible</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">SecurityManager</span> <span class="n">sm</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getSecurityManager</span><span class="o">();</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">sm</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">sm</span><span class="o">.</span><span class="na">checkPermission</span><span class="o">(</span><span class="k">new</span> <span class="n">ReflectPermission</span><span class="o">(</span><span class="s">&#34;suppressAccessChecks&#34;</span><span class="o">));</span>
                <span class="n">method</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">AccessControlException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">DependencyException</span><span class="o">(</span><span class="s">&#34;Security manager in use, could not access method: &#34;</span>
                        <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&#34;(&#34;</span> <span class="o">+</span> <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;)&#34;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

      <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">parameterTypes</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getParameterTypes</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">parameterTypes</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">DependencyException</span><span class="o">(</span>
            <span class="n">method</span> <span class="o">+</span> <span class="s">&#34; has no parameters to inject.&#34;</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">parameterInjectors</span> <span class="o">=</span> <span class="n">container</span><span class="o">.</span><span class="na">getParametersInjectors</span><span class="o">(</span>
          <span class="n">method</span><span class="o">,</span> <span class="n">method</span><span class="o">.</span><span class="na">getParameterAnnotations</span><span class="o">(),</span> <span class="n">parameterTypes</span><span class="o">,</span> <span class="n">name</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">inject</span><span class="o">(</span><span class="n">InternalContext</span> <span class="n">context</span><span class="o">,</span> <span class="n">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>

        <span class="c1">// 给加@Inject注解的方法传参, 如我们的ActionSupport类setContainer方法
</span><span class="c1"></span>        <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">o</span><span class="o">,</span> <span class="n">getParameters</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">context</span><span class="o">,</span> <span class="n">parameterInjectors</span><span class="o">));</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="objectfactory-有哪两大重要的意义">ObjectFactory 有哪两大重要的意义？</h3>

<blockquote>
<p>tip: ObjectFactory 是一个工具类</p>
</blockquote>

<ol>
<li>ObjectFactory 允许在程序运行期间动态构建一个新的对象，并且为这个新建的对象实施依赖注入.</li>
<li>ObjectFactory 主要构建系统对象Action、Interceptor、Result、Validator和普通的Bean对象, 用ObjectFactory类进行构建对象均受到XWork容器的管理.</li>
</ol>

    </article>

    
<ul class="article-share">
  <li>
    <a href="https://twitter.com/share" class="twitter-share-button">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
  </li>
  <li>
    <div class="fb-share-button" data-href="https://dean2021.github.io/posts/struts2-internals-readbook-note_02/" data-layout="button_count" data-action="like" data-size="small" data-show-faces="true" data-share="true"></div>
    <div id="fb-root"></div>
    <script>(function(d, s, id) {
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) return;
      js = d.createElement(s); js.id = id;
      js.src = "//connect.facebook.net/ja_JP/sdk.js#xfbml=1&version=v2.10";
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));</script>
  </li>
  <li>
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <g:plus action="share"></g:plus>
  </li>
  <li>
    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="basic-label-counter" data-hatena-bookmark-lang="en" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
  <li>
    <a data-pocket-label="pocket" data-pocket-count="horizontal" class="pocket-btn" data-lang="en"></a>
    <script>!function(d,i){if(!d.getElementById(i)){var j=d.createElement("script");j.id=i;j.src="https://widgets.getpocket.com/v1/j/btn.js?v=1";var w=d.getElementById(i);d.body.appendChild(j);}}(document,"pocket-btn-js");</script>
  </li>
</ul>


    <ul class="pager article-pager">
      <li class="pager-newer pager-noitem">&lt; Newer</li>
      <li class="pager-older">
        <a href="/posts/struts2-internals-readbook-note/" data-toggle="tooltip" data-placement="top" title="《Struts2 技术内幕》读书笔记: Struts2 概况">Older &gt;</a>
      </li>
    </ul>
  </div>


<div class="site-footer">
  <div class="copyright">&copy; Copyright 2018 Dean</div>
  <ul class="site-footer-items">
    <li class="site-footer-item-about"><a href="/about/" title="About">About</a></li>
  </ul>
  <div class="powerdby">
    Powered by <a href="https://gohugo.io/">Hugo</a> and <a href="https://github.com/taikii/whiteplain">Whiteplain</a>
  </div>
</div>


</body>
</html>
